{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Registro de Movimientos {% endblock title %}

{% block extrastyle %}
<link href="{% static 'assets/css/registro.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/alerts-enhanced.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/add-button.css' %}" rel="stylesheet" />
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="page-title">
                            <i class="tim-icons icon-wallet-43 mr-3"></i>
                            Registro de Movimientos
                        </h2>
                        <p class="page-subtitle">Gestiona los movimientos financieros de tu organización de forma eficiente</p>
                    </div>
                    <div class="col-md-4">
                        <div class="totals-section">
                            <div class="total-item">
                                <span class="total-label">Ingresos</span>
                                <div class="total-value ingresos" id="totalIngresosHeader">--</div>
                            </div>
                            <div class="total-item">
                                <span class="total-label">Gastos</span>
                                <div class="total-value gastos" id="totalGastosHeader">--</div>
                            </div>
                            <div class="total-item">
                                <span class="total-label">Saldo</span>
                                <div class="total-value saldo" id="saldoActual">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>                       
        </div>
    </div>

        <!-- Buscador de movimientos -->
    <div class="row mb-3" id="searchSection" style="display: none;">
        <div class="col-md-12">
            <div class="movements-search-bar">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text search-icon">
                                <i class="tim-icons icon-zoom-split"></i>
                        </span>
                    </div>
                    <input type="text" 
                        class="form-control search-input" 
                        id="movementsSearch" 
                        placeholder="Buscar por concepto, importe, justificante o descripción..."
                        autocomplete="off">
                    <div class="append-clear-button">
                        <button class="btn btn-clear" type="button" id="clearSearch" style="display: none;">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                    </div>
                    <div class="search-results-info" id="searchResultsInfo">
                    <i class="tim-icons icon-check-2 text-success"></i>
                    <span class="results-count" id="resultsCount">0</span> 
                    <span id="resultsText">resultados encontrados</span>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">

                    <!-- Botón para añadir movimiento y controles de ordenamiento -->
                    <div class="row mb-3" id="addMovementSection" style="display: none;">
                        <div class="col-md-6">
                            <button type="button" class="button" data-toggle="modal" data-target="#addMovementModal" onclick="prepareModal()">
                            <span class="button__icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" height="24" fill="none" class="svg">
                                <line y2="19" y1="5" x2="12" x1="12"></line>
                                <line y2="12" y1="12" x2="19" x1="5"></line>
                                </svg>
                            </span>
                            <span class="button__text-wrapper">
                                <span class="button__text">Añadir Movimiento</span>
                            </span>
                            </button>                            
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center" id="sortControls" style="display: none !important;">
                            <label class="form-label mb-0 mr-3">Ordenar por:</label>
                            <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center" onclick="sortMovimientos('fecha')" id="sortByDate">
                                <i class="tim-icons icon-calendar-60 mr-1"></i>
                                <span>Fecha</span>
                                <span id="sortDateIcon" class="ml-2 d-inline"></span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center" onclick="sortMovimientos('importe')" id="sortByAmount">
                                <i class="tim-icons icon-coins mr-1"></i>
                                <span>importe</span>
                                <span id="sortAmountIcon" class="ml-2 d-inline"></span>
                            </button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Filtros de tipo">
                                <button type="button" class="btn btn-outline-info btn-sm d-inline-flex align-items-center" id="filterTipo" data-filter="todos">
                                    <i class="tim-icons icon-atom mr-1"></i>
                                    <span id="filterTipoText">Todos</span>
                                </button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Filtros de ingreso/gasto">
                                <button type="button" class="btn btn-outline-success btn-sm d-inline-flex align-items-center" id="filterIngresosGastos" data-filter="todos">
                                    <i class="tim-icons icon-chart-pie-36 mr-1"></i>
                                    <span id="filterIngresosGastosText">Todos</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <div id="movimientosContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Turno</th>
                                        <th>Tipo</th>
                                        <th>Concepto</th>
                                        <th>Descripción</th>
                                        <th>Importe</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay ejercicio seleccionado -->
                    <div id="noEjercicioMessage" class="text-center py-5">
                        <i class="tim-icons icon-wallet-43" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Selecciona un ejercicio para ver todos sus movimientos</h4>
                        <p class="text-muted">Elige un ejercicio del selector superior para visualizar todos los movimientos de caja y banco asociados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para añadir movimiento -->
<div class="modal fade" id="addMovementModal" tabindex="-1" aria-labelledby="addMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovementModalLabel">
                    <i class="tim-icons icon-simple-add"></i>
                    Añadir Nuevo Movimiento
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addMovementForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="caja" id="cajaIdInput">
                    <input type="hidden" name="ejercicio" id="ejercicioIdInput">
                    <input type="hidden" name="campamento" id="campamentoIdInput">
                    
                    <!-- Tipo de Operación -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="canal_movimiento" class="form-label">
                                    <i class="tim-icons icon-money-coins mr-2"></i>
                                    Canal de Movimiento
                                </label>
                                <select class="form-control" name="canal_movimiento" id="canal_movimiento" required>
                                    <option value="">-- Selecciona el canal de movimiento --</option>
                                    <option value="caja">
                                        <i class="tim-icons icon-coins"></i>
                                        Movimiento de Caja
                                    </option>
                                    <option value="banco">
                                        <i class="tim-icons icon-credit-card"></i>
                                        Movimiento de Banco
                                    </option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="tim-icons icon-bulb-63"></i>
                                    Efectivo: movimientos con billetes y monedas físicas. banco: operaciones bancarias.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Caja - Solo se muestra para movimientos de efectivo -->
                    <div class="row mb-3" id="cajaSelectionRow" style="display: none;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="cajaSelect" class="form-label">
                                    <i class="tim-icons icon-coins mr-2"></i>
                                    Seleccionar Caja
                                </label>
                                <select class="form-control" name="caja" id="cajaSelect" required>
                                    <option value="">-- Selecciona una caja --</option>
                                    {% for caja in cajas %}
                                        <option value="{{ caja.id }}"
                                                data-saldo="{{ caja.saldo_caja }}"
                                                {% if not caja.activa %}disabled style="background-color: #eee; color: #888;"{% endif %}>
                                            {{ caja.nombre }} - {{ caja.saldo_caja }}€
                                            {% if not caja.activa %} [INACTIVA]{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="tim-icons icon-bulb-63"></i>
                                    Selecciona la caja específica para este movimiento de efectivo.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-control" name="turno" id="turno" required>
                                    <option value="">-- Selecciona un turno --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="concepto" class="form-label">Concepto</label>
                                <select class="form-control" name="concepto" id="concepto" required>
                                    <option value="">-- Selecciona un concepto --</option>
                                    {% for concepto in conceptos %}
                                        <option value="{{ concepto.id }}" data-es-gasto="{{ concepto.es_gasto }}">
                                            {{ concepto.nombre }} {% if concepto.es_gasto %}(Gasto){% else %}(Ingreso){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="importe" class="form-label">importe (€)</label>
                                <input type="number" class="form-control" name="importe" id="importe" 
                                       step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fecha" class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="fecha" id="fecha" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hora" class="form-label">Hora</label>
                                <input type="time" class="form-control" name="hora" id="hora" 
                                       value="{% now 'H:i' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" id="descripcion" 
                                  rows="3" placeholder="Descripción detallada del movimiento" required></textarea>
                    </div>
                    
                    <!-- Campos específicos para movimientos de CAJA (efectivo) -->
                    <div class="campos-efectivo" id="camposEfectivo" style="display: none;">
                        <!-- Campos de justificante condicionales - Solo para gastos -->
                        <div class="justificante-fields" id="justificanteFields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="justificante" class="form-label">Nº Justificante</label>
                                        <input type="text" class="form-control" name="justificante" id="justificante" 
                                               maxlength="5" placeholder="12345">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-paper"></i>
                                            Número de justificante para el gasto
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="archivo" class="form-label">Archivo Justificante de Factura</label>
                                        <input type="file" class="form-control" name="archivo" id="archivo_justificante" 
                                               accept=".pdf,.jpg,.jpeg,.png,.bmp">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-cloud-upload-94"></i>
                                            PDF, JPG, PNG, BMP (máx. 10MB)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <!-- Sección de desglose de billetes y monedas -->
                    <div class="desglose-dinero-section" id="desgloseDineroSection" style="display: none;">
                        <h6 class="section-title">
                            <i class="tim-icons icon-coins mr-2"></i>
                            Desglose de Billetes y Monedas
                            <small class="text-danger">(Obligatorio)</small>
                        </h6>
                        <p class="section-description">
                            <strong>Especifica la importe exacta de cada billete y moneda que entra y sale de la caja.</strong>
                            El total debe coincidir exactamente con la importe del movimiento.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="money-breakdown-container">
                                    <div class="row">
                                        <!-- Billetes -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-paper mr-1"></i>
                                                Billetes
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Monedas -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-coins mr-1"></i>
                                                Monedas
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if not denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Totales del desglose -->
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="desglose-totals">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="total-box total-entrada">
                                                            <div class="total-label">Total Entrada</div>
                                                            <div class="total-value" id="totalEntrada">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-salida">
                                                            <div class="total-label">Total Salida</div>
                                                            <div class="total-value" id="totalSalida">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-neto">
                                                            <div class="total-label">Total Neto</div>
                                                            <div class="total-value" id="totalNeto">0.00€</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="desglose-actions mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="calcularDesdeTotal">
                                                        <i class="tim-icons icon-refresh-01"></i>
                                                        Calcular desde total
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="limpiarDesglose">
                                                        <i class="tim-icons icon-simple-remove"></i>
                                                        Limpiar desglose
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div> <!-- End campos-efectivo -->
                    
                    <!-- Campos específicos para movimientos de BANCO (bancos) -->
                    <div class="campos-banco" id="camposBanco" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="cuenta_bancaria" class="form-label">Cuenta Bancaria</label>
                                    <select class="form-control" name="cuenta_bancaria" id="cuenta_bancaria" required>
                                        <option value="">-- Selecciona una cuenta --</option>
                                        {% for cuenta in cuentas_bancarias %}
                                            <option value="{{ cuenta.id }}">{{ cuenta.nombre }} - {{ cuenta.IBAN }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="via" class="form-label">Vía de Movimiento Bancario</label>
                                    <select class="form-control" name="via" id="via_movimiento_bancario" required>
                                        <option value="">-- Selecciona una vía --</option>
                                        {% for via in vias_movimiento %}
                                            <option value="{{ via.id }}">{{ via.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="referencia_bancaria" class="form-label">
                                        <i class="tim-icons icon-notes mr-2"></i>
                                        Referencia Bancaria
                                    </label>
                                    <input type="text" class="form-control" name="referencia_bancaria" id="referencia_bancaria" 
                                           maxlength="50" placeholder="Referencia de la operación bancaria">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-bulb-63"></i>
                                        Número de referencia o identificador de la operación
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="justificante-fields-banco" id="justificanteFieldsBanco" style="display: none;">
                                    <div class="form-group">
                                        <label for="archivo" class="form-label">Archivo Justificante</label>
                                        <input type="file" class="form-control" name="archivo" id="archivo_justificante_banco" 
                                                accept=".pdf,.jpg,.jpeg,.png,.bmp">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-cloud-upload-94"></i>
                                            PDF, JPG, PNG, BMP (máx. 10MB)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End campos-banco -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="tim-icons icon-simple-remove"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="tim-icons icon-check-2"></i>
                        Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extrajs %}
<!-- JavaScript Files - Separated for better organization -->
<script src="{% static 'assets/js/alerts-system.js' %}"></script>
<script src="{% static 'assets/js/registro/money-breakdown.js' %}"></script>
<script src="{% static 'assets/js/registro/form-handlers.js' %}"></script>
<script src="{% static 'assets/js/registro/filters-and-search.js' %}"></script>
<script src="{% static 'assets/js/registro/data-loaders.js' %}"></script>
<script src="{% static 'assets/js/registro/display-helpers.js' %}"></script>
<script src="{% static 'assets/js/registro/main-registro.js' %}"></script>

<script>
    // Set the Django URL for AJAX requests
    window.registroUrl = '{% url "registro" %}';
    
    // Set current date and time values for the template
    window.currentDate = '{% now "Y-m-d" %}';
    window.currentTime = '{% now "H:i" %}';
</script>
{% endblock extrajs %}