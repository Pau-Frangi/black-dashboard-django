{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Registro de Movimientos {% endblock title %}

{% block extrastyle %}
<link href="{% static 'assets/css/registro.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/alerts-enhanced.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/add-button.css' %}" rel="stylesheet" />
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="page-title">
                            <i class="tim-icons icon-wallet-43 mr-3"></i>
                            Registro de Movimientos
                        </h2>
                        <p class="page-subtitle">Gestiona los movimientos financieros de tu organización de forma eficiente</p>
                    </div>
                    <div class="col-md-4">
                        <div class="totals-section">
                            <div class="total-item">
                                <span class="total-label">Ingresos</span>
                                <div class="total-value ingresos" id="totalIngresosHeader">--</div>
                            </div>
                            <div class="total-item">
                                <span class="total-label">Gastos</span>
                                <div class="total-value gastos" id="totalGastosHeader">--</div>
                            </div>
                            <div class="total-item">
                                <span class="total-label">Saldo</span>
                                <div class="total-value saldo" id="saldoActual">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>                       
        </div>
    </div>

        <!-- Buscador de movimientos -->
    <div class="row mb-3" id="searchSection" style="display: none;">
        <div class="col-md-12">
            <div class="movements-search-bar">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text search-icon">
                                <i class="tim-icons icon-zoom-split"></i>
                        </span>
                    </div>
                    <input type="text" 
                        class="form-control search-input" 
                        id="movementsSearch" 
                        placeholder="Buscar por concepto, cantidad, justificante o descripción..."
                        autocomplete="off">
                    <div class="append-clear-button">
                        <button class="btn btn-clear" type="button" id="clearSearch" style="display: none;">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                    </div>
                    <div class="search-results-info" id="searchResultsInfo">
                    <i class="tim-icons icon-check-2 text-success"></i>
                    <span class="results-count" id="resultsCount">0</span> 
                    <span id="resultsText">resultados encontrados</span>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">

                    <!-- Botón para añadir movimiento y controles de ordenamiento -->
                    <div class="row mb-3" id="addMovementSection" style="display: none;">
                        <div class="col-md-6">
<button type="button" class="button" data-toggle="modal" data-target="#addMovementModal" onclick="prepareModal()">
  <span class="button__icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" height="24" fill="none" class="svg">
      <line y2="19" y1="5" x2="12" x1="12"></line>
      <line y2="12" y1="12" x2="19" x1="5"></line>
    </svg>
  </span>
  <span class="button__text-wrapper">
    <span class="button__text">Añadir Movimiento</span>
  </span>
</button>

                            
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center" id="sortControls" style="display: none !important;">
                            <label class="form-label mb-0 mr-3">Ordenar por:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('fecha')" id="sortByDate">
                                    <i class="tim-icons icon-calendar-60"></i>
                                    Fecha
                                    <span id="sortDateIcon" class="ml-1"></span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('cantidad')" id="sortByAmount">
                                    <i class="tim-icons icon-coins"></i>
                                    Cantidad
                                    <span id="sortAmountIcon" class="ml-1"></span>
                                </button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Filtros de tipo">
                                <button type="button" class="btn btn-outline-info btn-sm" id="filterTipo" data-filter="todos">
                                    <i class="tim-icons icon-atom"></i>
                                    <span id="filterTipoText">Todos</span>
                                </button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Filtros de ingreso/gasto">
                                <button type="button" class="btn btn-outline-success btn-sm" id="filterIngresosGastos" data-filter="todos">
                                    <i class="tim-icons icon-chart-pie-36"></i>
                                    <span id="filterIngresosGastosText">Todos</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <div id="movimientosContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Turno</th>
                                        <th>Tipo</th>
                                        <th>Concepto</th>
                                        <th>Descripción</th>
                                        <th>Cantidad</th>
                                        <th>Justificante</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay ejercicio seleccionado -->
                    <div id="noCajaMessage" class="text-center py-5">
                        <i class="tim-icons icon-wallet-43" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Selecciona un ejercicio para ver todos sus movimientos</h4>
                        <p class="text-muted">Elige un ejercicio del selector superior para visualizar todos los movimientos de caja y banco asociados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para añadir movimiento -->
<div class="modal fade" id="addMovementModal" tabindex="-1" aria-labelledby="addMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovementModalLabel">
                    <i class="tim-icons icon-simple-add"></i>
                    Añadir Nuevo Movimiento
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addMovementForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="caja_id" id="cajaIdInput">
                    <input type="hidden" name="ejercicio_id" id="ejercicioIdInput">
                    
                    <!-- Tipo de Operación -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="tipo_operacion" class="form-label">
                                    <i class="tim-icons icon-money-coins mr-2"></i>
                                    Tipo de Operación
                                </label>
                                <select class="form-control" name="tipo_operacion" id="tipo_operacion" required>
                                    <option value="">-- Selecciona el tipo de operación --</option>
                                    <option value="efectivo">
                                        <i class="tim-icons icon-coins"></i>
                                        Efectivo (Caja)
                                    </option>
                                    <option value="transferencia">
                                        <i class="tim-icons icon-credit-card"></i>
                                        Transferencia/Banco
                                    </option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="tim-icons icon-bulb-63"></i>
                                    Efectivo: movimientos con billetes y monedas físicas. Transferencia: operaciones bancarias.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selector de Caja - Solo se muestra para movimientos de efectivo -->
                    <div class="row mb-3" id="cajaSelectionRow" style="display: none;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="cajaSelect" class="form-label">
                                    <i class="tim-icons icon-coins mr-2"></i>
                                    Seleccionar Caja
                                </label>
                                <select class="form-control" name="caja_id_select" id="cajaSelect" required>
                                    <option value="">-- Selecciona una caja --</option>
                                    {% for caja in cajas %}
                                        <option value="{{ caja.id }}"
                                                data-saldo="{{ caja.saldo_caja }}"
                                                {% if not caja.activa %}disabled style="background-color: #eee; color: #888;"{% endif %}>
                                            {{ caja.nombre }} - {{ caja.saldo_caja }}€
                                            {% if not caja.activa %} [INACTIVA]{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="tim-icons icon-bulb-63"></i>
                                    Selecciona la caja específica para este movimiento de efectivo.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-control" name="turno" id="turno" required>
                                    <option value="">-- Selecciona un turno --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="concepto" class="form-label">Concepto</label>
                                <select class="form-control" name="concepto" id="concepto" required>
                                    <option value="">-- Selecciona un concepto --</option>
                                    {% for concepto in conceptos %}
                                        <option value="{{ concepto.id }}" data-es-gasto="{{ concepto.es_gasto }}">
                                            {{ concepto.nombre }} {% if concepto.es_gasto %}(Gasto){% else %}(Ingreso){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cantidad" class="form-label">Cantidad (€)</label>
                                <input type="number" class="form-control" name="cantidad" id="cantidad" 
                                       step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fecha" class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="fecha" id="fecha" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hora" class="form-label">Hora</label>
                                <input type="time" class="form-control" name="hora" id="hora" 
                                       value="{% now 'H:i' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" id="descripcion" 
                                  rows="3" placeholder="Descripción detallada del movimiento" required></textarea>
                    </div>
                    
                    <!-- Campos específicos para movimientos de CAJA (efectivo) -->
                    <div class="campos-efectivo" id="camposEfectivo" style="display: none;">
                        <!-- Campos de justificante condicionales - Solo para gastos -->
                        <div class="justificante-fields" id="justificanteFields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="justificante" class="form-label">Nº Justificante</label>
                                        <input type="text" class="form-control" name="justificante" id="justificante" 
                                               maxlength="5" placeholder="12345">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-paper"></i>
                                            Número de justificante para el gasto
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="archivo_justificante" class="form-label">Archivo Justificante de Factura</label>
                                        <input type="file" class="form-control" name="archivo_justificante" id="archivo_justificante" 
                                               accept=".pdf,.jpg,.jpeg,.png,.bmp">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-cloud-upload-94"></i>
                                            PDF, JPG, PNG, BMP (máx. 10MB)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <!-- Sección de desglose de billetes y monedas -->
                    <div class="desglose-dinero-section" id="desgloseDineroSection" style="display: none;">
                        <h6 class="section-title">
                            <i class="tim-icons icon-coins mr-2"></i>
                            Desglose de Billetes y Monedas
                            <small class="text-danger">(Obligatorio)</small>
                        </h6>
                        <p class="section-description">
                            <strong>Especifica la cantidad exacta de cada billete y moneda que entra y sale de la caja.</strong>
                            El total debe coincidir exactamente con la cantidad del movimiento.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="money-breakdown-container">
                                    <div class="row">
                                        <!-- Billetes -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-paper mr-1"></i>
                                                Billetes
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Monedas -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-coins mr-1"></i>
                                                Monedas
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if not denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Totales del desglose -->
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="desglose-totals">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="total-box total-entrada">
                                                            <div class="total-label">Total Entrada</div>
                                                            <div class="total-value" id="totalEntrada">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-salida">
                                                            <div class="total-label">Total Salida</div>
                                                            <div class="total-value" id="totalSalida">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-neto">
                                                            <div class="total-label">Total Neto</div>
                                                            <div class="total-value" id="totalNeto">0.00€</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="desglose-actions mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="calcularDesdeTotal">
                                                        <i class="tim-icons icon-refresh-01"></i>
                                                        Calcular desde total
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="limpiarDesglose">
                                                        <i class="tim-icons icon-simple-remove"></i>
                                                        Limpiar desglose
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div> <!-- End campos-efectivo -->
                    
                    <!-- Campos específicos para movimientos de BANCO (transferencias) -->
                    <div class="campos-banco" id="camposBanco" style="display: none;">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="referencia_bancaria" class="form-label">
                                        <i class="tim-icons icon-notes mr-2"></i>
                                        Referencia Bancaria
                                    </label>
                                    <input type="text" class="form-control" name="referencia_bancaria" id="referencia_bancaria" 
                                           maxlength="50" placeholder="Referencia de la operación bancaria">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-bulb-63"></i>
                                        Número de referencia o identificador de la operación
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campos de justificante para movimientos bancarios - Para gastos e ingresos -->
                        <div class="justificante-fields-banco" id="justificanteFieldsBanco" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="archivo_justificante_banco" class="form-label">Archivo Justificante</label>
                                        <input type="file" class="form-control" name="archivo_justificante_banco" id="archivo_justificante_banco" 
                                               accept=".pdf,.jpg,.jpeg,.png,.bmp">
                                        <small class="form-text text-muted">
                                            <i class="tim-icons icon-cloud-upload-94"></i>
                                            PDF, JPG, PNG, BMP (máx. 10MB)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End campos-banco -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="tim-icons icon-simple-remove"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="tim-icons icon-check-2"></i>
                        Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extrajs %}
<script>
    // Variables globales para el ordenamiento
    let currentMovimientos = [];
    let filteredMovimientos = [];
    let currentSortField = 'fecha';
    let currentSortOrder = 'desc'; // 'asc' o 'desc'

    $(document).ready(function () {
        console.log('Página de registro cargada');
        
        // Initialize page
        updateSaldoDisplay();
        
        // Initialize money breakdown
        initializeMoneyBreakdown();
        
        // Check if there's a default ejercicio selected and load its data
        const defaultEjercicioId = $('#ejercicioSelect').val();
        if (defaultEjercicioId) {
            console.log('Ejercicio preseleccionado detectado:', defaultEjercicioId);
            loadEjercicioData(); // This will call loadEjercicioMovimientos
        }

        // File upload handler
        $('#archivo_justificante').on('change', function() {
            handleFileUpload(this);
        });
        
        // File upload handler for bank justificante
        $('#archivo_justificante_banco').on('change', function() {
            handleFileUpload(this);
        });

        // Search functionality
        $('#movementsSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase().trim();
            
            if (searchTerm === '') {
                $('#clearSearch').hide();
            } else {
                $('#clearSearch').show();
            }
            
            applyFilters();
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#movementsSearch').val('');
            $(this).hide();
            applyFilters();
        });
        
        // Event listener para el campo cantidad para validar desglose
        $('#cantidad').on('input', function() {
            validateMoneyBreakdown();
        });
        
        // Event listeners para los filtros
        $('#filterTipo').on('click', function() {
            toggleTipoFilter();
        });
        
        $('#filterIngresosGastos').on('click', function() {
            toggleIngresosGastosFilter();
        });
    });

    // Variables globales para los filtros
    let currentTipoFilter = 'todos'; // 'todos', 'efectivo', 'banco'
    let currentIngresosGastosFilter = 'todos'; // 'todos', 'ingresos', 'gastos'

    // Function to handle file upload display
    function handleFileUpload(input) {
        const file = input.files[0];
        const $fileGroup = $(input).closest('.form-group');
        
        // Remove any existing file display
        $fileGroup.find('.file-display').remove();
        
        if (file) {
            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                showError('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.', {floating: true});
                $(input).val('');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Tipo de archivo no permitido. Solo se permiten archivos PDF, JPG, PNG y BMP.', {floating: true});
                $(input).val('');
                return;
            }
            
            // Create file display element
            const fileDisplay = $(`
                <div class="file-display mt-3">
                    <div class="d-flex align-items-center justify-content-between p-3" style="
                        background: linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%);
                        border: 2px solid rgba(81, 203, 206, 0.3);
                        border-radius: 12px;
                        transition: all 0.3s ease;
                    ">
                        <div class="d-flex align-items-center">
                            <i class="tim-icons icon-attach-87 mr-3" style="
                                color: #51cbce;
                                font-size: 1.2rem;
                            "></i>
                            <div>
                                <div class="file-name" style="
                                    color: #fff;
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                    margin-bottom: 2px;
                                ">${file.name}</div>
                                <div class="file-size" style="
                                    color: rgba(156, 163, 175, 0.8);
                                    font-size: 0.8rem;
                                ">${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-file" style="
                            border-radius: 8px;
                            padding: 6px 12px;
                            font-size: 0.8rem;
                            transition: all 0.3s ease;
                        ">
                            <i class="tim-icons icon-simple-remove"></i>
                            Cambiar
                        </button>
                    </div>
                </div>
            `);
            
            // Add hover effects
            fileDisplay.find('.d-flex').hover(
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.15) 0%, rgba(81, 203, 206, 0.08) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.5)'
                    });
                },
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.3)'
                    });
                }
            );
            
            // Add remove functionality
            fileDisplay.find('.remove-file').on('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                $(input).val('');
                fileDisplay.fadeOut(300, function() {
                    $(this).remove();
                });
            });
            
            // Insert after the input
            $fileGroup.find('small.form-text').after(fileDisplay);
            
            // Add entrance animation
            fileDisplay.hide().fadeIn(300);
        }
    }

    // Function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateSaldoDisplay() {
        const selectedOption = $('#cajaSelect option:selected');
        const saldo = selectedOption.data('saldo');
        
        console.log('Actualizando saldo display:', saldo, 'tipo:', typeof saldo);
        
        if (saldo !== undefined && saldo !== null && saldo !== '') {
            // Solo mostrar un placeholder mientras se cargan los movimientos
            // Los totales reales se actualizarán cuando se muestren los movimientos
            updateTotalsDisplay(0, 0, 0);
        } else {
            updateTotalsDisplay(0, 0, 0);
        }
    }

    function prepareModal() {
        console.log('Preparando modal');
        
        // Verificar que hay un ejercicio seleccionado
        const ejercicioId = $('#ejercicioSelect').val();
        if (!ejercicioId) {
            showWarning('Por favor selecciona un ejercicio antes de añadir un movimiento');
            return false;
        }
        
        // Clear editing mode for new movements
        editingMovimiento = null;
        
        // Update modal title for new movement
        $('#addMovementModalLabel').html(`
            <i class="tim-icons icon-simple-add"></i>
            Añadir Nuevo Movimiento
        `);
        
        // Establecer el ejercicio_id en el formulario
        $('#ejercicioIdInput').val(ejercicioId);
        console.log('Ejercicio ID establecido en modal:', ejercicioId);
        
        // Load turnos for the selected ejercicio
        loadTurnosForEjercicio(ejercicioId);
        
        // Resetear el formulario y estilos
        resetModalForm();
        
        return true;
    }

    function resetModalForm() {
        console.log('Reseteando formulario del modal');
        
        // Reset form fields
        $('#addMovementForm')[0].reset();
        
        // Reset date and time to current values (only for new movements)
        if (!editingMovimiento) {
            $('#fecha').val('{% now "Y-m-d" %}');
            $('#hora').val('{% now "H:i" %}');
        }
        
        // Re-enable fields that might have been disabled during editing
        $('#tipo_operacion').prop('disabled', false).removeClass('disabled-field');
        $('#concepto').prop('disabled', false).removeClass('disabled-field');
        
        // Reset concept field styles
        $('#concepto').removeClass('border-success border-warning');
        
        // Hide all conditional fields and sections
        $('#justificanteFields').hide();
        $('#justificanteFieldsBanco').hide();
        $('#camposEfectivo').hide();
        $('#camposBanco').hide();
        $('#cajaSelectionRow').hide();
        $('#desgloseDineroSection').hide();
        
        // Reset required attributes
        $('#cajaSelect').prop('required', false);
        
        // Clear all form values
        $('#justificante').val('');
        $('#archivo_justificante').val('');
        $('#justificante_banco').val('');
        $('#archivo_justificante_banco').val('');
        $('#referencia_bancaria').val('');
        $('#tipo_operacion_banco').val(''); // Reset to default
        
        // Remove file display if exists
        $('.file-display').remove();
        
        // Limpiar el desglose de dinero y validaciones
        clearMoneyBreakdown();
        
        // Reset validación de desglose
        $('#totalNeto').parent().removeClass('border border-warning border-success');
        
        // Limpiar mensajes temporales
        $('.temp-message').remove();
        $('.calculation-message').remove(); // Limpiar mensajes de cálculo
        
        // Resetear estilos de validación en inputs
        $('.money-input').removeClass('exceeds-available');
        
        console.log('Formulario reseteado completamente');
    }

    function displayMovimientos(movimientos) {
        console.log('=== displayMovimientos ===');
        console.log('Movimientos recibidos:', movimientos);
        
        const tbody = $('#movimientosTableBody');
        console.log('tbody encontrado:', tbody.length);
        
        if (tbody.length === 0) {
            console.error('ERROR: No se encontró el tbody con ID movimientosTableBody');
            return;
        }
        
        tbody.empty();

        if (!movimientos || movimientos.length === 0) {
            console.log('No hay movimientos, mostrando mensaje');
            tbody.append(`
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        No hay movimientos registrados para esta caja
                    </td>
                </tr>
            `);
            return;
        }

        console.log('Procesando', movimientos.length, 'movimientos...');
        
        movimientos.forEach(function(mov, index) {
            console.log(`Procesando movimiento ${index + 1}:`, mov);
            console.log('¿Tiene caja_nombre?', mov.caja); // Debug añadido

            const fechaDisplay = mov.fecha_display || new Date(mov.datetime_iso).toLocaleString('es-ES');
            const cantidadClass = mov.es_gasto ? 'text-danger' : 'text-success';
            const cantidadSign = mov.es_gasto ? '-' : '+';
            
            // Determinar el tipo de movimiento y su badge
            const tipoMovimiento = mov.tipo || 'caja';
            let tipoBadge;
            
            if (tipoMovimiento === 'banco') {
                tipoBadge = '<span class="badge badge-info"><i class="tim-icons icon-credit-card"></i> Banco</span>';
            } else {
                // Para movimientos de caja, solo badge de efectivo
                tipoBadge = '<span class="badge badge-secondary"><i class="tim-icons icon-coins"></i> Efectivo</span>';
                // El nombre de la caja se añadirá después
                if (mov.caja && mov.caja) {
                    tipoBadge += `<span class="d-block mt-1 text-muted" style="font-size: 0.8rem;">${mov.caja}</span>`;
                }
            }
            
            // Badge para ingreso/gasto
            const ingresoGastoBadge = mov.es_gasto ? 
                '<span class="badge badge-danger"><i class="tim-icons icon-simple-remove"></i> Gasto</span>' : 
                '<span class="badge badge-success"><i class="tim-icons icon-simple-add"></i> Ingreso</span>';
            
            const row = `
                <tr data-tipo="${tipoMovimiento}" data-es-gasto="${mov.es_gasto}">
                    <td>
                        <div class="d-flex flex-column">
                            <strong>${fechaDisplay}</strong>
                        </div>
                    </td>
                    <td>${mov.turno}</td>
                    <td>${tipoBadge}</td>
                    <td>
                        ${mov.concepto}
                        ${ingresoGastoBadge}
                    </td>
                    <td>${mov.descripcion || '-'}</td>
                    <td class="${cantidadClass}">
                        <strong>${cantidadSign}${mov.cantidad}€</strong>
                    </td>
                    <td>${mov.justificante || '-'}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editMovimiento(${mov.id}, '${tipoMovimiento}')" title="Editar movimiento">
                                <i class="tim-icons icon-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMovimiento(${mov.id}, '${tipoMovimiento}')" title="Eliminar movimiento">
                                <i class="tim-icons icon-simple-remove"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            tbody.append(row);
        });
        
        console.log('Terminé de añadir filas. Total filas ahora:', tbody.find('tr').length);
        console.log('HTML del tbody:', tbody.html());
        
        // Actualizar los totales basándose en los movimientos mostrados
        updateTotalsFromVisibleMovements();
        
        console.log('=== fin displayMovimientos ===');
    }

    function updateResumen(resumen) {
        console.log('Actualizando resumen:', resumen);
        
        // Proteger contra valores undefined/null
        const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
        const totalGastos = parseFloat(resumen.total_gastos) || 0;
        const saldoActual = parseFloat(resumen.saldo_actual) || 0;
        
        $('#totalIngresos').text(totalIngresos.toFixed(2) + '€');
        $('#totalGastos').text(totalGastos.toFixed(2) + '€');
        $('#saldoResumen').text(saldoActual.toFixed(2) + '€');
    }

    /**
     * Actualiza los totales basándose en los movimientos filtrados/visibles
     */
    function updateTotalsFromVisibleMovements() {
        if (!filteredMovimientos || filteredMovimientos.length === 0) {
            // Si no hay movimientos filtrados, mostrar ceros
            updateTotalsDisplay(0, 0, 0);
            return;
        }

        let totalIngresos = 0;
        let totalGastos = 0;

        // Calcular totales basándose en los movimientos filtrados
        filteredMovimientos.forEach(mov => {
            const cantidad = parseFloat(mov.cantidad) || 0;
            if (mov.es_gasto) {
                totalGastos += cantidad;
            } else {
                totalIngresos += cantidad;
            }
        });

        // Obtener el saldo de la caja seleccionada (saldo base)
        const selectedOption = $('#cajaSelect option:selected');
        const saldoBase = parseFloat(selectedOption.data('saldo')) || 0;
        
        // El saldo mostrado debe ser: saldo_base + ingresos_filtrados - gastos_filtrados
        // Pero esto no sería correcto porque el saldo base ya incluye todos los movimientos
        // Por eso vamos a calcular el saldo como: ingresos_filtrados - gastos_filtrados
        const saldoFiltrado = totalIngresos - totalGastos;

        console.log('Totales calculados desde movimientos filtrados:', {
            ingresos: totalIngresos,
            gastos: totalGastos,
            saldo: saldoFiltrado,
            movimientos: filteredMovimientos.length
        });

        updateTotalsDisplay(totalIngresos, totalGastos, saldoFiltrado);
    }

    /**
     * Actualiza la visualización de los totales en el header
     */
    function updateTotalsDisplay(ingresos, gastos, saldo) {
        $('#totalIngresosHeader').text(ingresos.toFixed(2) + '€');
        $('#totalGastosHeader').text(gastos.toFixed(2) + '€');
        $('#saldoActual').text(saldo.toFixed(2) + '€');

        // Actualizar colores del saldo según el valor
        const $saldoElement = $('#saldoActual');
        $saldoElement.removeClass('text-success text-danger text-warning');
        
        if (saldo > 0) {
            $saldoElement.addClass('text-success');
        } else if (saldo < 0) {
            $saldoElement.addClass('text-danger');
        } else {
            $saldoElement.addClass('text-warning');
        }

        // Indicar si los totales están filtrados
        const isFiltered = currentTipoFilter !== 'todos' || 
                          currentIngresosGastosFilter !== 'todos' || 
                          $('#movementsSearch').val().trim() !== '';
        
        const $totalsSection = $('.totals-section');
        if (isFiltered) {
            $totalsSection.attr('title', 'Totales calculados sobre movimientos filtrados');
            $totalsSection.addClass('filtered-totals');
        } else {
            $totalsSection.attr('title', 'Totales de todos los movimientos');
            $totalsSection.removeClass('filtered-totals');
        }
    }

    function deleteMovimiento(movimientoId, tipoMovimiento = 'caja') {
        if (!confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
            return;
        }

        console.log('Eliminando movimiento ID:', movimientoId, 'Tipo:', tipoMovimiento);

        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: {
                'action': 'delete',
                'movimiento_id': movimientoId,
                'tipo_movimiento': tipoMovimiento,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                console.log('Respuesta eliminar:', data);
                if (data.success) {
                    // Reload movements for the current ejercicio
                    const ejercicioId = $('#ejercicioSelect').val();
                    if (ejercicioId) {
                        loadEjercicioMovimientos(ejercicioId); // Reload the table
                    }
                    showSuccess('Movimiento eliminado correctamente', {floating: true});
                } else {
                    showError('Error: ' + data.error, {floating: true});
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al eliminar:', error);
                showError('Error al eliminar el movimiento: ' + error, {floating: true});
            }
        });
    }

    // Handle form submission
    $('#addMovementForm').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Enviando formulario de movimiento');
        
        // Verificar que se ha seleccionado un tipo de operación
        const tipoOperacion = $('#tipo_operacion').val();
        if (!tipoOperacion) {
            showWarning('Por favor selecciona el tipo de operación', {floating: true});
            return;
        }
        
        // Verificar que hay un ejercicio seleccionado
        const ejercicioId = $('#ejercicioSelect').val();
        if (!ejercicioId) {
            showWarning('Por favor selecciona un ejercicio', {floating: true});
            return;
        }
        
        // =============================================================================
        // VALIDACIÓN ESPECÍFICA SEGÚN EL TIPO DE OPERACIÓN
        // =============================================================================
        
        if (tipoOperacion === 'efectivo') {
            // Para movimientos de efectivo, verificar que hay una caja seleccionada
            const cajaId = $('#cajaSelect').val();
            if (!cajaId) {
                showWarning('Por favor selecciona una caja para movimientos de efectivo', {floating: true});
                return;
            }
            
            // Validar desglose para movimientos de efectivo (tanto nuevos como editados)
            const validationResult = validateCompleteMoneyBreakdown();
            if (!validationResult.valid) {
                showError(validationResult.error, {floating: true});
                return;
            }
            console.log('Desglose de efectivo validado correctamente');
            
            // Asegurar que el caja_id esté establecido en el formulario
            $('#cajaIdInput').val(cajaId);
            console.log('Caja ID:', cajaId);
            
        } else if (tipoOperacion === 'transferencia') {
            // Para transferencias, no necesitamos caja específica, solo ejercicio
            console.log('Datos bancarios validados correctamente');
        }
        
        console.log('Ejercicio ID:', ejercicioId);
        console.log('Tipo de operación:', tipoOperacion);
        
        // Create FormData object to handle file upload
        const formData = new FormData(this);
        
        // Determine action based on editing state
        if (editingMovimiento) {
            formData.append('action', 'edit');
            formData.append('movimiento_id', editingMovimiento.id);
            formData.append('tipo_movimiento', editingMovimiento.tipo);
        } else {
            formData.append('action', 'add');
        }
        
        formData.append('tipo_operacion', tipoOperacion);
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                console.log('Respuesta guardar:', data);
                if (data.success) {
                    // Determine message before clearing editing state
                    const message = editingMovimiento ? 'Movimiento actualizado correctamente' : 'Movimiento añadido correctamente';
                    
                    $('#addMovementModal').modal('hide');
                    
                    // Clear editing state
                    editingMovimiento = null;
                    
                    resetModalForm(); // Usar la función de reset más completa
                    
                    // Recargar los movimientos para obtener el saldo actualizado
                    const ejercicioId = $('#ejercicioSelect').val();
                    if (ejercicioId) {
                        loadEjercicioMovimientos(ejercicioId); // Esto actualizará tanto la tabla como los campos del header
                    }
                    
                    showSuccess(message);
                } else {
                    showError('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al guardar:', error);
                console.error('Response:', xhr.responseText);
                showError('Error al guardar el movimiento: ' + error);
            }
        });
    });

    // Update concept color based on selection and show/hide justificante fields
    $('#concepto').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const esGasto = selectedOption.data('es-gasto') === "True";
        
        console.log('Concepto seleccionado:', selectedOption.text(), 'Es gasto:', esGasto);
        
        // Get current operation type to determine which justificante fields to show
        const tipoOperacion = $('#tipo_operacion').val();
        
        if (selectedOption.val()) {
            // Hay concepto seleccionado
            if (esGasto) {
                $(this).removeClass('border-success').addClass('border-warning');
            } else {
                $(this).removeClass('border-warning').addClass('border-success');
            }
            
            // Mostrar campos según tipo de operación
            if (tipoOperacion === 'efectivo') {
                // Para efectivo: solo gastos necesitan justificante
                if (esGasto) {
                    $('#justificanteFields').removeClass('d-none').addClass('show').show();
                } else {
                    $('#justificanteFields').removeClass('show').hide();
                }
                $('#justificanteFieldsBanco').hide();
            } else if (tipoOperacion === 'transferencia') {
                // Para transferencias: SIEMPRE mostrar justificante (ingreso o gasto)
                $('#justificanteFieldsBanco').removeClass('d-none').addClass('show').show();
                $('#justificanteFields').hide();
                
                // Actualizar las etiquetas según si es gasto o ingreso
                updateBankJustificanteLabels(esGasto);
            }
            
            console.log('Campos de justificante actualizados para:', esGasto ? 'gasto' : 'ingreso');
        } else {
            // No hay selección - ocultar campos y resetear estilos
            $(this).removeClass('border-success border-warning');
            $('#justificanteFields, #justificanteFieldsBanco').removeClass('show').hide();
            $('#justificante, #justificante_banco').val('');
            $('#archivo_justificante, #archivo_justificante_banco').val('');
            $('.file-display').remove(); // Remove file display
            console.log('Sin selección - ocultando campos');
        }
    });

    // Handle tipo de operacion changes
    $('#tipo_operacion').on('change', function() {
        const tipoOperacion = $(this).val();
        console.log('Tipo de operación seleccionado:', tipoOperacion);
        
        if (tipoOperacion === 'efectivo') {
            // Mostrar selector de caja y campos de efectivo
            $('#cajaSelectionRow').show();
            $('#camposEfectivo').show();
            $('#camposBanco').hide();
            
            // Hacer obligatorio el selector de caja para operaciones de efectivo
            $('#cajaSelect').prop('required', true);
            
            // Ocultar desglose hasta que se seleccione una caja
            $('#desgloseDineroSection').hide();
            
            // Cargar cajas del ejercicio seleccionado
            loadCajasForEjercicio();
            
            // Si hay un concepto seleccionado, aplicar lógica de justificante para efectivo
            const concepto = $('#concepto').find('option:selected');
            const esGasto = concepto.data('es-gasto') === "True";
            if (concepto.val()) {
                // Para efectivo: solo gastos necesitan justificante
                if (esGasto) {
                    $('#justificanteFields').show();
                } else {
                    $('#justificanteFields').hide();
                }
                $('#justificanteFieldsBanco').hide();
            }
            
        } else if (tipoOperacion === 'transferencia') {
            // Ocultar selector de caja para transferencias bancarias
            $('#cajaSelectionRow').hide();
            $('#cajaSelect').val(''); // Limpiar selección de caja
            
            // Hacer NO obligatorio el selector de caja para transferencias bancarias
            $('#cajaSelect').prop('required', false);
            
            // Ocultar desglose para transferencias bancarias
            $('#desgloseDineroSection').hide();
            
            // Mostrar campos de banco y ocultar campos de efectivo
            $('#camposBanco').show();
            $('#camposEfectivo').hide();
            
            // Si hay un concepto seleccionado, SIEMPRE mostrar justificante bancario
            const concepto = $('#concepto').find('option:selected');
            const esGasto = concepto.data('es-gasto') === "True";
            if (concepto.val()) {
                $('#justificanteFieldsBanco').show();
                $('#justificanteFields').hide();
                
                // Actualizar las etiquetas según si es gasto o ingreso
                updateBankJustificanteLabels(esGasto);
            }
            
        } else {
            // Sin selección - ocultar todos los campos específicos
            $('#camposEfectivo').hide();
            $('#camposBanco').hide();
            $('#desgloseDineroSection').hide();
            
            // Hacer NO obligatorio el selector de caja cuando no hay selección
            $('#cajaSelect').prop('required', false);
        }
        
        // Limpiar los campos del tipo no seleccionado
        if (tipoOperacion === 'efectivo') {
            $('#justificante_banco, #referencia_bancaria').val();
            $('#archivo_justificante_banco').val('');
        } else if (tipoOperacion === 'transferencia') {
            $('#justificante').val('');
            $('#archivo_justificante').val('');
            // Limpiar también campos de desglose de dinero
            $('.money-input').val('');
            calculateMoneyTotals();
        }
    });

    // Handle caja selection changes for money breakdown
    $(document).on('change', '#cajaSelect', function() {
        const cajaId = $(this).val();
        const tipoOperacion = $('#tipo_operacion').val();
        
        console.log('Caja seleccionada:', cajaId, 'Tipo operación:', tipoOperacion);
        
        if (cajaId && tipoOperacion === 'efectivo') {
            // Load money breakdown data for the selected caja and show the desglose section
            loadCajaMoneyBreakdown(cajaId);
        } else if (tipoOperacion === 'efectivo') {
            // Hide breakdown if no caja selected
            $('#desgloseDineroSection').hide();
            // Reset available quantities display
            $('.available-quantity .quantity-text').text('Disponible: --');
            $('.available-quantity').removeClass('has-available no-available');
        }
    });

    function sortMovimientos(field) {
        console.log('Ordenando por:', field);
        
        // Si es el mismo campo, cambiar orden, sino usar descendente por defecto
        if (currentSortField === field) {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortOrder = 'desc';
        }
        
        // Ordenar los movimientos
        filteredMovimientos.sort(function(a, b) {
            let valueA, valueB;
            
            if (field === 'fecha') {
                valueA = new Date(a.datetime_iso);
                valueB = new Date(b.datetime_iso);
            } else if (field === 'cantidad') {
                valueA = parseFloat(a.cantidad);
                valueB = parseFloat(b.cantidad);
            }
            
            if (currentSortOrder === 'asc') {
                return valueA > valueB ? 1 : -1;
            } else {
                return valueA < valueB ? 1 : -1;
            }
        });
        
        // Mostrar los movimientos ordenados
        displayMovimientos(filteredMovimientos);
        
        // Actualizar los botones
        updateSortButtons();
    }

    function updateSortButtons() {
        // Resetear todos los botones
        $('#sortByDate, #sortByAmount').removeClass('btn-primary').addClass('btn-outline-secondary');
        $('#sortDateIcon, #sortAmountIcon').html('');
        
        // Activar el botón actual
        let activeButton, activeIcon;
        switch (currentSortField) {
            case 'fecha':
                activeButton = '#sortByDate';
                activeIcon = '#sortDateIcon';
                break;
            case 'cantidad':
                activeButton = '#sortByAmount';
                activeIcon = '#sortAmountIcon';
                break;
        }
        
        if (activeButton) {
            $(activeButton).removeClass('btn-outline-secondary').addClass('btn-primary');
            const icon = currentSortOrder === 'asc' ? '↑' : '↓';
            $(activeIcon).html(icon);
        }
    }
    
    function validateCompleteMoneyBreakdown() {
        
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        
        if (cantidadMovimiento <= 0) {
            return {
                valid: false,
                error: 'Por favor, ingresa una cantidad válida para el movimiento.'
            };
        }
        
        // Verificar que hay al menos una entrada en el desglose
        let tieneDesglose = false;
        $('.money-input').each(function() {
            if (parseInt($(this).val()) > 0) {
                tieneDesglose = true;
                return false; // break
            }
        });
        
        if (!tieneDesglose) {
            return {
                valid: false,
                error: 'ERROR: El desglose de billetes y monedas es obligatorio. Por favor, especifica la cantidad exacta de cada denominación que entra y sale de la caja.'
            };
        }
        
        // Verificar que los totales coincidan
        const totales = calculateMoneyTotals();
        let valorCalculado = totales.neto;
        const esGasto = $('#concepto option:selected').data('es-gasto') === "True";

        
        if (esGasto) {
            if (valorCalculado > 0) {
                return {
                    valid: false,
                    error: 'ERROR: El desglose no puede ser positivo para un gasto. Por favor, verifica las cantidades.'
                };
            }
            valorCalculado = -valorCalculado; // Invertir el valor para gastos
        } else {
            if (valorCalculado < 0) {
                return {
                    valid: false,
                    error: 'ERROR: El desglose no puede ser negativo para un ingreso. Por favor, verifica las cantidades.'
                };
            }
        }

        const diferencia = Math.abs(valorCalculado - cantidadMovimiento);
        const tolerance = 0.01; // Tolerancia de 1 céntimo
        
        if (diferencia > tolerance) {
            return {
                valid: false,
                error: `ERROR: El desglose (${totales.neto.toFixed(2)}€) no coincide con la cantidad del movimiento (${cantidadMovimiento.toFixed(2)}€). Diferencia: ${diferencia.toFixed(2)}€. El desglose debe ser exacto.`
            };
        }
        
        return {
            valid: true,
            error: null
        };
    }
    
    // Funciones para el desglose de billetes y monedas
    function initializeMoneyBreakdown() {
        // Event listeners para los inputs de dinero
        $('.money-input').on('input', function() {
            calculateMoneyTotals();
            validateMoneyBreakdown();
        });
        
        // Event listeners específicos para validación de entradas y salidas
        $('.entrada-input').on('input blur', function() {
            validateEntradaInput(this);
        });
        
        $('.salida-input').on('input blur', function() {
            validateSalidaInput(this);
        });
        
        // Validación adicional en tiempo real para inputs de salida que exceden cantidad
        $('.salida-input').on('input', function() {
            const $input = $(this);
            const value = parseInt($input.val()) || 0;
            const available = parseInt($input.data('available')) || 0;
            
            // Validación visual inmediata sin corregir el valor aún
            if (value > available && available >= 0) {
                $input.addClass('exceeds-available');
                $input.closest('.money-item').addClass('has-error');
            } else {
                $input.removeClass('exceeds-available');
                $input.closest('.money-item').removeClass('has-error');
            }
        });
        
        // Prevenir pegado de valores negativos
        $('.money-input').on('paste', function(e) {
            setTimeout(() => {
                const value = parseInt($(this).val()) || 0;
                if (value < 0) {
                    $(this).val(0);
                    showTemporaryMessage($(this), 'No se permiten valores negativos', 'warning');
                }
                
                // Validar límites si es salida
                if ($(this).hasClass('salida-input')) {
                    validateSalidaInput(this);
                }
                
                calculateMoneyTotals();
                validateMoneyBreakdown();
            }, 100);
        });
        
        // Botón para calcular desde total
        $('#calcularDesdeTotal').on('click', function() {
            calculateFromTotal();
        });
        
        // Botón para limpiar desglose
        $('#limpiarDesglose').on('click', function() {
            clearMoneyBreakdown();
        });
        
        // Calcular totales inicial
        calculateMoneyTotals();
    }
    
    function calculateMoneyTotals() {
        let totalEntrada = 0;
        let totalSalida = 0;
        
        $('.entrada-input').each(function() {
            const cantidad = parseInt($(this).val()) || 0;
            const valor = parseFloat($(this).data('valor'));
            totalEntrada += cantidad * valor;
        });
        
        $('.salida-input').each(function() {
            const cantidad = parseInt($(this).val()) || 0;
            const valor = parseFloat($(this).data('valor'));
            totalSalida += cantidad * valor;
        });
        
        const totalNeto = totalEntrada - totalSalida;
        
        $('#totalEntrada').text(totalEntrada.toFixed(2) + '€');
        $('#totalSalida').text(totalSalida.toFixed(2) + '€');
        $('#totalNeto').text(totalNeto.toFixed(2) + '€');
        
        // Actualizar el color del total neto
        const $totalNeto = $('#totalNeto');
        $totalNeto.removeClass('text-success text-danger text-info');
        if (totalNeto > 0) {
            $totalNeto.addClass('text-success');
        } else if (totalNeto < 0) {
            $totalNeto.addClass('text-danger');
        } else {
            $totalNeto.addClass('text-info');
        }
        
        return {
            entrada: totalEntrada,
            salida: totalSalida,
            neto: totalNeto
        };
    }
    
    function validateMoneyBreakdown() {
        // VALIDACIÓN PRINCIPAL DEL DESGLOSE
        // Esta función verifica que el desglose coincida exactamente con la cantidad del movimiento
        
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        const totales = calculateMoneyTotals();
        
        // Verificar si el total neto coincide con la cantidad del movimiento
        const diferencia = Math.abs(totales.neto - cantidadMovimiento);
        const tolerance = 0.01; // Tolerancia de 1 céntimo
        
        const $totalNeto = $('#totalNeto').parent();
        $totalNeto.removeClass('border border-warning border-success');
        
        if (cantidadMovimiento > 0) {
            if (diferencia <= tolerance) {
                // Coincide exactamente - mostrar como correcto
                $totalNeto.addClass('border border-success');
            } else {
                // No coincide - mostrar como error
                $totalNeto.addClass('border border-warning');
            }
        }
        
        // Retornar si la validación es correcta (será usado en el submit del formulario)
        return diferencia <= tolerance;
    }
    
    function calculateFromTotal() {
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        
        if (cantidadMovimiento <= 0) {
            showWarning('Por favor, primero ingresa la cantidad total del movimiento.');
            return;
        }
        
        // Verificar si hay un concepto seleccionado para determinar si es gasto o ingreso
        const conceptoSeleccionado = $('#concepto option:selected');
        if (!conceptoSeleccionado.val()) {
            showWarning('Por favor, primero selecciona un concepto para determinar si es gasto o ingreso.');
            return;
        }
        
        const esGasto = conceptoSeleccionado.data('es-gasto') === "True";
        const tipoInput = esGasto ? 'salida' : 'entrada';
        
        // Limpiar el desglose actual
        clearMoneyBreakdown();
        
        // Obtener denominaciones disponibles ordenadas de mayor a menor
        const denominaciones = [];
        $(`.money-input[data-tipo="${tipoInput}"]`).each(function() {
            const cantidadDisponible = esGasto ? 
                (parseInt($(this).data('available')) || 0) : 
                999999; // Para ingresos, no hay límite
            
            if (cantidadDisponible > 0) {
                denominaciones.push({
                    id: $(this).data('denominacion'),
                    valor: parseFloat($(this).data('valor')),
                    elemento: $(this),
                    disponible: cantidadDisponible
                });
            }
        });
        
        denominaciones.sort((a, b) => b.valor - a.valor);
        
        // Calcular el total disponible para gastos
        let totalDisponible = 0;
        if (esGasto) {
            denominaciones.forEach(denom => {
                totalDisponible += denom.valor * denom.disponible;
            });
        }
        
        let remainingAmount = cantidadMovimiento;
        let cantidadDistribuida = 0;
        const distribucion = [];
        
        // Calcular automáticamente la distribución respetando cantidades disponibles
        denominaciones.forEach(denom => {
            if (remainingAmount >= denom.valor && denom.disponible > 0) {
                const cantidadIdeal = Math.floor(remainingAmount / denom.valor);
                const cantidadUsada = Math.min(cantidadIdeal, denom.disponible);
                
                if (cantidadUsada > 0) {
                    denom.elemento.val(cantidadUsada);
                    const valorUsado = cantidadUsada * denom.valor;
                    remainingAmount -= valorUsado;
                    cantidadDistribuida += valorUsado;
                    remainingAmount = Math.round(remainingAmount * 100) / 100; // Evitar errores de punto flotante
                    
                    distribucion.push({
                        valor: denom.valor,
                        cantidad: cantidadUsada,
                        total: valorUsado
                    });
                }
            }
        });
        
        // SI ES GASTO Y NO SE PUEDE HACER EXACTO, INTENTAR CON CAMBIO
        if (esGasto && remainingAmount > 0.01 && totalDisponible >= cantidadMovimiento) {
            console.log('Intentando calcular con cambio...');
            
            // Limpiar el desglose previo
            clearMoneyBreakdown();
            
            // Intentar encontrar una combinación que permita dar el vuelto
            const resultadoConCambio = calculateWithChange(cantidadMovimiento, denominaciones);
            
            if (resultadoConCambio.success) {
                // Aplicar la distribución calculada (salidas)
                resultadoConCambio.distribucion.forEach(item => {
                    const elemento = denominaciones.find(d => d.valor === item.valor)?.elemento;
                    if (elemento) {
                        elemento.val(item.cantidad);
                    }
                });
                
                // AGREGAR EL CAMBIO COMO ENTRADA
                if (resultadoConCambio.cambio > 0.01) {
                    addChangeAsIncome(resultadoConCambio.cambio);
                }
                
                calculateMoneyTotals();
                validateMoneyBreakdown();
                
                // Mostrar mensaje de éxito con información del cambio
                showCalculationWithChange(resultadoConCambio);
                return;
            }
        }
        
        calculateMoneyTotals();
        validateMoneyBreakdown();
        
        // Verificar si se pudo alcanzar la cantidad exacta
        if (remainingAmount > 0.01) { // Tolerancia de 1 céntimo
            const porcentajeAlcanzado = ((cantidadDistribuida / cantidadMovimiento) * 100).toFixed(1);
            
            if (esGasto && totalDisponible < cantidadMovimiento) {
                // No hay suficiente dinero total en la caja
                let mensaje = `❌ No hay suficiente dinero en la caja para realizar este gasto.\n\n`;
                mensaje += `💰 Total disponible en caja: ${totalDisponible.toFixed(2)}€\n`;
                mensaje += `💸 Cantidad del gasto: ${cantidadMovimiento.toFixed(2)}€\n`;
                mensaje += `📉 Faltan: ${(cantidadMovimiento - totalDisponible).toFixed(2)}€\n\n`;
                mensaje += `💡 Sugerencias:\n`;
                mensaje += `• Añade más dinero a la caja\n`;
                mensaje += `• Reduce la cantidad del gasto\n`;
                mensaje += `• Realiza el gasto en varias transacciones`;
                
                showWarning(mensaje);
                showInsufficientFunds(totalDisponible, cantidadMovimiento);
            } else {
                // Hay dinero suficiente pero no se puede hacer exacto
                let mensaje = `⚠️ No se puede alcanzar la cantidad exacta de ${cantidadMovimiento.toFixed(2)}€ con las denominaciones disponibles en la caja.\n\n`;
                mensaje += `💰 Cantidad distribuida: ${cantidadDistribuida.toFixed(2)}€ (${porcentajeAlcanzado}%)\n`;
                mensaje += `📉 Cantidad faltante: ${remainingAmount.toFixed(2)}€\n\n`;
                
                if (distribucion.length > 0) {
                    mensaje += `📊 Distribución calculada:\n`;
                    distribucion.forEach(item => {
                        mensaje += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
                    });
                    mensaje += '\n';
                }
                
                if (esGasto) {
                    mensaje += `💡 Sugerencias:\n`;
                    mensaje += `• Verifica que hay suficientes billetes/monedas en la caja\n`;
                    mensaje += `• Considera realizar el gasto en varias transacciones\n`;
                    mensaje += `• Ajusta la cantidad del movimiento a ${cantidadDistribuida.toFixed(2)}€`;
                } else {
                    mensaje += `💡 Nota: Para ingresos, siempre puedes especificar manualmente las denominaciones exactas que ingresan.`;
                }
                
                showWarning(mensaje);
                
                // Opcional: resaltar visualmente que el cálculo está incompleto
                $('#totalNeto').parent().removeClass('border-success').addClass('border border-warning');
                
                // Mostrar mensaje temporal en la interfaz
                showCalculationWarning(cantidadDistribuida, remainingAmount, cantidadMovimiento);
            }
        } else {
            // Cálculo exitoso
            const mensaje = `✅ Cantidad distribuida correctamente: ${cantidadMovimiento.toFixed(2)}€\n\n📊 Distribución:\n`;
            let detalleDistribucion = '';
            distribucion.forEach(item => {
                detalleDistribucion += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
            });
            
            console.log(mensaje + detalleDistribucion);
            
            // Mostrar mensaje de éxito temporal
            showCalculationSuccess(cantidadMovimiento);
        }
    }
    
    function clearMoneyBreakdown() {
        $('.money-input').val('');
        $('.money-input').removeClass('exceeds-available');
        $('.temp-message').remove();
        $('.calculation-message').remove(); // Limpiar todos los tipos de mensajes de cálculo
        $('#totalNeto').parent().removeClass('border border-warning border-success'); // Resetear estilos de validación
        calculateMoneyTotals();
    }
    
    function showCalculationWarning(cantidadDistribuida, cantidadFaltante, cantidadTotal) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const porcentaje = ((cantidadDistribuida / cantidadTotal) * 100).toFixed(1);
        
        const $message = $(`
            <div class="calculation-message alert alert-warning alert-enhanced fade-in mt-3 mb-0">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-alert-circle-exc mr-3 mt-1"></i>
                    <div>
                        <h6 class="mb-2">⚠️ Distribución incompleta</h6>
                        <p class="mb-2">
                            <strong>Distribuido:</strong> ${cantidadDistribuida.toFixed(2)}€ (${porcentaje}%) <br>
                            <strong>Faltante:</strong> ${cantidadFaltante.toFixed(2)}€
                        </p>
                        <small class="text-muted">
                            No hay suficientes denominaciones disponibles en la caja para alcanzar la cantidad exacta.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 10 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 10000);
    }
    
    function showCalculationSuccess(cantidadTotal) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const $message = $(`
            <div class="calculation-message alert alert-success alert-enhanced fade-in mt-3 mb-0">
                <div class="d-flex align-items-center">
                    <i class="tim-icons icon-check-2 mr-3"></i>
                    <div>
                        <strong>✅ Distribución completada correctamente</strong>
                        <br>
                        <small class="text-muted">Cantidad total: ${cantidadTotal.toFixed(2)}€</small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 5000);
    }
    
    function calculateWithChange(cantidadObjetivo, denominacionesDisponibles) {
        // Esta función intenta encontrar una combinación que permita pagar con cambio
        console.log('Calculando con cambio para:', cantidadObjetivo);
        
        // Ordenar denominaciones de mayor a menor
        const denomsOrdenadas = [...denominacionesDisponibles].sort((a, b) => b.valor - a.valor);
        
        // Intentar con diferentes estrategias empezando por billetes grandes
        for (let estrategia = 0; estrategia < 3; estrategia++) {
            const resultado = tryPaymentStrategy(cantidadObjetivo, denomsOrdenadas, estrategia);
            if (resultado.success) {
                return resultado;
            }
        }
        
        return { success: false };
    }
    
    function tryPaymentStrategy(cantidadObjetivo, denominaciones, estrategia) {
        let mejorResultado = { success: false, exceso: Infinity };
        
        // Estrategia 0: Usar billetes grandes primero
        // Estrategia 1: Usar combinaciones medias
        // Estrategia 2: Probar todas las combinaciones posibles (limitada)
        
        function buscarCombinacion(indice, acumulado, distribucionActual) {
            if (indice >= denominaciones.length) {
                if (acumulado >= cantidadObjetivo) {
                    const exceso = acumulado - cantidadObjetivo;
                    if (exceso < mejorResultado.exceso) {
                        mejorResultado = {
                            success: true,
                            exceso: exceso,
                            totalPagado: acumulado,
                            distribucion: [...distribucionActual],
                            cambio: exceso
                        };
                    }
                }
                return;
            }
            
            const denom = denominaciones[indice];
            const maxCantidad = Math.min(denom.disponible, 
                estrategia === 0 ? Math.ceil((cantidadObjetivo * 1.5) / denom.valor) : denom.disponible
            );
            
            // Probar diferentes cantidades de esta denominación
            for (let cantidad = 0; cantidad <= maxCantidad; cantidad++) {
                const nuevoAcumulado = acumulado + (cantidad * denom.valor);
                
                // Poda: si ya excedemos mucho, no seguir
                if (nuevoAcumulado > cantidadObjetivo * 2) break;
                
                if (cantidad > 0) {
                    distribucionActual.push({
                        valor: denom.valor,
                        cantidad: cantidad,
                        total: cantidad * denom.valor
                    });
                }
                
                buscarCombinacion(indice + 1, nuevoAcumulado, distribucionActual);
                
                if (cantidad > 0) {
                    distribucionActual.pop();
                }
                
                // Si encontramos una solución perfecta en estrategia 0, parar
                if (estrategia === 0 && mejorResultado.success && mejorResultado.exceso < 0.01) {
                    break;
                }
            }
        }
        
        buscarCombinacion(0, 0, []);
        return mejorResultado;
    }
    
    function showCalculationWithChange(resultado) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const $message = $(`
            <div class="calculation-message alert alert-info alert-enhanced fade-in mt-3 mb-0">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-coins mr-3 mt-1"></i>
                    <div>
                        <h6 class="mb-2">💰 Pago calculado con cambio</h6>
                        <p class="mb-2">
                            <strong>Gasto real:</strong> ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€<br>
                            <strong>Total pagado (salida):</strong> ${resultado.totalPagado.toFixed(2)}€<br>
                            <strong>Cambio recibido (entrada):</strong> <span class="text-success">+${resultado.cambio.toFixed(2)}€</span>
                        </p>
                        <div class="mb-2">
                            <strong>Distribución de salida:</strong><br>
                            ${resultado.distribucion.map(item => 
                                `<small>• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€</small>`
                            ).join('<br>')}<br>
                            <strong>Cambio añadido automáticamente como entrada</strong>
                        </div>
                        <small class="text-muted">
                            <i class="tim-icons icon-bulb-63"></i>
                            El desglose refleja el movimiento completo: salida del pago y entrada del cambio.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 12 segundos (más tiempo por ser más información)
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 12000);
        
        // También mostrar un alert más detallado
        let alertMsg = `💰 Pago calculado con cambio - Desglose completo\n\n`;
        alertMsg += `💸 Gasto real: ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€\n`;
        alertMsg += `💵 Total pagado (SALIDA): ${resultado.totalPagado.toFixed(2)}€\n`;
        alertMsg += `💚 Cambio recibido (ENTRADA): +${resultado.cambio.toFixed(2)}€\n\n`;
        alertMsg += `📊 Distribución de salida:\n`;
        resultado.distribucion.forEach(item => {
            alertMsg += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
        });
        alertMsg += `\n� El cambio se ha añadido automáticamente como entrada en el desglose.\n`;
        alertMsg += `📝 El total neto coincidirá exactamente con el gasto real de ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€`;
        
        showInfo(alertMsg);
    }
    
    function showInsufficientFunds(totalDisponible, cantidadRequerida) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const faltante = cantidadRequerida - totalDisponible;
        
        const $message = $(`
            <div class="calculation-message alert alert-danger alert-enhanced fade-in mt-3 mb-0">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-simple-remove mr-3 mt-1"></i>
                    <div>
                        <h6 class="mb-2">❌ Fondos insuficientes</h6>
                        <p class="mb-2">
                            <strong>Total disponible:</strong> ${totalDisponible.toFixed(2)}€<br>
                            <strong>Cantidad requerida:</strong> ${cantidadRequerida.toFixed(2)}€<br>
                            <strong>Faltante:</strong> ${faltante.toFixed(2)}€
                        </p>
                        <small class="text-muted">
                            No hay suficiente dinero en la caja para realizar esta operación.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 8 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 8000);
    }
    
    function addChangeAsIncome(cantidadCambio) {
        console.log('Añadiendo cambio como entrada:', cantidadCambio);
        
        // Obtener todas las denominaciones de entrada ordenadas de mayor a menor
        const denominacionesEntrada = [];
        $('.entrada-input').each(function() {
            denominacionesEntrada.push({
                valor: parseFloat($(this).data('valor')),
                elemento: $(this)
            });
        });
        
        denominacionesEntrada.sort((a, b) => b.valor - a.valor);
        
        let remainingChange = cantidadCambio;
        const distribucionCambio = [];
        
        // Distribuir el cambio usando denominaciones grandes primero
        denominacionesEntrada.forEach(denom => {
            if (remainingChange >= denom.valor) {
                const cantidad = Math.floor(remainingChange / denom.valor);
                if (cantidad > 0) {
                    // Obtener el valor actual del input y sumarle la nueva cantidad
                    const valorActual = parseInt(denom.elemento.val()) || 0;
                    const nuevaCantidad = valorActual + cantidad;

                    denom.elemento.val(nuevaCantidad);

                    const valorUsado = cantidad * denom.valor;
                    remainingChange -= valorUsado;
                    remainingChange = Math.round(remainingChange * 100) / 100; // Evitar errores de punto flotante
                    
                    distribucionCambio.push({
                        valor: denom.valor,
                        cantidad: cantidad,
                        total: valorUsado
                    });
                }
            }
        });
        
        // Si queda algo residual (centimos), añadirlo a la denominación más pequeña disponible
        if (remainingChange > 0.001) {
            console.warn('Cambio residual no distribuido:', remainingChange);
            // Buscar la denominación más pequeña para el residual
            const denomMenor = denominacionesEntrada[denominacionesEntrada.length - 1];
            if (denomMenor && denomMenor.valor <= remainingChange * 2) {
                const valorActual = parseInt(denomMenor.elemento.val()) || 0;
                denomMenor.elemento.val(valorActual + 1);
                distribucionCambio.push({
                    valor: denomMenor.valor,
                    cantidad: 1,
                    total: denomMenor.valor,
                    nota: 'Ajuste por redondeo'
                });
            }
        }
        
        console.log('Distribución del cambio:', distribucionCambio);
        return distribucionCambio;
    }

    function updateSearchResults(count, isSearching) {
        $('#resultsCount').text(count);
        
        if (isSearching) {
            $('#resultsText').text(count === 1 ? 'resultado encontrado' : 'resultados encontrados');
            $('#searchResultsInfo').removeClass('text-muted').addClass(count > 0 ? 'text-success' : 'text-warning');
            $('#searchResultsInfo i').removeClass('tim-icons icon-check-2').addClass(
                count > 0 ? 'tim-icons icon-check-2' : 'tim-icons icon-alert-circle-exc'
            );
        } else {
            $('#resultsText').text('movimientos en total');
            $('#searchResultsInfo').removeClass('text-success text-warning').addClass('text-muted');
            $('#searchResultsInfo i').removeClass().addClass('tim-icons icon-check-2');
        }
    }

    // =============================================================================
    // RESUMEN DE VALIDACIONES CENTRALIZADAS
    // =============================================================================
    // Todas las validaciones del desglose de dinero están centralizadas en este archivo:
    // - validateCompleteMoneyBreakdown(): Validación completa para submit del formulario
    // - validateMoneyBreakdown(): Validación visual en tiempo real
    // - calculateMoneyTotals(): Cálculo de totales para validaciones
    // 
    // Las validaciones duplicadas en models.py y views.py han sido eliminadas.
    // =============================================================================

    // =============================================================================
    // GESTIÓN DE CANTIDADES DISPONIBLES
    // =============================================================================
    
    function updateAvailableQuantities(desgloseActual) {
        console.log('Actualizando cantidades disponibles:', desgloseActual);
        
        // Actualizar todas las denominaciones
        $('.money-item').each(function() {
            const denominacionId = $(this).find('.salida-input').data('denominacion');
            const $availableDisplay = $(this).find('.available-quantity');
            const $salidaInput = $(this).find('.salida-input');
            const $moneyItem = $(this);
            
            if (desgloseActual[denominacionId]) {
                const cantidad = desgloseActual[denominacionId].cantidad;
                
                // Actualizar el display según la cantidad
                if (cantidad === 0) {
                    $availableDisplay.find('.quantity-text').text('Sin unidades');
                    $availableDisplay.addClass('no-available').removeClass('has-available');
                } else {
                    $availableDisplay.find('.quantity-text').text(`Disponible: ${cantidad}`);
                    $availableDisplay.removeClass('no-available').addClass('has-available');
                }
                
                // Actualizar el max del input de salida
                $salidaInput.attr('max', cantidad);
                $salidaInput.data('available', cantidad);
                
                // Validar si el valor actual excede lo disponible
                const currentValue = parseInt($salidaInput.val()) || 0;
                if (currentValue > cantidad) {
                    $salidaInput.val(cantidad);
                    $salidaInput.addClass('exceeds-available');
                    $moneyItem.addClass('has-error');
                    showTemporaryMessage($salidaInput, `Cantidad ajustada al máximo disponible: ${cantidad}`, 'exceeds-warning');
                } else {
                    $salidaInput.removeClass('exceeds-available');
                    $moneyItem.removeClass('has-error');
                }
            } else {
                // No hay cantidad disponible
                $availableDisplay.find('.quantity-text').text('Sin unidades');
                $availableDisplay.addClass('no-available').removeClass('has-available');
                $salidaInput.attr('max', 0);
                $salidaInput.data('available', 0);
                $salidaInput.val('');
                $salidaInput.removeClass('exceeds-available');
                $moneyItem.removeClass('has-error');
            }
        });
        
        console.log('Cantidades disponibles actualizadas');
    }
    
    function validateSalidaInput(input) {
        const $input = $(input);
        const value = parseInt($input.val()) || 0;
        const available = parseInt($input.data('available')) || 0;
        const $moneyItem = $input.closest('.money-item');
        
        // Limpiar estados anteriores
        $input.removeClass('exceeds-available');
        $moneyItem.removeClass('has-error');
        $moneyItem.find('.temp-message').remove();
        
        // Validar que no sea negativo
        if (value < 0) {
            $input.val(0);
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            showTemporaryMessage($input, 'No se permiten valores negativos', 'warning');
            return false;
        }
        
        // Validar que no exceda lo disponible
        if (value > available) {
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            
            // Mostrar mensaje temporal más descriptivo
            if (available === 0) {
                showTemporaryMessage($input, 'No hay unidades disponibles de esta denominación', 'exceeds-warning');
                $input.val(0);
            } else {
                showTemporaryMessage($input, `Máximo disponible: ${available} unidades`, 'exceeds-warning');
                $input.val(available);
            }
            return false;
        }
        
        return true;
    }
    
    function validateEntradaInput(input) {
        const $input = $(input);
        const value = parseInt($input.val()) || 0;
        const $moneyItem = $input.closest('.money-item');
        
        // Limpiar estados anteriores
        $input.removeClass('exceeds-available');
        $moneyItem.removeClass('has-error');
        $moneyItem.find('.temp-message').remove();
        
        // Validar que no sea negativo
        if (value < 0) {
            $input.val(0);
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            showTemporaryMessage($input, 'No se permiten valores negativos', 'warning');
            return false;
        }
        
        return true;
    }
    
    function showTemporaryMessage(input, message, type) {
        const $input = $(input);
        const $container = $input.closest('.money-item');
        
        // Remover mensaje anterior si existe
        $container.find('.temp-message').remove();
        
        // Determinar la clase del mensaje según el tipo
        let alertClass = 'alert-info';
        let iconClass = 'tim-icons icon-alert-circle-exc';
        
        if (type === 'warning') {
            alertClass = 'alert-warning';
            iconClass = 'tim-icons icon-alert-circle-exc';
        } else if (type === 'exceeds-warning') {
            alertClass = 'exceeds-warning';
            iconClass = 'tim-icons icon-simple-remove';
        }
        
        // Crear mensaje temporal mejorado
        const $message = $(`
            <div class="temp-message alert alert-enhanced ${alertClass} fade-in mt-2 mb-0" style="font-size: 0.75rem;">
                <i class="${iconClass}"></i>
                ${message}
            </div>
        `);
        
        // Insertar después del input-group
        $input.closest('.input-group').after($message);
        
        // Efecto de entrada
        $message.hide().fadeIn(300);
        
        // Remover después de 4 segundos (más tiempo para mensajes críticos)
        const fadeTime = type === 'exceeds-warning' ? 5000 : 3000;
        setTimeout(() => {
            $message.fadeOut(300, function() {
                $(this).remove();
            });
        }, fadeTime);
    }

    // ==============================================
    // SISTEMA DE ALERTAS MEJORADO
    // ==============================================

    /**
     * Crea un contenedor para alertas flotantes si no existe
     */
    function ensureAlertsContainer() {
        if (!$('.alerts-container').length) {
            $('body').append('<div class="alerts-container"></div>');
        }
    }

    /**
     * Muestra una alerta mejorada con animaciones y estilos consistentes
     * @param {string} message - Mensaje a mostrar
     * @param {string} type - Tipo: success, warning, danger, info, primary
     * @param {object} options - Opciones adicionales
     */
    function showEnhancedAlert(message, type = 'info', options = {}) {
        ensureAlertsContainer();
        
        const defaults = {
            duration: 4000,
            closable: true,
            icon: true,
            floating: false,
            container: null
        };
        
        const opts = {...defaults, ...options};
        
        // Iconos por tipo
        const icons = {
            success: 'icon-check-2',
            warning: 'icon-alert-circle-exc',
            danger: 'icon-simple-remove',
            info: 'icon-bell-55',
            primary: 'icon-app'
        };
        
        // Crear elemento de alerta
        const alertId = 'alert-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const iconHtml = opts.icon ? `<i class="tim-icons ${icons[type] || icons.info}"></i>` : '';
        const closeHtml = opts.closable ? 
            `<button type="button" class="close" onclick="closeEnhancedAlert('${alertId}')">
                <span>&times;</span>
            </button>` : '';
        
        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-enhanced fade-in ${opts.closable ? 'alert-dismissible' : ''}" role="alert">
                ${iconHtml}
                <span class="alert-message">${message}</span>
                ${closeHtml}
            </div>
        `;
        
        // Insertar alerta
        const $alert = $(alertHtml);
        
        if (opts.floating) {
            $('.alerts-container').prepend($alert);
        } else if (opts.container) {
            $(opts.container).prepend($alert);
        } else {
            $('.alerts-container').prepend($alert);
        }
        
        // Auto-remover si se especifica duración
        if (opts.duration > 0) {
            setTimeout(() => {
                closeEnhancedAlert(alertId);
            }, opts.duration);
        }
        
        return alertId;
    }

    /**
     * Cierra una alerta específica con animación
     */
    function closeEnhancedAlert(alertId) {
        const $alert = $(`#${alertId}`);
        if ($alert.length) {
            $alert.removeClass('fade-in').addClass('fade-out');
            setTimeout(() => {
                $alert.remove();
            }, 300);
        }
    }

    /**
     * Reemplaza alert() nativo con versión mejorada
     */
    function enhancedAlert(message, type = 'info') {
        return showEnhancedAlert(message, type, {
            floating: true,
            duration: 5000
        });
    }

    /**
     * Muestra alerta de éxito
     */
    function showSuccess(message, options = {}) {
        return showEnhancedAlert(message, 'success', options);
    }

    /**
     * Muestra alerta de advertencia
     */
    function showWarning(message, options = {}) {
        return showEnhancedAlert(message, 'warning', options);
    }

    /**
     * Muestra alerta de error
     */
    function showError(message, options = {}) {
        return showEnhancedAlert(message, 'danger', options);
    }

    /**
     * Muestra alerta de información
     */
    function showInfo(message, options = {}) {
        return showEnhancedAlert(message, 'info', options);
    }

    /**
     * Cierra todas las alertas flotantes
     */
    function closeAllAlerts() {
        $('.alerts-container .alert').each(function() {
            const alertId = $(this).attr('id');
            if (alertId) {
                closeEnhancedAlert(alertId);
            }
        });
    }

    // Inicializar contenedor de alertas al cargar la página
    $(document).ready(function() {
        ensureAlertsContainer();
    });
    
    // Function to update bank justificante labels based on expense/income
    function updateBankJustificanteLabels(esGasto) {
        const labelText = esGasto ? 'Justificante de Factura' : 'Justificante de Pago';
        const helpText = esGasto ? 'Número de justificante de la factura/gasto' : 'Número de justificante del pago/ingreso';
        
        // Update label text
        $('label[for="justificante_banco"]').text(labelText);
        $('label[for="archivo_justificante_banco"]').text(`Archivo ${labelText}`);
        
        // Update help text
        $('#justificante_banco').next('small').find('i').next().text(helpText);
        
        console.log('Etiquetas de justificante bancario actualizadas para:', esGasto ? 'gasto' : 'ingreso');
    }

    // =============================================================================
    // FUNCIONES DE FILTRADO
    // =============================================================================

    /**
     * Alternar filtro de tipo de operación (efectivo/banco/todos)
     */
    function toggleTipoFilter() {
        const states = ['todos', 'efectivo', 'banco'];
        const currentIndex = states.indexOf(currentTipoFilter);
        const nextIndex = (currentIndex + 1) % states.length;
        currentTipoFilter = states[nextIndex];
        
        updateTipoFilterButton();
        applyFilters();
    }

    /**
     * Alternar filtro de ingresos/gastos (todos/ingresos/gastos)
     */
    function toggleIngresosGastosFilter() {
        const states = ['todos', 'ingresos', 'gastos'];
        const currentIndex = states.indexOf(currentIngresosGastosFilter);
        const nextIndex = (currentIndex + 1) % states.length;
        currentIngresosGastosFilter = states[nextIndex];
        
        updateIngresosGastosFilterButton();
        applyFilters();
    }

    /**
     * Actualizar el botón de filtro de tipo
     */
    function updateTipoFilterButton() {
        const $button = $('#filterTipo');
        const $text = $('#filterTipoText');
        const $icon = $button.find('i');
        
        // Resetear clases
        $button.removeClass('btn-outline-info btn-info btn-outline-secondary btn-secondary');
        
        switch (currentTipoFilter) {
            case 'efectivo':
                $button.addClass('btn-secondary');
                $icon.removeClass().addClass('tim-icons icon-coins');
                $text.text('Efectivo');
                break;
            case 'banco':
                $button.addClass('btn-info');
                $icon.removeClass().addClass('tim-icons icon-credit-card');
                $text.text('Banco');
                break;
            default:
                $button.addClass('btn-outline-info');
                $icon.removeClass().addClass('tim-icons icon-atom');
                $text.text('Todos');
                break;
        }
    }

    /**
     * Actualizar el botón de filtro de ingresos/gastos
     */
    function updateIngresosGastosFilterButton() {
        const $button = $('#filterIngresosGastos');
        const $text = $('#filterIngresosGastosText');
        const $icon = $button.find('i');
        
        // Resetear clases
        $button.removeClass('btn-outline-success btn-success btn-outline-danger btn-danger');
        
        switch (currentIngresosGastosFilter) {
            case 'ingresos':
                $button.addClass('btn-success');
                $icon.removeClass().addClass('tim-icons icon-simple-add');
                $text.text('Ingresos');
                break;
            case 'gastos':
                $button.addClass('btn-danger');
                $icon.removeClass().addClass('tim-icons icon-simple-remove');
                $text.text('Gastos');
                break;
            default:
                $button.addClass('btn-outline-success');
                $icon.removeClass().addClass('tim-icons icon-chart-pie-36');
                $text.text('Todos');
                break;
        }
    }

    /**
     * Aplicar todos los filtros activos
     */
    function applyFilters() {
        if (!currentMovimientos || currentMovimientos.length === 0) {
            return;
        }

        let filtered = [...currentMovimientos];

        // Aplicar filtro de búsqueda si existe
        const searchTerm = $('#movementsSearch').val().toLowerCase().trim();
        if (searchTerm !== '') {
            filtered = filtered.filter(mov => {
                return mov.concepto.toLowerCase().includes(searchTerm) ||
                       mov.cantidad.toString().includes(searchTerm) ||
                       (mov.justificante && mov.justificante.toLowerCase().includes(searchTerm)) ||
                       (mov.descripcion && mov.descripcion.toLowerCase().includes(searchTerm)) ||
                       mov.turno.toLowerCase().includes(searchTerm);
            });
        }

        // Aplicar filtro de tipo
        if (currentTipoFilter !== 'todos') {
            filtered = filtered.filter(mov => {
                const tipoMovimiento = mov.tipo || 'caja';
                if (currentTipoFilter === 'efectivo') {
                    return tipoMovimiento === 'caja';
                } else if (currentTipoFilter === 'banco') {
                    return tipoMovimiento === 'banco';
                }
                return true;
            });
        }

        // Aplicar filtro de ingresos/gastos
        if (currentIngresosGastosFilter !== 'todos') {
            filtered = filtered.filter(mov => {
                if (currentIngresosGastosFilter === 'ingresos') {
                    return !mov.es_gasto;
                } else if (currentIngresosGastosFilter === 'gastos') {
                    return mov.es_gasto;
                }
                return true;
            });
        }

        filteredMovimientos = filtered;
        displayMovimientos(filteredMovimientos);
        updateSearchResults(filteredMovimientos.length, searchTerm !== '' || currentTipoFilter !== 'todos' || currentIngresosGastosFilter !== 'todos');
    }

    /**
     * Resetear todos los filtros
     */
    function resetFilters() {
        currentTipoFilter = 'todos';
        currentIngresosGastosFilter = 'todos';
        updateTipoFilterButton();
        updateIngresosGastosFilterButton();
        $('#movementsSearch').val('');
        $('#clearSearch').hide();
        applyFilters();
    }

    // Global variable to track if we're editing
    let editingMovimiento = null;

    function editMovimiento(movimientoId, tipoMovimiento) {
        console.log('Editando movimiento:', movimientoId, 'tipo:', tipoMovimiento);
        
        // Verificar que hay un ejercicio seleccionado
        const ejercicioId = $('#ejercicioSelect').val();
        if (!ejercicioId) {
            showWarning('Por favor selecciona un ejercicio antes de editar un movimiento');
            return;
        }
        
        // Find the movement in our current data
        const movimiento = currentMovimientos.find(mov => mov.id === movimientoId && mov.tipo === tipoMovimiento);
        
        if (!movimiento) {
            showError('No se pudo encontrar el movimiento a editar');
            return;
        }
        
        // Set editing mode
        editingMovimiento = {
            id: movimientoId,
            tipo: tipoMovimiento,
            data: movimiento
        };
        
        // Prepare modal for editing
        prepareModalForEdit(movimiento);
        
        // Show the modal
        $('#addMovementModal').modal('show');
    }

    function prepareModalForEdit(movimiento) {
        console.log('Preparando modal para edición:', movimiento);
        
        // Update modal title
        $('#addMovementModalLabel').html(`
            <i class="tim-icons icon-pencil"></i>
            Editar Movimiento
        `);
        
        // Reset form first
        resetModalForm();
        
        // Set ejercicio ID
        const currentEjercicioId = $('#ejercicioSelect').val();
        $('#ejercicioIdInput').val(currentEjercicioId);
        
        // Set caja ID only if it's available (for cash movements)
        if (movimiento.caja_id) {
            $('#cajaIdInput').val(movimiento.caja_id);
        }
        
        // Parse fecha from movimiento
        const fecha = new Date(movimiento.datetime_iso);
        const fechaStr = fecha.toISOString().split('T')[0];
        const horaStr = fecha.toTimeString().slice(0, 5);
        
        // Populate basic fields
        $('#fecha').val(fechaStr);
        $('#hora').val(horaStr);
        $('#cantidad').val(movimiento.cantidad);
        $('#descripcion').val(movimiento.descripcion);
        
        // Set operation type based on movement type
        const tipoOperacion = movimiento.tipo === 'banco' ? 'transferencia' : 'efectivo';
        $('#tipo_operacion').val(tipoOperacion);
        
        // Disable operation type field (not allowed to change)
        $('#tipo_operacion').prop('disabled', true);
        $('#tipo_operacion').addClass('disabled-field');
        
        // Load turnos for the selected ejercicio and then set the turno
        const editEjercicioId = $('#ejercicioSelect').val();
        if (editEjercicioId) {
            loadTurnosForEjercicio(editEjercicioId, function() {
                // Find and select the correct turno by ID
                if (movimiento.turno_id) {
                    $('#turno').val(movimiento.turno_id);
                    console.log('Turno preseleccionado por ID:', movimiento.turno_id, '(' + movimiento.turno + ')');
                } else {
                    // Fallback: search by text if ID not available
                    let turnoEncontrado = false;
                    $('#turno option').each(function() {
                        if ($(this).text().trim() === movimiento.turno) {
                            $('#turno').val($(this).val());
                            turnoEncontrado = true;
                            console.log('Turno preseleccionado por texto:', movimiento.turno);
                            return false; // break
                        }
                    });
                    
                    if (!turnoEncontrado) {
                        console.warn('No se encontró el turno:', movimiento.turno);
                    }
                }
            });
        } else {
            console.warn('No hay ejercicio seleccionado para cargar turnos');
        }
        
        // Find and select the correct concepto by ID
        if (movimiento.concepto_id) {
            $('#concepto').val(movimiento.concepto_id);
            console.log('Concepto preseleccionado por ID:', movimiento.concepto_id, '(' + movimiento.concepto + ')');
            
            // Disable concept field (not allowed to change)
            $('#concepto').prop('disabled', true);
            $('#concepto').addClass('disabled-field');
            
            // Trigger change event to show/hide justificante fields
            $('#concepto').trigger('change');
        } else {
            // Fallback: search by text if ID not available
            let conceptoEncontrado = false;
            $('#concepto option').each(function() {
                const conceptoText = $(this).text().replace(/\s*\([^)]*\)/, '').trim(); // Remove (Gasto)/(Ingreso) suffix
                if (conceptoText === movimiento.concepto) {
                    $('#concepto').val($(this).val());
                    conceptoEncontrado = true;
                    console.log('Concepto preseleccionado por texto:', movimiento.concepto);
                    
                    // Disable concept field (not allowed to change)
                    $('#concepto').prop('disabled', true);
                    $('#concepto').addClass('disabled-field');
                    
                    // Trigger change event to show/hide justificante fields
                    $('#concepto').trigger('change');
                    return false; // break
                }
            });
            
            if (!conceptoEncontrado) {
                console.warn('No se encontró el concepto:', movimiento.concepto);
            }
        }
        
        // Handle specific fields based on movement type
        if (movimiento.tipo === 'banco') {
            // Show bank fields
            $('#camposBanco').show();
            $('#camposEfectivo').hide();
            
            // Set bank-specific fields
            $('#justificante_banco').val(movimiento.justificante || '');
            $('#referencia_bancaria').val(movimiento.referencia_bancaria || '');
            
            // Set bank operation type
            const esBancoGasto = movimiento.es_gasto;
            $('#tipo_operacion_banco').val(esBancoGasto ? 'gasto' : 'ingreso');
            
        } else {
            // Show cash fields
            $('#camposEfectivo').show();
            $('#camposBanco').hide();
            
            // Set cash-specific fields
            $('#justificante').val(movimiento.justificante || '');
            
            // Load money breakdown for cash movements
            loadMovimientoDesglose(movimiento.id);
        }
        
        // Trigger operation type change to show appropriate fields
        $('#tipo_operacion').trigger('change');
    }

    function loadEjercicioData() {
        const ejercicioId = $('#ejercicioSelect').val();
        
        console.log('Cargando datos para ejercicio ID:', ejercicioId);
        
        if (!ejercicioId) {
            // No ejercicio selected
            console.log('No hay ejercicio seleccionado, ocultando elementos');
            $('#movimientosContainer').hide();
            $('#sortControls').hide();
            $('#searchSection').hide();
            $('#filterControls').hide();
            $('#addMovementSection').hide();
            $('#noCajaMessage').show();
            
            // Clear caja dropdown
            const cajaSelect = $('#cajaSelect');
            cajaSelect.empty();
            cajaSelect.append('<option value="">-- Selecciona un ejercicio primero --</option>');
            
            // Clear turnos dropdown
            const turnoSelect = $('#turno');
            turnoSelect.empty();
            turnoSelect.append('<option value="">-- Selecciona un turno --</option>');
            
            // Limpiar los campos del header
            updateTotalsDisplay(0, 0, 0);
            currentMovimientos = [];
            filteredMovimientos = [];
            return;
        }

        // Update saldo display
        updateSaldoDisplay();
        
        // Set ejercicio ID in the form
        $('#ejercicioIdInput').val(ejercicioId);
        
        // Load turnos for the selected ejercicio
        loadTurnosForEjercicio(ejercicioId);
        
        // Hide no ejercicio message and show add movement section
        $('#noCajaMessage').hide();
        $('#addMovementSection').show();

        // Cargar cajas del ejercicio si el tipo de operación es efectivo
        const tipoOperacion = $('#tipo_operacion').val();
        if (tipoOperacion === 'efectivo') {
            loadCajasForEjercicio();
        }

        // Cargar todos los movimientos del ejercicio
        loadEjercicioMovimientos(ejercicioId);
    }

    function loadEjercicioMovimientos(ejercicioId) {
        console.log('Cargando movimientos para ejercicio ID:', ejercicioId);
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'ajax': 'true',
                'get_ejercicio_movimientos': 'true',
                'ejercicio_id': ejercicioId
            },
            success: function(data) {
                if (data.success) {
                    console.log('Movimientos del ejercicio cargados:', data.movimientos.length);
                    
                    // Update global variables
                    currentMovimientos = data.movimientos;
                    filteredMovimientos = [...currentMovimientos];
                    
                    // Update totals display
                    updateTotalsDisplay(data.resumen.total_ingresos, data.resumen.total_gastos, data.resumen.saldo_actual);
                    
                    // Show movements and controls
                    $('#movimientosContainer').show();
                    $('#sortControls').show();
                    $('#searchSection').show();
                    $('#filterControls').show();
                    
                    // Render movements
                    displayMovimientos(filteredMovimientos);
                    
                    showInfo(`Mostrando ${data.movimientos.length} movimientos del ejercicio ${data.ejercicio.nombre}`);
                } else {
                    showError('Error al cargar los movimientos: ' + data.error);
                    currentMovimientos = [];
                    filteredMovimientos = [];
                    updateTotalsDisplay(0, 0, 0);
                    $('#movimientosContainer').hide();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading ejercicio movimientos:', error);
                showError('Error al cargar los movimientos del ejercicio');
                currentMovimientos = [];
                filteredMovimientos = [];
                updateTotalsDisplay(0, 0, 0);
                $('#movimientosContainer').hide();
            }
        });
    }

    function loadCajasForEjercicio() {
        const ejercicioId = $('#ejercicioSelect').val();
        
        if (!ejercicioId) {
            console.log('No hay ejercicio seleccionado');
            return;
        }

        console.log('Cargando cajas para ejercicio ID:', ejercicioId);

        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'ajax': 'true',
                'get_cajas': 'true',
                'ejercicio_id': ejercicioId
            },
            success: function(data) {
                if (data.success) {
                    // Clear and populate cajas
                    data.cajas.forEach(function(caja) {
                        const disabled = !caja.activa ? 'disabled style="background-color: #eee; color: #888;"' : '';
                        const label = caja.nombre + ' (' + caja.año + ') - ' + caja.saldo_caja + '€' + (!caja.activa ? ' [INACTIVA]' : '');
                        cajaSelect.append(`<option value="${caja.id}" data-saldo="${caja.saldo_caja}" ${disabled}>${label}</option>`);
                    });
                    const cajaSelect = $('#cajaSelect');
                    cajaSelect.empty();
                    cajaSelect.append('<option value="">-- Selecciona una caja --</option>');
                    
                    console.log('Cajas cargadas:', data.cajas.length);
                } else {
                    showError('Error al cargar las cajas: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading cajas:', error);
                showError('Error al cargar las cajas');
            }
        });
    }

    function loadTurnosForEjercicio(ejercicioId, callback) {
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'ajax': 'true',
                'get_turnos': 'true',
                'ejercicio_id': ejercicioId
            },
            success: function(data) {
                if (data.success) {
                    // Clear and populate turnos
                    const turnoSelect = $('#turno');
                    turnoSelect.empty();
                    turnoSelect.append('<option value="">-- Selecciona un turno --</option>');
                    
                    data.turnos.forEach(function(turno) {
                        turnoSelect.append(`<option value="${turno.id}">${turno.nombre}</option>`);
                    });
                    
                    console.log('Turnos cargados:', data.turnos.length);
                    
                    if (callback) callback();
                } else {
                    showError('Error al cargar los turnos: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading turnos:', error);
                showError('Error al cargar los turnos');
            }
        });
    }

    function loadCajaMoneyBreakdown(cajaId) {
        console.log('Cargando desglose de caja para ID:', cajaId);
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'ajax': 'true',
                'caja_id': cajaId
            },
            success: function(data) {
                if (data.success && data.desglose_actual) {
                    console.log('Desglose de caja cargado:', data.desglose_actual);
                    
                    // Show the money breakdown section
                    $('#desgloseDineroSection').show();
                    
                    // Initialize money breakdown
                    initializeMoneyBreakdown();
                    
                    // Update available quantities with actual values
                    updateAvailableQuantities(data.desglose_actual);
                    
                    showSuccess(`Desglose de caja cargado correctamente`);
                } else {
                    console.error('Error al cargar el desglose de caja:', data.error);
                    showError('Error al cargar el desglose de la caja: ' + (data.error || 'Datos no disponibles'));
                    // Hide breakdown section if error
                    $('#desgloseDineroSection').hide();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading caja money breakdown:', error);
                showError('Error al cargar el desglose de la caja');
                // Hide breakdown section if error
                $('#desgloseDineroSection').hide();
            }
        });
    }

    function loadMovimientoDesglose(movimientoId) {
        console.log('Cargando desglose para movimiento:', movimientoId);
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'ajax': 'true',
                'get_movimiento_desglose': 'true',
                'movimiento_id': movimientoId
            },
            success: function(data) {
                if (data.success) {
                    console.log('Desglose cargado:', data.desglose);
                    
                    // Initialize money breakdown first
                    initializeMoneyBreakdown();
                    
                    // Populate the money breakdown inputs with the loaded data
                    Object.keys(data.desglose).forEach(function(denominacionId) {
                        const desglose = data.desglose[denominacionId];
                        
                        // Set entrada and salida values
                        if (desglose.cantidad_entrada > 0) {
                            $(`#entrada_${denominacionId}`).val(desglose.cantidad_entrada);
                        }
                        if (desglose.cantidad_salida > 0) {
                            $(`#salida_${denominacionId}`).val(desglose.cantidad_salida);
                        }
                        
                        console.log(`Denominación ${denominacionId}: entrada=${desglose.cantidad_entrada}, salida=${desglose.cantidad_salida}`);
                    });
                    
                    // Recalculate totals after loading the data
                    calculateMoneyTotals();
                    
                } else {
                    console.error('Error al cargar el desglose:', data.error);
                    showError('Error al cargar el desglose del movimiento: ' + data.error);
                    // Fall back to empty money breakdown
                    initializeMoneyBreakdown();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading movimiento desglose:', error);
                showError('Error al cargar el desglose del movimiento');
                // Fall back to empty money breakdown
                initializeMoneyBreakdown();
            }
        });
    }
</script>
{% endblock extrajs %}
