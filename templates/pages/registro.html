{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Registro de Movimientos {% endblock title %}

{% block extrastyle %}
<style>
    /* Estilos para el tema oscuro del modal */
    .modal-content {
        background-color: #1e1e2f !important;
        border: 1px solid #344675 !important;
        color: #fff !important;
    }
    
    .modal-header {
        border-bottom: 1px solid #344675 !important;
        background-color: #1e1e2f !important;
    }
    
    .modal-footer {
        border-top: 1px solid #344675 !important;
        background-color: #1e1e2f !important;
    }
    
    .modal-title {
        color: #fff !important;
    }
    
    /* Estilos para los campos de formulario */
    .form-control {
        background-color: #27293d !important;
        border: 1px solid #344675 !important;
        color: #fff !important;
    }
    
    .form-control:focus {
        background-color: #27293d !important;
        border-color: #51cbce !important;
        color: #fff !important;
        box-shadow: 0 0 0 0.2rem rgba(81, 203, 206, 0.25) !important;
    }
    
    .form-control::placeholder {
        color: #9ca3af !important;
        opacity: 0.8;
    }
    
    /* Estilos específicos para select */
    .form-control option {
        background-color: #27293d !important;
        color: #fff !important;
    }
    
    /* Estilos para labels */
    .form-label {
        color: #fff !important;
        font-weight: 500;
    }
    
    /* Estilos para el input-group */
    .input-group-text {
        background-color: #344675 !important;
        border-color: #344675 !important;
        color: #fff !important;
    }
    
    /* Estilos para campos de fecha */
    input[type="date"].form-control::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }
    
    /* Estilos para campos numéricos */
    input[type="number"].form-control::-webkit-outer-spin-button,
    input[type="number"].form-control::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    /* Mejorar visibilidad del botón close */
    .close {
        color: #fff !important;
        opacity: 0.8;
    }
    
    .close:hover {
        color: #fff !important;
        opacity: 1;
    }
    
    /* Estilos para los controles de ordenamiento */
    #sortControls .btn-group .btn {
        border-color: #344675 !important;
        color: #fff !important;
    }
    
    #sortControls .btn-outline-secondary {
        background-color: #27293d !important;
        border-color: #344675 !important;
        color: #fff !important;
    }
    
    #sortControls .btn-outline-secondary:hover {
        background-color: #344675 !important;
        border-color: #51cbce !important;
        color: #fff !important;
    }
    
    #sortControls .btn-primary {
        background-color: #51cbce !important;
        border-color: #51cbce !important;
        color: #1e1e2f !important;
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="tim-icons icon-wallet-43"></i>
                        Registro de Movimientos de Caja
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Selector de Caja -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cajaSelect" class="form-label">Seleccionar Caja:</label>
                                <select class="form-control" id="cajaSelect" onchange="loadMovimientos()">
                                    <option value="">-- Selecciona una caja --</option>
                                    {% for caja in cajas %}
                                        <option value="{{ caja.id }}" 
                                                data-saldo="{{ caja.saldo }}"
                                                data-nombre="{{ caja.nombre }}"
                                                {% if caja.id == selected_caja_id %}selected{% endif %}>
                                            {{ caja.nombre }} ({{ caja.año }}) - {{ caja.saldo }}€
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Saldo Actual:</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="text" class="form-control" id="saldoActual" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para añadir movimiento -->
                    <div class="row mb-3" id="addMovementSection">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addMovementModal" onclick="prepareModal()">
                                <i class="tim-icons icon-simple-add"></i>
                                Añadir Movimiento
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <div id="movimientosContainer">
                        <!-- Controles de ordenamiento -->
                        <div class="row mb-3" id="sortControls" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label">Ordenar por:</label>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('fecha')" id="sortByDate">
                                        <i class="tim-icons icon-calendar-60"></i>
                                        Fecha
                                        <span id="sortDateIcon" class="ml-1"></span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('cantidad')" id="sortByAmount">
                                        <i class="tim-icons icon-coins"></i>
                                        Cantidad
                                        <span id="sortAmountIcon" class="ml-1"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped" id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Turno</th>
                                        <th>Concepto</th>
                                        <th>Cantidad</th>
                                        <th>Justificante</th>
                                        <th>Observaciones</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Resumen -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card bg-success">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-white">Total Ingresos</h5>
                                        <h3 class="text-white" id="totalIngresos">0.00€</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-danger">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-white">Total Gastos</h5>
                                        <h3 class="text-white" id="totalGastos">0.00€</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-white">Saldo Actual</h5>
                                        <h3 class="text-white" id="saldoResumen">0.00€</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay caja seleccionada -->
                    <div id="noCajaMessage" class="text-center py-5">
                        <i class="tim-icons icon-wallet-43" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Selecciona una caja para ver sus movimientos</h4>
                        <p class="text-muted">Asegúrate de haber iniciado sesión para acceder a los datos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para añadir movimiento -->
<div class="modal fade" id="addMovementModal" tabindex="-1" aria-labelledby="addMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovementModalLabel">
                    <i class="tim-icons icon-simple-add"></i>
                    Añadir Nuevo Movimiento
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addMovementForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="caja_id" id="cajaIdInput">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="turno" class="form-label">Turno *</label>
                                <select class="form-control" name="turno" id="turno" required>
                                    <option value="">-- Selecciona un turno --</option>
                                    {% for turno in turnos %}
                                        <option value="{{ turno.id }}">{{ turno.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="concepto" class="form-label">Concepto *</label>
                                <select class="form-control" name="concepto" id="concepto" required>
                                    <option value="">-- Selecciona un concepto --</option>
                                    {% for concepto in conceptos %}
                                        <option value="{{ concepto.id }}" data-es-gasto="{{ concepto.es_gasto }}">
                                            {{ concepto.nombre }} {% if concepto.es_gasto %}(Gasto){% else %}(Ingreso){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cantidad" class="form-label">Cantidad (€) *</label>
                                <input type="number" class="form-control" name="cantidad" id="cantidad" 
                                       step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fecha" class="form-label">Fecha *</label>
                                <input type="date" class="form-control" name="fecha" id="fecha" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hora" class="form-label">Hora *</label>
                                <input type="time" class="form-control" name="hora" id="hora" 
                                       value="{% now 'H:i' %}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="justificante" class="form-label">Nº Justificante</label>
                                <input type="text" class="form-control" name="justificante" id="justificante" 
                                       maxlength="5" placeholder="12345">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" id="observaciones" 
                                  rows="3" placeholder="Observaciones adicionales (opcional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="tim-icons icon-check-2"></i>
                        Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}
{% block extrajs %}
<script>
    // Variables globales para el ordenamiento
    let currentMovimientos = [];
    let currentSortField = 'fecha';
    let currentSortOrder = 'desc'; // 'asc' o 'desc'

    $(document).ready(function () {
        console.log('Página de registro cargada');
        
        // Initialize page
        updateSaldoDisplay();
        
        // Load movements if a caja is already selected
        if ($('#cajaSelect').val()) {
            console.log('Caja ya seleccionada, cargando movimientos...');
            loadMovimientos();
        }
    });

    function updateSaldoDisplay() {
        const selectedOption = $('#cajaSelect option:selected');
        const saldo = selectedOption.data('saldo');
        
        console.log('Actualizando saldo display:', saldo, 'tipo:', typeof saldo);
        
        if (saldo !== undefined && saldo !== null && saldo !== '') {
            // Convertir a número si es necesario
            const saldoNum = parseFloat(saldo);
            if (!isNaN(saldoNum)) {
                $('#saldoActual').val(saldoNum.toFixed(2));
            } else {
                console.warn('Saldo no es un número válido:', saldo);
                $('#saldoActual').val('0.00');
            }
        } else {
            $('#saldoActual').val('');
        }
    }

    function updateSaldoFromResponse(saldoActual) {
        console.log('Actualizando saldo desde respuesta:', saldoActual);
        
        if (saldoActual !== undefined && saldoActual !== null && saldoActual !== '') {
            const saldoNum = parseFloat(saldoActual);
            if (!isNaN(saldoNum)) {
                $('#saldoActual').val(saldoNum.toFixed(2));
                // También actualizar el data attribute para futuras referencias
                $('#cajaSelect option:selected').data('saldo', saldoNum);
            }
        }
    }

    function prepareModal() {
        console.log('Preparando modal');
        const cajaId = $('#cajaSelect').val();
        
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return false;
        }
        
        // Establecer el caja_id en el formulario
        $('#cajaIdInput').val(cajaId);
        console.log('Caja ID establecido en modal:', cajaId);
        
        return true;
    }

    function loadMovimientos() {
        const cajaId = $('#cajaSelect').val();
        
        console.log('Cargando movimientos para caja ID:', cajaId);
        
        if (!cajaId) {
            // No caja selected
            console.log('No hay caja seleccionada, ocultando tabla');
            $('#movimientosContainer').hide();
            $('#sortControls').hide();
            $('#noCajaMessage').show();
            currentMovimientos = [];
            return;
        }

        // Update saldo display
        updateSaldoDisplay();
        
        // Set caja ID in the form
        $('#cajaIdInput').val(cajaId);
        
        // Hide no caja message
        $('#noCajaMessage').hide();

        // Load movements via AJAX
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'caja_id': cajaId,
                'ajax': 'true'
            },
            success: function(data) {
                console.log('Respuesta AJAX recibida:', data);
                
                if (data.success) {
                    console.log('Datos recibidos correctamente, procesando...');
                    
                    // Guardar los movimientos para el ordenamiento
                    currentMovimientos = data.movimientos;
                    
                    displayMovimientos(data.movimientos);
                    updateResumen(data.resumen);
                    
                    // Actualizar el saldo actual con el valor del resumen
                    updateSaldoFromResponse(data.resumen.saldo_actual);
                    
                    // Mostrar controles de ordenamiento si hay movimientos
                    if (data.movimientos && data.movimientos.length > 0) {
                        $('#sortControls').show();
                        updateSortButtons();
                    } else {
                        $('#sortControls').hide();
                    }
                    
                    // Asegurarse de que el contenedor se muestre
                    console.log('Mostrando contenedor de movimientos...');
                    $('#movimientosContainer').show();
                    
                    // Verificar que realmente se muestra
                    const isVisible = $('#movimientosContainer').is(':visible');
                    console.log('Contenedor visible:', isVisible);
                    
                    if (!isVisible) {
                        console.error('ERROR: El contenedor no se está mostrando');
                        $('#movimientosContainer').css('display', 'block');
                    }
                } else {
                    console.error('Error loading movements:', data.error);
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', error);
                console.error('Status:', status);
                console.error('xhr.status:', xhr.status);
                console.error('Response:', xhr.responseText);
                console.error('Response JSON:', xhr.responseJSON);
                
                if (xhr.status === 302 || xhr.status === 403) {
                    // Problemas de autenticación
                    alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                    window.location.href = '/accounts/login/';
                } else {
                    alert('Error al cargar los movimientos: ' + error);
                }
            }
        });
    }

    function displayMovimientos(movimientos) {
        console.log('=== displayMovimientos ===');
        console.log('Movimientos recibidos:', movimientos);
        
        const tbody = $('#movimientosTableBody');
        console.log('tbody encontrado:', tbody.length);
        
        if (tbody.length === 0) {
            console.error('ERROR: No se encontró el tbody con ID movimientosTableBody');
            return;
        }
        
        tbody.empty();

        if (!movimientos || movimientos.length === 0) {
            console.log('No hay movimientos, mostrando mensaje');
            tbody.append(`
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No hay movimientos registrados para esta caja
                    </td>
                </tr>
            `);
            return;
        }

        console.log('Procesando', movimientos.length, 'movimientos...');
        
        movimientos.forEach(function(mov, index) {
            console.log(`Procesando movimiento ${index + 1}:`, mov);
            
            const fechaDisplay = mov.fecha_display || new Date(mov.datetime_iso).toLocaleString('es-ES');
            const cantidadClass = mov.es_gasto ? 'text-danger' : 'text-success';
            const cantidadSign = mov.es_gasto ? '-' : '+';
            
            const row = `
                <tr>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>${fechaDisplay}</strong>
                        </div>
                    </td>
                    <td>${mov.turno}</td>
                    <td>
                        ${mov.concepto}
                        ${mov.es_gasto ? '<span class="badge badge-danger ml-1">Gasto</span>' : '<span class="badge badge-success ml-1">Ingreso</span>'}
                    </td>
                    <td class="${cantidadClass}">
                        <strong>${cantidadSign}${mov.cantidad}€</strong>
                    </td>
                    <td>${mov.justificante || '-'}</td>
                    <td>${mov.observaciones || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMovimiento(${mov.id})">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            tbody.append(row);
        });
        
        console.log('Terminé de añadir filas. Total filas ahora:', tbody.find('tr').length);
        console.log('HTML del tbody:', tbody.html());
        console.log('=== fin displayMovimientos ===');
    }

    function updateResumen(resumen) {
        console.log('Actualizando resumen:', resumen);
        
        // Proteger contra valores undefined/null
        const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
        const totalGastos = parseFloat(resumen.total_gastos) || 0;
        const saldoActual = parseFloat(resumen.saldo_actual) || 0;
        
        $('#totalIngresos').text(totalIngresos.toFixed(2) + '€');
        $('#totalGastos').text(totalGastos.toFixed(2) + '€');
        $('#saldoResumen').text(saldoActual.toFixed(2) + '€');
    }

    function deleteMovimiento(movimientoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
            return;
        }

        console.log('Eliminando movimiento ID:', movimientoId);

        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: {
                'action': 'delete',
                'movimiento_id': movimientoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                console.log('Respuesta eliminar:', data);
                if (data.success) {
                    loadMovimientos(); // Reload the table
                    alert('Movimiento eliminado correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar el movimiento: ' + error);
            }
        });
    }

    // Handle form submission
    $('#addMovementForm').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Enviando formulario de movimiento');
        
        // Verificar que hay una caja seleccionada
        const cajaId = $('#cajaSelect').val();
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return;
        }
        
        // Asegurar que el caja_id esté establecido en el formulario
        $('#cajaIdInput').val(cajaId);
        
        console.log('Caja ID:', cajaId);
        console.log('Datos del formulario:', $(this).serialize());
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: $(this).serialize() + '&action=add',
            success: function(data) {
                console.log('Respuesta guardar:', data);
                if (data.success) {
                    $('#addMovementModal').modal('hide');
                    $('#addMovementForm')[0].reset();
                    $('#fecha').val('{% now "Y-m-d" %}'); // Reset date to today
                    $('#hora').val('{% now "H:i" %}'); // Reset time to current time
                    
                    // Recargar los movimientos para obtener el saldo actualizado
                    loadMovimientos(); // Esto actualizará tanto la tabla como el saldo
                    
                    alert('Movimiento añadido correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al guardar:', error);
                console.error('Response:', xhr.responseText);
                alert('Error al guardar el movimiento: ' + error);
            }
        });
    });

    // Update concept color based on selection
    $('#concepto').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const esGasto = selectedOption.data('es-gasto');
        
        if (esGasto) {
            $(this).removeClass('border-success').addClass('border-danger');
        } else if (selectedOption.val()) {
            $(this).removeClass('border-danger').addClass('border-success');
        } else {
            $(this).removeClass('border-success border-danger');
        }
    });

    // Funciones de ordenamiento
    function sortMovimientos(field) {
        console.log('Ordenando por:', field);
        
        // Si es el mismo campo, alternar orden
        if (currentSortField === field) {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            // Nuevo campo, empezar con descendente
            currentSortField = field;
            currentSortOrder = 'desc';
        }
        
        // Ordenar los movimientos
        const sortedMovimientos = [...currentMovimientos].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case 'fecha':
                    // Usar datetime_iso para ordenamiento preciso
                    valueA = new Date(a.datetime_iso || a.fecha_completa);
                    valueB = new Date(b.datetime_iso || b.fecha_completa);
                    break;
                case 'cantidad':
                    // Calcular el valor real considerando si es gasto o ingreso
                    valueA = a.es_gasto ? -parseFloat(a.cantidad) : parseFloat(a.cantidad);
                    valueB = b.es_gasto ? -parseFloat(b.cantidad) : parseFloat(b.cantidad);
                    break;
                default:
                    return 0;
            }
            
            if (currentSortOrder === 'asc') {
                return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
            } else {
                return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
            }
        });
        
        // Actualizar display
        displayMovimientos(sortedMovimientos);
        updateSortButtons();
    }
    
    function updateSortButtons() {
        // Resetear todos los botones
        $('#sortByDate, #sortByAmount').removeClass('btn-primary').addClass('btn-outline-secondary');
        $('#sortDateIcon, #sortAmountIcon').html('');
        
        // Activar el botón actual
        let activeButton, activeIcon;
        switch (currentSortField) {
            case 'fecha':
                activeButton = '#sortByDate';
                activeIcon = '#sortDateIcon';
                break;
            case 'cantidad':
                activeButton = '#sortByAmount';
                activeIcon = '#sortAmountIcon';
                break;
        }
        
        if (activeButton) {
            $(activeButton).removeClass('btn-outline-secondary').addClass('btn-primary');
            const icon = currentSortOrder === 'asc' ? '↑' : '↓';
            $(activeIcon).html(icon);
        }
    }
</script>
{% endblock extrajs %}
