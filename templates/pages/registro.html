{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Registro de Movimientos {% endblock title %}

{% block extrastyle %}
<link href="{% static 'assets/css/registro.css' %}" rel="stylesheet" />
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="page-header">
                <h2 class="page-title">
                    <i class="tim-icons icon-wallet-43 mr-3"></i>
                    Registro de Movimientos de Caja
                </h2>
                <p class="page-subtitle">Gestiona los movimientos financieros de tu organización de forma eficiente</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- Selector de Caja -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="cajaSelect" class="form-label">Seleccionar Caja:</label>
                                <select class="form-control" id="cajaSelect" onchange="loadMovimientos()">
                                    <option value="">-- Selecciona una caja --</option>
                                    {% for caja in cajas %}
                                        <option value="{{ caja.id }}" 
                                                data-saldo="{{ caja.saldo }}"
                                                data-nombre="{{ caja.nombre }}"
                                                {% if caja.id == selected_caja_id %}selected{% endif %}>
                                            {{ caja.nombre }} ({{ caja.año }}) - {{ caja.saldo }}€
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="totals-section">
                                <div class="total-item">
                                    <span class="total-label">Ingresos</span>
                                    <div class="total-value ingresos" id="totalIngresosHeader">--</div>
                                </div>
                                <div class="total-item">
                                    <span class="total-label">Gastos</span>
                                    <div class="total-value gastos" id="totalGastosHeader">--</div>
                                </div>
                                <div class="total-item">
                                    <span class="total-label">Saldo</span>
                                    <div class="total-value saldo" id="saldoActual">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para añadir movimiento y controles de ordenamiento -->
                    <div class="row mb-3" id="addMovementSection">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addMovementModal" onclick="prepareModal()">
                                <i class="tim-icons icon-simple-add"></i>
                                Añadir Movimiento
                            </button>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center" id="sortControls" style="display: none !important;">
                            <label class="form-label mb-0 mr-3">Ordenar por:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('fecha')" id="sortByDate">
                                    <i class="tim-icons icon-calendar-60"></i>
                                    Fecha
                                    <span id="sortDateIcon" class="ml-1"></span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('cantidad')" id="sortByAmount">
                                    <i class="tim-icons icon-coins"></i>
                                    Cantidad
                                    <span id="sortAmountIcon" class="ml-1"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Buscador de movimientos -->
                    <div class="row mb-3" id="searchSection" style="display: none;">
                        <div class="col-md-12">
                            <div class="movements-search-bar">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text search-icon">
                                            <i class="tim-icons icon-zoom-split"></i>
                                        </span>
                                    </div>
                                    <input type="text" 
                                        class="form-control search-input" 
                                        id="movementsSearch" 
                                        placeholder="Buscar por concepto, cantidad, justificante o descripción..."
                                        autocomplete="off">
                                    <div class="input-group-append">
                                        <button class="btn btn-clear" type="button" id="clearSearch" style="display: none;">
                                            <i class="tim-icons icon-simple-remove"></i>
                                        </button>
                                    </div>
                                    <div class="search-results-info" id="searchResultsInfo">
                                    <i class="tim-icons icon-check-2 text-success"></i>
                                    <span class="results-count" id="resultsCount">0</span> 
                                    <span id="resultsText">resultados encontrados</span>
                            </div>
                                    </div>
                                </div>

                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <div id="movimientosContainer">
                        <div class="table-responsive">
                            <table class="table table-striped" id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Turno</th>
                                        <th>Concepto</th>
                                        <th>Descripción</th>
                                        <th>Cantidad</th>
                                        <th>Justificante</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay caja seleccionada -->
                    <div id="noCajaMessage" class="text-center py-5">
                        <i class="tim-icons icon-wallet-43" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Selecciona una caja para ver sus movimientos</h4>
                        <p class="text-muted">Asegúrate de haber iniciado sesión para acceder a los datos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para añadir movimiento -->
<div class="modal fade" id="addMovementModal" tabindex="-1" aria-labelledby="addMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovementModalLabel">
                    <i class="tim-icons icon-simple-add"></i>
                    Añadir Nuevo Movimiento
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addMovementForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="caja_id" id="cajaIdInput">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-control" name="turno" id="turno" required>
                                    <option value="">-- Selecciona un turno --</option>
                                    {% for turno in turnos %}
                                        <option value="{{ turno.id }}">{{ turno.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="concepto" class="form-label">Concepto</label>
                                <select class="form-control" name="concepto" id="concepto" required>
                                    <option value="">-- Selecciona un concepto --</option>
                                    {% for concepto in conceptos %}
                                        <option value="{{ concepto.id }}" data-es-gasto="{{ concepto.es_gasto }}">
                                            {{ concepto.nombre }} {% if concepto.es_gasto %}(Gasto){% else %}(Ingreso){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cantidad" class="form-label">Cantidad (€)</label>
                                <input type="number" class="form-control" name="cantidad" id="cantidad" 
                                       step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fecha" class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="fecha" id="fecha" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hora" class="form-label">Hora</label>
                                <input type="time" class="form-control" name="hora" id="hora" 
                                       value="{% now 'H:i' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos de justificante condicionales - Solo para gastos -->
                    <div class="justificante-fields" id="justificanteFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="justificante" class="form-label">Nº Justificante</label>
                                    <input type="text" class="form-control" name="justificante" id="justificante" 
                                           maxlength="5" placeholder="12345">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-paper"></i>
                                        Número de justificante para el gasto
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="archivo_justificante" class="form-label">Archivo Justificante</label>
                                    <input type="file" class="form-control" name="archivo_justificante" id="archivo_justificante" 
                                           accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-cloud-upload-94"></i>
                                        PDF, JPG, PNG, GIF, BMP (máx. 10MB)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" id="descripcion" 
                                  rows="3" placeholder="Descripción detallada del movimiento" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="tim-icons icon-simple-remove"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="tim-icons icon-check-2"></i>
                        Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extrajs %}
<script>
    // Variables globales para el ordenamiento
    let currentMovimientos = [];
    let filteredMovimientos = [];
    let currentSortField = 'fecha';
    let currentSortOrder = 'desc'; // 'asc' o 'desc'

    $(document).ready(function () {
        console.log('Página de registro cargada');
        
        // Initialize page
        updateSaldoDisplay();
        
        // Load movements if a caja is already selected
        if ($('#cajaSelect').val()) {
            console.log('Caja ya seleccionada, cargando movimientos...');
            loadMovimientos();
        }

        // File upload handler
        $('#archivo_justificante').on('change', function() {
            handleFileUpload(this);
        });

        // Search functionality
        $('#movementsSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase().trim();
            
            if (searchTerm === '') {
                // Si no hay búsqueda, mostrar todos los movimientos
                $('#clearSearch').hide();
                filteredMovimientos = [...currentMovimientos];
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, false);
            } else {
                // Filtrar movimientos
                $('#clearSearch').show();
                filteredMovimientos = currentMovimientos.filter(mov => {
                    return mov.concepto.toLowerCase().includes(searchTerm) ||
                           mov.cantidad.toString().includes(searchTerm) ||
                           (mov.justificante && mov.justificante.toLowerCase().includes(searchTerm)) ||
                           (mov.descripcion && mov.descripcion.toLowerCase().includes(searchTerm)) ||
                           mov.turno.toLowerCase().includes(searchTerm);
                });
                
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, true);
            }
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#movementsSearch').val('');
            $(this).hide();
            filteredMovimientos = [...currentMovimientos];
            displayMovimientos(filteredMovimientos);
            updateSearchResults(filteredMovimientos.length, false);
        });
    });

    // Function to handle file upload display
    function handleFileUpload(input) {
        const file = input.files[0];
        const $fileGroup = $(input).closest('.form-group');
        
        // Remove any existing file display
        $fileGroup.find('.file-display').remove();
        
        if (file) {
            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.');
                $(input).val('');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Tipo de archivo no permitido. Solo se permiten archivos PDF, JPG, PNG, GIF y BMP.');
                $(input).val('');
                return;
            }
            
            // Create file display element
            const fileDisplay = $(`
                <div class="file-display mt-3">
                    <div class="file-container d-flex align-items-center justify-content-between p-3" style="
                        background: linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%);
                        border: 2px solid rgba(81, 203, 206, 0.3);
                        border-radius: 12px;
                        transition: all 0.3s ease;
                    ">
                        <div class="file-info d-flex align-items-center">
                            <i class="tim-icons icon-attach-87 mr-3" style="
                                color: #51cbce;
                                font-size: 1.2rem;
                            "></i>
                            <div>
                                <div class="file-name" style="
                                    color: #fff;
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                    margin-bottom: 2px;
                                ">${file.name}</div>
                                <div class="file-size" style="
                                    color: rgba(156, 163, 175, 0.8);
                                    font-size: 0.8rem;
                                ">${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-file" style="
                            border-radius: 8px;
                            padding: 6px 12px;
                            font-size: 0.8rem;
                            transition: all 0.3s ease;
                        ">
                            <i class="tim-icons icon-simple-remove"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            `);
            
            // Add hover effects
            fileDisplay.find('.file-container').hover(
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.15) 0%, rgba(81, 203, 206, 0.08) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.5)'
                    });
                },
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.3)'
                    });
                }
            );
            
            // Add remove functionality with proper event handling
            fileDisplay.find('.remove-file').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Clear the file input
                $(input).val('');
                
                // Remove the display with animation
                fileDisplay.fadeOut(300, function() {
                    $(this).remove();
                });
                
                return false;
            });
            
            // Prevent the file container from triggering file input
            fileDisplay.find('.file-container').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            // Insert after the small text
            $fileGroup.find('small.form-text').after(fileDisplay);
            
            // Add entrance animation
            fileDisplay.hide().fadeIn(300);
        }
    }

    // Function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateSaldoDisplay() {
        const selectedOption = $('#cajaSelect option:selected');
        const saldo = selectedOption.data('saldo');
        
        console.log('Actualizando saldo display:', saldo, 'tipo:', typeof saldo);
        
        if (saldo !== undefined && saldo !== null && saldo !== '') {
            // Convertir a número si es necesario
            const saldoNum = parseFloat(saldo);
            if (!isNaN(saldoNum)) {
                $('#saldoActual').text(saldoNum.toFixed(2) + '€');
            } else {
                console.warn('Saldo no es un número válido:', saldo);
                $('#saldoActual').text('0.00€');
            }
            // Limpiar los totales hasta que se carguen los movimientos
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
        } else {
            $('#saldoActual').text('--');
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
        }
    }

    function updateSaldoFromResponse(resumen) {
        console.log('Actualizando valores desde respuesta:', resumen);
        
        if (resumen) {
            const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
            const totalGastos = parseFloat(resumen.total_gastos) || 0;
            const saldoActual = parseFloat(resumen.saldo_actual) || 0;
            
            $('#totalIngresosHeader').text(totalIngresos.toFixed(2) + '€');
            $('#totalGastosHeader').text(totalGastos.toFixed(2) + '€');
            $('#saldoActual').text(saldoActual.toFixed(2) + '€');
            
            // También actualizar el data attribute para futuras referencias
            $('#cajaSelect option:selected').data('saldo', saldoActual);
        }
    }
    
    function prepareModal() {
        console.log('Preparando modal');
        const cajaId = $('#cajaSelect').val();
        
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return false;
        }
        
        // Establecer el caja_id en el formulario
        $('#cajaIdInput').val(cajaId);
        console.log('Caja ID establecido en modal:', cajaId);
        
        // Resetear el formulario y estilos
        resetModalForm();
        
        return true;
    }

    function resetModalForm() {
        console.log('Reseteando formulario del modal');
        
        // Reset form fields
        $('#addMovementForm')[0].reset();
        
        // Reset date and time to current values
        $('#fecha').val('{% now "Y-m-d" %}');
        $('#hora').val('{% now "H:i" %}');
        
        // Reset concept field styles
        $('#concepto').removeClass('border-success border-warning');
        
        // Hide justificante fields
        $('#justificanteFields').hide();
        
        // Clear justificante values
        $('#justificante').val('');
        $('#archivo_justificante').val('');
        
        // Remove file display if exists
        $('.file-display').remove();
        
        console.log('Formulario reseteado completamente');
    }

    function loadMovimientos() {
        const cajaId = $('#cajaSelect').val();
        
        console.log('Cargando movimientos para caja ID:', cajaId);
        
        if (!cajaId) {
            // No caja selected
            console.log('No hay caja seleccionada, ocultando tabla');
            $('#movimientosContainer').hide();
            $('#sortControls').hide();
            $('#searchSection').hide();
            $('#noCajaMessage').show();
            // Limpiar los campos del header
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
            $('#saldoActual').text('--');
            currentMovimientos = [];
            filteredMovimientos = [];
            return;
        }

        // Update saldo display
        updateSaldoDisplay();
        
        // Set caja ID in the form
        $('#cajaIdInput').val(cajaId);
        
        // Hide no caja message
        $('#noCajaMessage').hide();

        // Load movements via AJAX
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'caja_id': cajaId,
                'ajax': 'true'
            },
            success: function(data) {
                console.log('Respuesta AJAX recibida:', data);
                
                if (data.success) {
                    console.log('Datos recibidos correctamente, procesando...');
                    
                    // Guardar los movimientos para el ordenamiento
                    currentMovimientos = data.movimientos;
                    filteredMovimientos = [...currentMovimientos];
                    
                    // Limpiar búsqueda
                    $('#movementsSearch').val('');
                    $('#clearSearch').hide();
                    
                    displayMovimientos(data.movimientos);
                    updateResumen(data.resumen);
                    
                    // Actualizar los campos del header con el resumen
                    updateSaldoFromResponse(data.resumen);
                    
                    // Mostrar controles si hay movimientos
                    if (data.movimientos && data.movimientos.length > 0) {
                        $('#sortControls').show();
                        $('#searchSection').show();
                        updateSortButtons();
                        updateSearchResults(data.movimientos.length, false);
                    } else {
                        $('#sortControls').hide();
                        $('#searchSection').hide();
                    }
                    
                    // Asegurarse de que el contenedor se muestre
                    console.log('Mostrando contenedor de movimientos...');
                    $('#movimientosContainer').show();
                    
                    // Verificar que realmente se muestra
                    const isVisible = $('#movimientosContainer').is(':visible');
                    console.log('Contenedor visible:', isVisible);
                    
                    if (!isVisible) {
                        console.error('ERROR: El contenedor no se está mostrando');
                        $('#movimientosContainer').css('display', 'block');
                    }
                } else {
                    console.error('Error loading movements:', data.error);
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', error);
                console.error('Status:', status);
                console.error('xhr.status:', xhr.status);
                console.error('Response:', xhr.responseText);
                console.error('Response JSON:', xhr.responseJSON);
                
                if (xhr.status === 302 || xhr.status === 403) {
                    // Problemas de autenticación
                    alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                    window.location.href = '/accounts/login/';
                } else {
                    alert('Error al cargar los movimientos: ' + error);
                }
            }
        });
    }

    function displayMovimientos(movimientos) {
        console.log('=== displayMovimientos ===');
        console.log('Movimientos recibidos:', movimientos);
        
        const tbody = $('#movimientosTableBody');
        console.log('tbody encontrado:', tbody.length);
        
        if (tbody.length === 0) {
            console.error('ERROR: No se encontró el tbody con ID movimientosTableBody');
            return;
        }
        
        tbody.empty();

        if (!movimientos || movimientos.length === 0) {
            console.log('No hay movimientos, mostrando mensaje');
            tbody.append(`
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No hay movimientos registrados para esta caja
                    </td>
                </tr>
            `);
            return;
        }

        console.log('Procesando', movimientos.length, 'movimientos...');
        
        movimientos.forEach(function(mov, index) {
            console.log(`Procesando movimiento ${index + 1}:`, mov);
            
            const fechaDisplay = mov.fecha_display || new Date(mov.datetime_iso).toLocaleString('es-ES');
            const cantidadClass = mov.es_gasto ? 'text-danger' : 'text-success';
            const cantidadSign = mov.es_gasto ? '-' : '+';
            
            const row = `
                <tr>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>${fechaDisplay}</strong>
                        </div>
                    </td>
                    <td>${mov.turno}</td>
                    <td>
                        ${mov.concepto}
                        ${mov.es_gasto ? '<span class="badge badge-danger ml-1">Gasto</span>' : '<span class="badge badge-success ml-1">Ingreso</span>'}
                    </td>
                    <td>${mov.descripcion || '-'}</td>
                    <td class="${cantidadClass}">
                        <strong>${cantidadSign}${mov.cantidad}€</strong>
                    </td>
                    <td>${mov.justificante || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMovimiento(${mov.id})">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            tbody.append(row);
        });
        
        console.log('Terminé de añadir filas. Total filas ahora:', tbody.find('tr').length);
        console.log('HTML del tbody:', tbody.html());
        console.log('=== fin displayMovimientos ===');
    }

    function updateResumen(resumen) {
        console.log('Actualizando resumen:', resumen);
        
        // Proteger contra valores undefined/null
        const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
        const totalGastos = parseFloat(resumen.total_gastos) || 0;
        const saldoActual = parseFloat(resumen.saldo_actual) || 0;
        
        $('#totalIngresos').text(totalIngresos.toFixed(2) + '€');
        $('#totalGastos').text(totalGastos.toFixed(2) + '€');
        $('#saldoResumen').text(saldoActual.toFixed(2) + '€');
    }

    function deleteMovimiento(movimientoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
            return;
        }

        console.log('Eliminando movimiento ID:', movimientoId);

        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: {
                'action': 'delete',
                'movimiento_id': movimientoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                console.log('Respuesta eliminar:', data);
                if (data.success) {
                    loadMovimientos(); // Reload the table
                    alert('Movimiento eliminado correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar el movimiento: ' + error);
            }
        });
    }

    // Handle form submission
    $('#addMovementForm').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Enviando formulario de movimiento');
        
        // Verificar que hay una caja seleccionada
        const cajaId = $('#cajaSelect').val();
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return;
        }
        
        // Asegurar que el caja_id esté establecido en el formulario
        $('#cajaIdInput').val(cajaId);
        
        console.log('Caja ID:', cajaId);
        
        // Create FormData object to handle file upload
        const formData = new FormData(this);
        formData.append('action', 'add');
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                console.log('Respuesta guardar:', data);
                if (data.success) {
                    $('#addMovementModal').modal('hide');
                    $('#addMovementForm')[0].reset();
                    $('#fecha').val('{% now "Y-m-d" %}'); // Reset date to today
                    $('#hora').val('{% now "H:i" %}'); // Reset time to current time
                    
                    // Hide justificante fields after reset
                    $('#justificanteGroup').hide();
                    $('#justificanteFields').hide();
                    
                    // Recargar los movimientos para obtener el saldo actualizado
                    loadMovimientos(); // Esto actualizará tanto la tabla como los campos del header
                    
                    alert('Movimiento añadido correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al guardar:', error);
                console.error('Response:', xhr.responseText);
                alert('Error al guardar el movimiento: ' + error);
            }
        });
    });

    // Update concept color based on selection and show/hide justificante fields
    $('#concepto').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const esGasto = selectedOption.data('es-gasto') === "True";
        
        console.log('Concepto seleccionado:', selectedOption.text(), 'Es gasto:', esGasto);
        
        if (esGasto) {
            // Es un gasto - mostrar campos de justificante
            $(this).removeClass('border-success').addClass('border-warning');
            $('#justificanteFields').removeClass('d-none').addClass('show').show();
            console.log('Mostrando campos de justificante para gasto');
        } else if (selectedOption.val()) {
            // Es un ingreso - ocultar campos de justificante
            $(this).removeClass('border-warning').addClass('border-success');
            $('#justificanteFields').removeClass('show');
            setTimeout(() => {
                $('#justificanteFields').hide();
            }, 400); // Esperar a que termine la animación
            // Limpiar valores de justificante
            $('#justificante').val('');
            $('#archivo_justificante').val('');
            $('.file-display').remove(); // Remove file display
            console.log('Ocultando campos de justificante para ingreso');
        } else {
            // No hay selección - ocultar campos y resetear estilos
            $(this).removeClass('border-success border-warning');
            $('#justificanteFields').removeClass('show');
            setTimeout(() => {
                $('#justificanteFields').hide();
            }, 400); // Esperar a que termine la animación
            $('#justificante').val('');
            $('#archivo_justificante').val('');
            $('.file-display').remove(); // Remove file display
            console.log('Sin selección - ocultando campos');
        }
    });

    function sortMovimientos(field) {
        console.log('Ordenando por:', field);
        
        // Si es el mismo campo, cambiar orden, sino usar descendente por defecto
        if (currentSortField === field) {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortOrder = 'desc';
        }
        
        // Ordenar los movimientos
        filteredMovimientos.sort(function(a, b) {
            let valueA, valueB;
            
            if (field === 'fecha') {
                valueA = new Date(a.datetime_iso);
                valueB = new Date(b.datetime_iso);
            } else if (field === 'cantidad') {
                valueA = parseFloat(a.cantidad);
                valueB = parseFloat(b.cantidad);
            }
            
            if (currentSortOrder === 'asc') {
                return valueA > valueB ? 1 : -1;
            } else {
                return valueA < valueB ? 1 : -1;
            }
        });
        
        // Mostrar los movimientos ordenados
        displayMovimientos(filteredMovimientos);
        
        // Actualizar los botones
        updateSortButtons();
    }

    function updateSortButtons() {
        // Resetear todos los botones
        $('#sortByDate, #sortByAmount').removeClass('btn-primary').addClass('btn-outline-secondary');
        $('#sortDateIcon, #sortAmountIcon').html('');
        
        // Activar el botón actual
        let activeButton, activeIcon;
        switch (currentSortField) {
            case 'fecha':
                activeButton = '#sortByDate';
                activeIcon = '#sortDateIcon';
                break;
            case 'cantidad':
                activeButton = '#sortByAmount';
                activeIcon = '#sortAmountIcon';
                break;
        }
        
        if (activeButton) {
            $(activeButton).removeClass('btn-outline-secondary').addClass('btn-primary');
            const icon = currentSortOrder === 'asc' ? '↑' : '↓';
            $(activeIcon).html(icon);
        }
    }
    

    function updateSearchResults(count, isSearching) {
        $('#resultsCount').text(count);
        
        if (isSearching) {
            $('#resultsText').text(count === 1 ? 'resultado encontrado' : 'resultados encontrados');
            $('#searchResultsInfo').removeClass('text-muted').addClass(count > 0 ? 'text-success' : 'text-warning');
            $('#searchResultsInfo i').removeClass('tim-icons icon-check-2').addClass(
                count > 0 ? 'tim-icons icon-check-2' : 'tim-icons icon-alert-circle-exc'
            );
        } else {
            $('#resultsText').text('movimientos en total');
            $('#searchResultsInfo').removeClass('text-success text-warning').addClass('text-muted');
            $('#searchResultsInfo i').removeClass().addClass('tim-icons icon-check-2');
        }
    }
</script>
{% endblock extrajs %}
