{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Registro de Movimientos {% endblock title %}

{% block extrastyle %}
<link href="{% static 'assets/css/registro.css' %}" rel="stylesheet" />
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="page-header">
                <h2 class="page-title">
                    <i class="tim-icons icon-wallet-43 mr-3"></i>
                    Registro de Movimientos de Caja
                </h2>
                <p class="page-subtitle">Gestiona los movimientos financieros de tu organización de forma eficiente</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- Selector de Caja -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="cajaSelect" class="form-label">Seleccionar Caja:</label>
                                <select class="form-control" id="cajaSelect" onchange="loadMovimientos()">
                                    <option value="">-- Selecciona una caja --</option>
                                    {% for caja in cajas %}
                                        <option value="{{ caja.id }}" 
                                                data-saldo="{{ caja.saldo }}"
                                                data-nombre="{{ caja.nombre }}"
                                                {% if caja.id == selected_caja_id %}selected{% endif %}>
                                            {{ caja.nombre }} ({{ caja.año }}) - {{ caja.saldo }}€
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="totals-section">
                                <div class="total-item">
                                    <span class="total-label">Ingresos</span>
                                    <div class="total-value ingresos" id="totalIngresosHeader">--</div>
                                </div>
                                <div class="total-item">
                                    <span class="total-label">Gastos</span>
                                    <div class="total-value gastos" id="totalGastosHeader">--</div>
                                </div>
                                <div class="total-item">
                                    <span class="total-label">Saldo</span>
                                    <div class="total-value saldo" id="saldoActual">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para añadir movimiento y controles de ordenamiento -->
                    <div class="row mb-3" id="addMovementSection" style="display: none;">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addMovementModal" onclick="prepareModal()">
                                <i class="tim-icons icon-simple-add"></i>
                                Añadir Movimiento
                            </button>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center" id="sortControls" style="display: none !important;">
                            <label class="form-label mb-0 mr-3">Ordenar por:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('fecha')" id="sortByDate">
                                    <i class="tim-icons icon-calendar-60"></i>
                                    Fecha
                                    <span id="sortDateIcon" class="ml-1"></span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="sortMovimientos('cantidad')" id="sortByAmount">
                                    <i class="tim-icons icon-coins"></i>
                                    Cantidad
                                    <span id="sortAmountIcon" class="ml-1"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Buscador de movimientos -->
                    <div class="row mb-3" id="searchSection" style="display: none;">
                        <div class="col-md-12">
                            <div class="movements-search-bar">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text search-icon">
                                            <i class="tim-icons icon-zoom-split"></i>
                                        </span>
                                    </div>
                                    <input type="text" 
                                        class="form-control search-input" 
                                        id="movementsSearch" 
                                        placeholder="Buscar por concepto, cantidad, justificante o descripción..."
                                        autocomplete="off">
                                    <div class="input-group-append">
                                        <button class="btn btn-clear" type="button" id="clearSearch" style="display: none;">
                                            <i class="tim-icons icon-simple-remove"></i>
                                        </button>
                                    </div>
                                    <div class="search-results-info" id="searchResultsInfo">
                                    <i class="tim-icons icon-check-2 text-success"></i>
                                    <span class="results-count" id="resultsCount">0</span> 
                                    <span id="resultsText">resultados encontrados</span>
                            </div>
                                    </div>
                                </div>

                        </div>
                    </div>

                    <!-- Tabla de Movimientos -->
                    <div id="movimientosContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Turno</th>
                                        <th>Concepto</th>
                                        <th>Descripción</th>
                                        <th>Cantidad</th>
                                        <th>Justificante</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay caja seleccionada -->
                    <div id="noCajaMessage" class="text-center py-5">
                        <i class="tim-icons icon-wallet-43" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Selecciona una caja para ver sus movimientos</h4>
                        <p class="text-muted">Asegúrate de haber iniciado sesión para acceder a los datos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para añadir movimiento -->
<div class="modal fade" id="addMovementModal" tabindex="-1" aria-labelledby="addMovementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovementModalLabel">
                    <i class="tim-icons icon-simple-add"></i>
                    Añadir Nuevo Movimiento
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addMovementForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="caja_id" id="cajaIdInput">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-control" name="turno" id="turno" required>
                                    <option value="">-- Selecciona un turno --</option>
                                    {% for turno in turnos %}
                                        <option value="{{ turno.id }}">{{ turno.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="concepto" class="form-label">Concepto</label>
                                <select class="form-control" name="concepto" id="concepto" required>
                                    <option value="">-- Selecciona un concepto --</option>
                                    {% for concepto in conceptos %}
                                        <option value="{{ concepto.id }}" data-es-gasto="{{ concepto.es_gasto }}">
                                            {{ concepto.nombre }} {% if concepto.es_gasto %}(Gasto){% else %}(Ingreso){% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cantidad" class="form-label">Cantidad (€)</label>
                                <input type="number" class="form-control" name="cantidad" id="cantidad" 
                                       step="0.01" min="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fecha" class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="fecha" id="fecha" 
                                       value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="hora" class="form-label">Hora</label>
                                <input type="time" class="form-control" name="hora" id="hora" 
                                       value="{% now 'H:i' %}" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos de justificante condicionales - Solo para gastos -->
                    <div class="justificante-fields" id="justificanteFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="justificante" class="form-label">Nº Justificante</label>
                                    <input type="text" class="form-control" name="justificante" id="justificante" 
                                           maxlength="5" placeholder="12345">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-paper"></i>
                                        Número de justificante para el gasto
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="archivo_justificante" class="form-label">Archivo Justificante</label>
                                    <input type="file" class="form-control" name="archivo_justificante" id="archivo_justificante" 
                                           accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp">
                                    <small class="form-text text-muted">
                                        <i class="tim-icons icon-cloud-upload-94"></i>
                                        PDF, JPG, PNG, GIF, BMP (máx. 10MB)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" id="descripcion" 
                                  rows="3" placeholder="Descripción detallada del movimiento" required></textarea>
                    </div>
                    
                    <!-- Sección de desglose de billetes y monedas -->
                    <div class="desglose-dinero-section" id="desgloseDineroSection">
                        <h6 class="section-title">
                            <i class="tim-icons icon-coins mr-2"></i>
                            Desglose de Billetes y Monedas
                            <small class="text-danger">(Obligatorio)</small>
                        </h6>
                        <p class="section-description">
                            <strong>Especifica la cantidad exacta de cada billete y moneda que entra y sale de la caja.</strong>
                            El total debe coincidir exactamente con la cantidad del movimiento.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="money-breakdown-container">
                                    <div class="row">
                                        <!-- Billetes -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-paper mr-1"></i>
                                                Billetes
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Monedas -->
                                        <div class="col-md-6">
                                            <h7 class="money-type-title">
                                                <i class="tim-icons icon-coins mr-1"></i>
                                                Monedas
                                            </h7>
                                            <div class="money-items">
                                                {% for denominacion in denominaciones %}
                                                    {% if not denominacion.es_billete %}
                                                        <div class="money-item" data-valor="{{ denominacion.valor }}">
                                                            <div class="money-label">
                                                                {{ denominacion.valor }}€
                                                                <div class="available-quantity" id="available_{{ denominacion.id }}">
                                                                    <i class="tim-icons icon-bullet-list-67"></i>
                                                                    <span class="quantity-text">Disponible: --</span>
                                                                </div>
                                                            </div>
                                                            <div class="money-inputs">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text">+</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input entrada-input" 
                                                                           name="entrada_{{ denominacion.id }}" 
                                                                           id="entrada_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="entrada">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">-</span>
                                                                    </div>
                                                                    <input type="number" 
                                                                           class="form-control money-input salida-input" 
                                                                           name="salida_{{ denominacion.id }}" 
                                                                           id="salida_{{ denominacion.id }}"
                                                                           placeholder="0" 
                                                                           min="0" 
                                                                           max="0"
                                                                           data-denominacion="{{ denominacion.id }}"
                                                                           data-valor="{{ denominacion.valor }}"
                                                                           data-tipo="salida"
                                                                           data-available="0">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Totales del desglose -->
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="desglose-totals">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="total-box total-entrada">
                                                            <div class="total-label">Total Entrada</div>
                                                            <div class="total-value" id="totalEntrada">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-salida">
                                                            <div class="total-label">Total Salida</div>
                                                            <div class="total-value" id="totalSalida">0.00€</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="total-box total-neto">
                                                            <div class="total-label">Total Neto</div>
                                                            <div class="total-value" id="totalNeto">0.00€</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="desglose-actions mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="calcularDesdeTotal">
                                                        <i class="tim-icons icon-refresh-01"></i>
                                                        Calcular desde total
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="limpiarDesglose">
                                                        <i class="tim-icons icon-simple-remove"></i>
                                                        Limpiar desglose
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="tim-icons icon-simple-remove"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="tim-icons icon-check-2"></i>
                        Guardar Movimiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extrajs %}
<script>
    // Variables globales para el ordenamiento
    let currentMovimientos = [];
    let filteredMovimientos = [];
    let currentSortField = 'fecha';
    let currentSortOrder = 'desc'; // 'asc' o 'desc'

    $(document).ready(function () {
        console.log('Página de registro cargada');
        
        // Initialize page
        updateSaldoDisplay();
        
        // Load movements if a caja is already selected
        if ($('#cajaSelect').val()) {
            console.log('Caja ya seleccionada, cargando movimientos...');
            loadMovimientos();
        }

        // File upload handler
        $('#archivo_justificante').on('change', function() {
            handleFileUpload(this);
        });

        // Search functionality
        $('#movementsSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase().trim();
            
            if (searchTerm === '') {
                // Si no hay búsqueda, mostrar todos los movimientos
                $('#clearSearch').hide();
                filteredMovimientos = [...currentMovimientos];
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, false);
            } else {
                // Filtrar movimientos
                $('#clearSearch').show();
                filteredMovimientos = currentMovimientos.filter(mov => {
                    return mov.concepto.toLowerCase().includes(searchTerm) ||
                           mov.cantidad.toString().includes(searchTerm) ||
                           (mov.justificante && mov.justificante.toLowerCase().includes(searchTerm)) ||
                           (mov.descripcion && mov.descripcion.toLowerCase().includes(searchTerm)) ||
                           mov.turno.toLowerCase().includes(searchTerm);
                });
                
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, true);
            }
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#movementsSearch').val('');
            $(this).hide();
            filteredMovimientos = [...currentMovimientos];
            displayMovimientos(filteredMovimientos);
            updateSearchResults(filteredMovimientos.length, false);
        });
    });

    // Function to handle file upload display
    function handleFileUpload(input) {
        const file = input.files[0];
        const $fileGroup = $(input).closest('.form-group');
        
        // Remove any existing file display
        $fileGroup.find('.file-display').remove();
        
        if (file) {
            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.');
                $(input).val('');
                return;
            }
            
            // Validate file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Tipo de archivo no permitido. Solo se permiten archivos PDF, JPG, PNG, GIF y BMP.');
                $(input).val('');
                return;
            }
            
            // Create file display element
            const fileDisplay = $(`
                <div class="file-display mt-3">
                    <div class="d-flex align-items-center justify-content-between p-3" style="
                        background: linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%);
                        border: 2px solid rgba(81, 203, 206, 0.3);
                        border-radius: 12px;
                        transition: all 0.3s ease;
                    ">
                        <div class="d-flex align-items-center">
                            <i class="tim-icons icon-attach-87 mr-3" style="
                                color: #51cbce;
                                font-size: 1.2rem;
                            "></i>
                            <div>
                                <div class="file-name" style="
                                    color: #fff;
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                    margin-bottom: 2px;
                                ">${file.name}</div>
                                <div class="file-size" style="
                                    color: rgba(156, 163, 175, 0.8);
                                    font-size: 0.8rem;
                                ">${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-file" style="
                            border-radius: 8px;
                            padding: 6px 12px;
                            font-size: 0.8rem;
                            transition: all 0.3s ease;
                        ">
                            <i class="tim-icons icon-simple-remove"></i>
                            Cambiar
                        </button>
                    </div>
                </div>
            `);
            
            // Add hover effects
            fileDisplay.find('.d-flex').hover(
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.15) 0%, rgba(81, 203, 206, 0.08) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.5)'
                    });
                },
                function() {
                    $(this).css({
                        'background': 'linear-gradient(135deg, rgba(81, 203, 206, 0.1) 0%, rgba(81, 203, 206, 0.05) 100%)',
                        'border-color': 'rgba(81, 203, 206, 0.3)'
                    });
                }
            );
            
            // Add remove functionality
            fileDisplay.find('.remove-file').on('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                $(input).val('');
                fileDisplay.fadeOut(300, function() {
                    $(this).remove();
                });
            });
            
            // Insert after the input
            $fileGroup.find('small.form-text').after(fileDisplay);
            
            // Add entrance animation
            fileDisplay.hide().fadeIn(300);
        }
    }

    // Function to format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updateSaldoDisplay() {
        const selectedOption = $('#cajaSelect option:selected');
        const saldo = selectedOption.data('saldo');
        
        console.log('Actualizando saldo display:', saldo, 'tipo:', typeof saldo);
        
        if (saldo !== undefined && saldo !== null && saldo !== '') {
            // Convertir a número si es necesario
            const saldoNum = parseFloat(saldo);
            if (!isNaN(saldoNum)) {
                $('#saldoActual').text(saldoNum.toFixed(2) + '€');
            } else {
                console.warn('Saldo no es un número válido:', saldo);
                $('#saldoActual').text('0.00€');
            }
            // Limpiar los totales hasta que se carguen los movimientos
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
        } else {
            $('#saldoActual').text('--');
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
        }
    }

    function updateSaldoFromResponse(resumen) {
        console.log('Actualizando valores desde respuesta:', resumen);
        
        if (resumen) {
            const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
            const totalGastos = parseFloat(resumen.total_gastos) || 0;
            const saldoActual = parseFloat(resumen.saldo_actual) || 0;
            
            $('#totalIngresosHeader').text(totalIngresos.toFixed(2) + '€');
            $('#totalGastosHeader').text(totalGastos.toFixed(2) + '€');
            $('#saldoActual').text(saldoActual.toFixed(2) + '€');
            
            // También actualizar el data attribute para futuras referencias
            $('#cajaSelect option:selected').data('saldo', saldoActual);
        }
    }
    
    function prepareModal() {
        console.log('Preparando modal');
        const cajaId = $('#cajaSelect').val();
        
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return false;
        }
        
        // Establecer el caja_id en el formulario
        $('#cajaIdInput').val(cajaId);
        console.log('Caja ID establecido en modal:', cajaId);
        
        // Resetear el formulario y estilos
        resetModalForm();
        
        return true;
    }

    function resetModalForm() {
        console.log('Reseteando formulario del modal');
        
        // Reset form fields
        $('#addMovementForm')[0].reset();
        
        // Reset date and time to current values
        $('#fecha').val('{% now "Y-m-d" %}');
        $('#hora').val('{% now "H:i" %}');
        
        // Reset concept field styles
        $('#concepto').removeClass('border-success border-warning');
        
        // Hide justificante fields
        $('#justificanteFields').hide();
        
        // Clear justificante values
        $('#justificante').val('');
        $('#archivo_justificante').val('');
        
        // Remove file display if exists
        $('.file-display').remove();
        
        // Limpiar el desglose de dinero y validaciones
        clearMoneyBreakdown();
        
        // Reset validación de desglose
        $('#totalNeto').parent().removeClass('border border-warning border-success');
        
        // Limpiar mensajes temporales
        $('.temp-message').remove();
        $('.calculation-message').remove(); // Limpiar mensajes de cálculo
        
        // Resetear estilos de validación en inputs
        $('.money-input').removeClass('exceeds-available');
        
        console.log('Formulario reseteado completamente');
    }

    function loadMovimientos() {
        const cajaId = $('#cajaSelect').val();
        
        console.log('Cargando movimientos para caja ID:', cajaId);
        
        if (!cajaId) {
            // No caja selected
            console.log('No hay caja seleccionada, ocultando elementos');
            $('#movimientosContainer').hide();
            $('#sortControls').hide();
            $('#searchSection').hide();
            $('#addMovementSection').hide();
            $('#noCajaMessage').show();
            // Limpiar los campos del header
            $('#totalIngresosHeader').text('--');
            $('#totalGastosHeader').text('--');
            $('#saldoActual').text('--');
            currentMovimientos = [];
            filteredMovimientos = [];
            return;
        }

        // Update saldo display
        updateSaldoDisplay();
        
        // Set caja ID in the form
        $('#cajaIdInput').val(cajaId);
        
        // Hide no caja message and show add movement section
        $('#noCajaMessage').hide();
        $('#addMovementSection').show();

        // Load movements via AJAX
        $.ajax({
            url: '{% url "registro" %}',
            method: 'GET',
            data: {
                'caja_id': cajaId,
                'ajax': 'true'
            },
            success: function(data) {
                console.log('Respuesta AJAX recibida:', data);
                
                if (data.success) {
                    console.log('Datos recibidos correctamente, procesando...');
                    
                    // Guardar los movimientos para el ordenamiento
                    currentMovimientos = data.movimientos;
                    filteredMovimientos = [...currentMovimientos];
                    
                    // Limpiar búsqueda
                    $('#movementsSearch').val('');
                    $('#clearSearch').hide();
                    
                    displayMovimientos(data.movimientos);
                    updateResumen(data.resumen);
                    
                    // Actualizar los campos del header con el resumen
                    updateSaldoFromResponse(data.resumen);
                    
                    // Actualizar cantidades disponibles en el formulario
                    updateAvailableQuantities(data.desglose_actual || {});
                    
                    // Mostrar controles si hay movimientos
                    if (data.movimientos && data.movimientos.length > 0) {
                        $('#sortControls').show();
                        $('#searchSection').show();
                        updateSortButtons();
                        updateSearchResults(data.movimientos.length, false);
                    } else {
                        $('#sortControls').hide();
                        $('#searchSection').hide();
                    }
                    
                    // Asegurarse de que el contenedor se muestre
                    console.log('Mostrando contenedor de movimientos...');
                    $('#movimientosContainer').show();
                    
                    // Verificar que realmente se muestra
                    const isVisible = $('#movimientosContainer').is(':visible');
                    console.log('Contenedor visible:', isVisible);
                    
                    if (!isVisible) {
                        console.error('ERROR: El contenedor no se está mostrando');
                        $('#movimientosContainer').css('display', 'block');
                    }
                } else {
                    console.error('Error loading movements:', data.error);
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', error);
                console.error('Status:', status);
                console.error('xhr.status:', xhr.status);
                console.error('Response:', xhr.responseText);
                console.error('Response JSON:', xhr.responseJSON);
                
                if (xhr.status === 302 || xhr.status === 403) {
                    // Problemas de autenticación
                    alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                    window.location.href = '/accounts/login/';
                } else {
                    alert('Error al cargar los movimientos: ' + error);
                }
            }
        });
    }

    function displayMovimientos(movimientos) {
        console.log('=== displayMovimientos ===');
        console.log('Movimientos recibidos:', movimientos);
        
        const tbody = $('#movimientosTableBody');
        console.log('tbody encontrado:', tbody.length);
        
        if (tbody.length === 0) {
            console.error('ERROR: No se encontró el tbody con ID movimientosTableBody');
            return;
        }
        
        tbody.empty();

        if (!movimientos || movimientos.length === 0) {
            console.log('No hay movimientos, mostrando mensaje');
            tbody.append(`
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No hay movimientos registrados para esta caja
                    </td>
                </tr>
            `);
            return;
        }

        console.log('Procesando', movimientos.length, 'movimientos...');
        
        movimientos.forEach(function(mov, index) {
            console.log(`Procesando movimiento ${index + 1}:`, mov);
            
            const fechaDisplay = mov.fecha_display || new Date(mov.datetime_iso).toLocaleString('es-ES');
            const cantidadClass = mov.es_gasto ? 'text-danger' : 'text-success';
            const cantidadSign = mov.es_gasto ? '-' : '+';
            
            const row = `
                <tr>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>${fechaDisplay}</strong>
                        </div>
                    </td>
                    <td>${mov.turno}</td>
                    <td>
                        ${mov.concepto}
                        ${mov.es_gasto ? '<span class="badge badge-danger ml-1">Gasto</span>' : '<span class="badge badge-success ml-1">Ingreso</span>'}
                    </td>
                    <td>${mov.descripcion || '-'}</td>
                    <td class="${cantidadClass}">
                        <strong>${cantidadSign}${mov.cantidad}€</strong>
                    </td>
                    <td>${mov.justificante || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMovimiento(${mov.id})">
                            <i class="tim-icons icon-simple-remove"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            tbody.append(row);
        });
        
        console.log('Terminé de añadir filas. Total filas ahora:', tbody.find('tr').length);
        console.log('HTML del tbody:', tbody.html());
        console.log('=== fin displayMovimientos ===');
    }

    function updateResumen(resumen) {
        console.log('Actualizando resumen:', resumen);
        
        // Proteger contra valores undefined/null
        const totalIngresos = parseFloat(resumen.total_ingresos) || 0;
        const totalGastos = parseFloat(resumen.total_gastos) || 0;
        const saldoActual = parseFloat(resumen.saldo_actual) || 0;
        
        $('#totalIngresos').text(totalIngresos.toFixed(2) + '€');
        $('#totalGastos').text(totalGastos.toFixed(2) + '€');
        $('#saldoResumen').text(saldoActual.toFixed(2) + '€');
    }

    function deleteMovimiento(movimientoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este movimiento?')) {
            return;
        }

        console.log('Eliminando movimiento ID:', movimientoId);

        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: {
                'action': 'delete',
                'movimiento_id': movimientoId,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(data) {
                console.log('Respuesta eliminar:', data);
                if (data.success) {
                    loadMovimientos(); // Reload the table
                    alert('Movimiento eliminado correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar el movimiento: ' + error);
            }
        });
    }

    // Handle form submission
    $('#addMovementForm').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Enviando formulario de movimiento');
        
        // Verificar que hay una caja seleccionada
        const cajaId = $('#cajaSelect').val();
        if (!cajaId) {
            alert('Por favor selecciona una caja antes de añadir un movimiento');
            return;
        }
        
        // =============================================================================
        // VALIDACIÓN COMPLETA DEL DESGLOSE ANTES DEL ENVÍO
        // =============================================================================
        
        const validationResult = validateCompleteMoneyBreakdown();
        if (!validationResult.valid) {
            alert(validationResult.error);
            return;
        }

        // Asegurar que el caja_id esté establecido en el formulario
        $('#cajaIdInput').val(cajaId);
        
        console.log('Caja ID:', cajaId);
        console.log('Desglose validado correctamente');
        
        // Create FormData object to handle file upload
        const formData = new FormData(this);
        formData.append('action', 'add');
        
        $.ajax({
            url: '{% url "registro" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                console.log('Respuesta guardar:', data);
                if (data.success) {
                    $('#addMovementModal').modal('hide');
                    resetModalForm(); // Usar la función de reset más completa
                    
                    // Recargar los movimientos para obtener el saldo actualizado
                    loadMovimientos(); // Esto actualizará tanto la tabla como los campos del header
                    
                    alert('Movimiento añadido correctamente');
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al guardar:', error);
                console.error('Response:', xhr.responseText);
                alert('Error al guardar el movimiento: ' + error);
            }
        });
    });

    // Update concept color based on selection and show/hide justificante fields
    $('#concepto').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const esGasto = selectedOption.data('es-gasto') === "True";
        
        console.log('Concepto seleccionado:', selectedOption.text(), 'Es gasto:', esGasto);
        
        if (esGasto) {
            // Es un gasto - mostrar campos de justificante
            $(this).removeClass('border-success').addClass('border-warning');
            $('#justificanteFields').removeClass('d-none').addClass('show').show();
            console.log('Mostrando campos de justificante para gasto');
        } else if (selectedOption.val()) {
            // Es un ingreso - ocultar campos de justificante
            $(this).removeClass('border-warning').addClass('border-success');
            $('#justificanteFields').removeClass('show');
            setTimeout(() => {
                $('#justificanteFields').hide();
            }, 400); // Esperar a que termine la animación
            // Limpiar valores de justificante
            $('#justificante').val('');
            $('#archivo_justificante').val('');
            $('.file-display').remove(); // Remove file display
            console.log('Ocultando campos de justificante para ingreso');
        } else {
            // No hay selección - ocultar campos y resetear estilos
            $(this).removeClass('border-success border-warning');
            $('#justificanteFields').removeClass('show');
            setTimeout(() => {
                $('#justificanteFields').hide();
            }, 400); // Esperar a que termine la animación
            $('#justificante').val('');
            $('#archivo_justificante').val('');
            $('.file-display').remove(); // Remove file display
            console.log('Sin selección - ocultando campos');
        }
    });

    function sortMovimientos(field) {
        console.log('Ordenando por:', field);
        
        // Si es el mismo campo, cambiar orden, sino usar descendente por defecto
        if (currentSortField === field) {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortOrder = 'desc';
        }
        
        // Ordenar los movimientos
        filteredMovimientos.sort(function(a, b) {
            let valueA, valueB;
            
            if (field === 'fecha') {
                valueA = new Date(a.datetime_iso);
                valueB = new Date(b.datetime_iso);
            } else if (field === 'cantidad') {
                valueA = parseFloat(a.cantidad);
                valueB = parseFloat(b.cantidad);
            }
            
            if (currentSortOrder === 'asc') {
                return valueA > valueB ? 1 : -1;
            } else {
                return valueA < valueB ? 1 : -1;
            }
        });
        
        // Mostrar los movimientos ordenados
        displayMovimientos(filteredMovimientos);
        
        // Actualizar los botones
        updateSortButtons();
    }

    function updateSortButtons() {
        // Resetear todos los botones
        $('#sortByDate, #sortByAmount').removeClass('btn-primary').addClass('btn-outline-secondary');
        $('#sortDateIcon, #sortAmountIcon').html('');
        
        // Activar el botón actual
        let activeButton, activeIcon;
        switch (currentSortField) {
            case 'fecha':
                activeButton = '#sortByDate';
                activeIcon = '#sortDateIcon';
                break;
            case 'cantidad':
                activeButton = '#sortByAmount';
                activeIcon = '#sortAmountIcon';
                break;
        }
        
        if (activeButton) {
            $(activeButton).removeClass('btn-outline-secondary').addClass('btn-primary');
            const icon = currentSortOrder === 'asc' ? '↑' : '↓';
            $(activeIcon).html(icon);
        }
    }
    
    function validateCompleteMoneyBreakdown() {
        
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        
        if (cantidadMovimiento <= 0) {
            return {
                valid: false,
                error: 'Por favor, ingresa una cantidad válida para el movimiento.'
            };
        }
        
        // Verificar que hay al menos una entrada en el desglose
        let tieneDesglose = false;
        $('.money-input').each(function() {
            if (parseInt($(this).val()) > 0) {
                tieneDesglose = true;
                return false; // break
            }
        });
        
        if (!tieneDesglose) {
            return {
                valid: false,
                error: 'ERROR: El desglose de billetes y monedas es obligatorio. Por favor, especifica la cantidad exacta de cada denominación que entra y sale de la caja.'
            };
        }
        
        // Verificar que los totales coincidan
        const totales = calculateMoneyTotals();
        let valorCalculado = totales.neto;
        const esGasto = $('#concepto option:selected').data('es-gasto') === "True";

        
        if (esGasto) {
            if (valorCalculado > 0) {
                return {
                    valid: false,
                    error: 'ERROR: El desglose no puede ser positivo para un gasto. Por favor, verifica las cantidades.'
                };
            }
            valorCalculado = -valorCalculado; // Invertir el valor para gastos
        } else {
            if (valorCalculado < 0) {
                return {
                    valid: false,
                    error: 'ERROR: El desglose no puede ser negativo para un ingreso. Por favor, verifica las cantidades.'
                };
            }
        }

        const diferencia = Math.abs(valorCalculado - cantidadMovimiento);
        const tolerance = 0.01; // Tolerancia de 1 céntimo
        
        if (diferencia > tolerance) {
            return {
                valid: false,
                error: `ERROR: El desglose (${totales.neto.toFixed(2)}€) no coincide con la cantidad del movimiento (${cantidadMovimiento.toFixed(2)}€). Diferencia: ${diferencia.toFixed(2)}€. El desglose debe ser exacto.`
            };
        }
        
        return {
            valid: true,
            error: null
        };
    }
    
    // Funciones para el desglose de billetes y monedas
    function initializeMoneyBreakdown() {
        // Event listeners para los inputs de dinero
        $('.money-input').on('input', function() {
            calculateMoneyTotals();
            validateMoneyBreakdown();
        });
        
        // Event listeners específicos para validación de entradas y salidas
        $('.entrada-input').on('input blur', function() {
            validateEntradaInput(this);
        });
        
        $('.salida-input').on('input blur', function() {
            validateSalidaInput(this);
        });
        
        // Validación adicional en tiempo real para inputs de salida que exceden cantidad
        $('.salida-input').on('input', function() {
            const $input = $(this);
            const value = parseInt($input.val()) || 0;
            const available = parseInt($input.data('available')) || 0;
            
            // Validación visual inmediata sin corregir el valor aún
            if (value > available && available >= 0) {
                $input.addClass('exceeds-available');
                $input.closest('.money-item').addClass('has-error');
            } else {
                $input.removeClass('exceeds-available');
                $input.closest('.money-item').removeClass('has-error');
            }
        });
        
        // Prevenir pegado de valores negativos
        $('.money-input').on('paste', function(e) {
            setTimeout(() => {
                const value = parseInt($(this).val()) || 0;
                if (value < 0) {
                    $(this).val(0);
                    showTemporaryMessage($(this), 'No se permiten valores negativos', 'warning');
                }
                
                // Validar límites si es salida
                if ($(this).hasClass('salida-input')) {
                    validateSalidaInput(this);
                }
                
                calculateMoneyTotals();
                validateMoneyBreakdown();
            }, 100);
        });
        
        // Botón para calcular desde total
        $('#calcularDesdeTotal').on('click', function() {
            calculateFromTotal();
        });
        
        // Botón para limpiar desglose
        $('#limpiarDesglose').on('click', function() {
            clearMoneyBreakdown();
        });
        
        // Calcular totales inicial
        calculateMoneyTotals();
    }
    
    function calculateMoneyTotals() {
        let totalEntrada = 0;
        let totalSalida = 0;
        
        $('.entrada-input').each(function() {
            const cantidad = parseInt($(this).val()) || 0;
            const valor = parseFloat($(this).data('valor'));
            totalEntrada += cantidad * valor;
        });
        
        $('.salida-input').each(function() {
            const cantidad = parseInt($(this).val()) || 0;
            const valor = parseFloat($(this).data('valor'));
            totalSalida += cantidad * valor;
        });
        
        const totalNeto = totalEntrada - totalSalida;
        
        $('#totalEntrada').text(totalEntrada.toFixed(2) + '€');
        $('#totalSalida').text(totalSalida.toFixed(2) + '€');
        $('#totalNeto').text(totalNeto.toFixed(2) + '€');
        
        // Actualizar el color del total neto
        const $totalNeto = $('#totalNeto');
        $totalNeto.removeClass('text-success text-danger text-info');
        if (totalNeto > 0) {
            $totalNeto.addClass('text-success');
        } else if (totalNeto < 0) {
            $totalNeto.addClass('text-danger');
        } else {
            $totalNeto.addClass('text-info');
        }
        
        return {
            entrada: totalEntrada,
            salida: totalSalida,
            neto: totalNeto
        };
    }
    
    function validateMoneyBreakdown() {
        // VALIDACIÓN PRINCIPAL DEL DESGLOSE
        // Esta función verifica que el desglose coincida exactamente con la cantidad del movimiento
        
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        const totales = calculateMoneyTotals();
        
        // Verificar si el total neto coincide con la cantidad del movimiento
        const diferencia = Math.abs(totales.neto - cantidadMovimiento);
        const tolerance = 0.01; // Tolerancia de 1 céntimo
        
        const $totalNeto = $('#totalNeto').parent();
        $totalNeto.removeClass('border border-warning border-success');
        
        if (cantidadMovimiento > 0) {
            if (diferencia <= tolerance) {
                // Coincide exactamente - mostrar como correcto
                $totalNeto.addClass('border border-success');
            } else {
                // No coincide - mostrar como error
                $totalNeto.addClass('border border-warning');
            }
        }
        
        // Retornar si la validación es correcta (será usado en el submit del formulario)
        return diferencia <= tolerance;
    }
    
    function calculateFromTotal() {
        const cantidadMovimiento = parseFloat($('#cantidad').val()) || 0;
        
        if (cantidadMovimiento <= 0) {
            alert('Por favor, primero ingresa la cantidad total del movimiento.');
            return;
        }
        
        // Verificar si hay un concepto seleccionado para determinar si es gasto o ingreso
        const conceptoSeleccionado = $('#concepto option:selected');
        if (!conceptoSeleccionado.val()) {
            alert('Por favor, primero selecciona un concepto para determinar si es gasto o ingreso.');
            return;
        }
        
        const esGasto = conceptoSeleccionado.data('es-gasto') === "True";
        const tipoInput = esGasto ? 'salida' : 'entrada';
        
        // Limpiar el desglose actual
        clearMoneyBreakdown();
        
        // Obtener denominaciones disponibles ordenadas de mayor a menor
        const denominaciones = [];
        $(`.money-input[data-tipo="${tipoInput}"]`).each(function() {
            const cantidadDisponible = esGasto ? 
                (parseInt($(this).data('available')) || 0) : 
                999999; // Para ingresos, no hay límite
            
            if (cantidadDisponible > 0) {
                denominaciones.push({
                    id: $(this).data('denominacion'),
                    valor: parseFloat($(this).data('valor')),
                    elemento: $(this),
                    disponible: cantidadDisponible
                });
            }
        });
        
        denominaciones.sort((a, b) => b.valor - a.valor);
        
        // Calcular el total disponible para gastos
        let totalDisponible = 0;
        if (esGasto) {
            denominaciones.forEach(denom => {
                totalDisponible += denom.valor * denom.disponible;
            });
        }
        
        let remainingAmount = cantidadMovimiento;
        let cantidadDistribuida = 0;
        const distribucion = [];
        
        // Calcular automáticamente la distribución respetando cantidades disponibles
        denominaciones.forEach(denom => {
            if (remainingAmount >= denom.valor && denom.disponible > 0) {
                const cantidadIdeal = Math.floor(remainingAmount / denom.valor);
                const cantidadUsada = Math.min(cantidadIdeal, denom.disponible);
                
                if (cantidadUsada > 0) {
                    denom.elemento.val(cantidadUsada);
                    const valorUsado = cantidadUsada * denom.valor;
                    remainingAmount -= valorUsado;
                    cantidadDistribuida += valorUsado;
                    remainingAmount = Math.round(remainingAmount * 100) / 100; // Evitar errores de punto flotante
                    
                    distribucion.push({
                        valor: denom.valor,
                        cantidad: cantidadUsada,
                        total: valorUsado
                    });
                }
            }
        });
        
        // SI ES GASTO Y NO SE PUEDE HACER EXACTO, INTENTAR CON CAMBIO
        if (esGasto && remainingAmount > 0.01 && totalDisponible >= cantidadMovimiento) {
            console.log('Intentando calcular con cambio...');
            
            // Limpiar el desglose previo
            clearMoneyBreakdown();
            
            // Intentar encontrar una combinación que permita dar el vuelto
            const resultadoConCambio = calculateWithChange(cantidadMovimiento, denominaciones);
            
            if (resultadoConCambio.success) {
                // Aplicar la distribución calculada (salidas)
                resultadoConCambio.distribucion.forEach(item => {
                    const elemento = denominaciones.find(d => d.valor === item.valor)?.elemento;
                    if (elemento) {
                        elemento.val(item.cantidad);
                    }
                });
                
                // AGREGAR EL CAMBIO COMO ENTRADA
                if (resultadoConCambio.cambio > 0.01) {
                    addChangeAsIncome(resultadoConCambio.cambio);
                }
                
                calculateMoneyTotals();
                validateMoneyBreakdown();
                
                // Mostrar mensaje de éxito con información del cambio
                showCalculationWithChange(resultadoConCambio);
                return;
            }
        }
        
        calculateMoneyTotals();
        validateMoneyBreakdown();
        
        // Verificar si se pudo alcanzar la cantidad exacta
        if (remainingAmount > 0.01) { // Tolerancia de 1 céntimo
            const porcentajeAlcanzado = ((cantidadDistribuida / cantidadMovimiento) * 100).toFixed(1);
            
            if (esGasto && totalDisponible < cantidadMovimiento) {
                // No hay suficiente dinero total en la caja
                let mensaje = `❌ No hay suficiente dinero en la caja para realizar este gasto.\n\n`;
                mensaje += `💰 Total disponible en caja: ${totalDisponible.toFixed(2)}€\n`;
                mensaje += `💸 Cantidad del gasto: ${cantidadMovimiento.toFixed(2)}€\n`;
                mensaje += `📉 Faltan: ${(cantidadMovimiento - totalDisponible).toFixed(2)}€\n\n`;
                mensaje += `💡 Sugerencias:\n`;
                mensaje += `• Añade más dinero a la caja\n`;
                mensaje += `• Reduce la cantidad del gasto\n`;
                mensaje += `• Realiza el gasto en varias transacciones`;
                
                alert(mensaje);
                showInsufficientFunds(totalDisponible, cantidadMovimiento);
            } else {
                // Hay dinero suficiente pero no se puede hacer exacto
                let mensaje = `⚠️ No se puede alcanzar la cantidad exacta de ${cantidadMovimiento.toFixed(2)}€ con las denominaciones disponibles en la caja.\n\n`;
                mensaje += `💰 Cantidad distribuida: ${cantidadDistribuida.toFixed(2)}€ (${porcentajeAlcanzado}%)\n`;
                mensaje += `📉 Cantidad faltante: ${remainingAmount.toFixed(2)}€\n\n`;
                
                if (distribucion.length > 0) {
                    mensaje += `📊 Distribución calculada:\n`;
                    distribucion.forEach(item => {
                        mensaje += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
                    });
                    mensaje += '\n';
                }
                
                if (esGasto) {
                    mensaje += `💡 Sugerencias:\n`;
                    mensaje += `• Verifica que hay suficientes billetes/monedas en la caja\n`;
                    mensaje += `• Considera realizar el gasto en varias transacciones\n`;
                    mensaje += `• Ajusta la cantidad del movimiento a ${cantidadDistribuida.toFixed(2)}€`;
                } else {
                    mensaje += `💡 Nota: Para ingresos, siempre puedes especificar manualmente las denominaciones exactas que ingresan.`;
                }
                
                alert(mensaje);
                
                // Opcional: resaltar visualmente que el cálculo está incompleto
                $('#totalNeto').parent().removeClass('border-success').addClass('border border-warning');
                
                // Mostrar mensaje temporal en la interfaz
                showCalculationWarning(cantidadDistribuida, remainingAmount, cantidadMovimiento);
            }
        } else {
            // Cálculo exitoso
            const mensaje = `✅ Cantidad distribuida correctamente: ${cantidadMovimiento.toFixed(2)}€\n\n📊 Distribución:\n`;
            let detalleDistribucion = '';
            distribucion.forEach(item => {
                detalleDistribucion += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
            });
            
            console.log(mensaje + detalleDistribucion);
            
            // Mostrar mensaje de éxito temporal
            showCalculationSuccess(cantidadMovimiento);
        }
    }
    
    function clearMoneyBreakdown() {
        $('.money-input').val('');
        $('.money-input').removeClass('exceeds-available');
        $('.temp-message').remove();
        $('.calculation-message').remove(); // Limpiar todos los tipos de mensajes de cálculo
        $('#totalNeto').parent().removeClass('border border-warning border-success'); // Resetear estilos de validación
        calculateMoneyTotals();
    }
    
    function showCalculationWarning(cantidadDistribuida, cantidadFaltante, cantidadTotal) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const porcentaje = ((cantidadDistribuida / cantidadTotal) * 100).toFixed(1);
        
        const $message = $(`
            <div class="calculation-message alert alert-warning mt-3 mb-0" style="border-left: 4px solid #f39c12;">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-alert-circle-exc mr-3 mt-1" style="color: #f39c12; font-size: 1.2rem;"></i>
                    <div>
                        <h6 class="mb-2">⚠️ Distribución incompleta</h6>
                        <p class="mb-2">
                            <strong>Distribuido:</strong> ${cantidadDistribuida.toFixed(2)}€ (${porcentaje}%) <br>
                            <strong>Faltante:</strong> ${cantidadFaltante.toFixed(2)}€
                        </p>
                        <small class="text-muted">
                            No hay suficientes denominaciones disponibles en la caja para alcanzar la cantidad exacta.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 10 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 10000);
    }
    
    function showCalculationSuccess(cantidadTotal) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const $message = $(`
            <div class="calculation-message alert alert-success mt-3 mb-0" style="border-left: 4px solid #00d4aa;">
                <div class="d-flex align-items-center">
                    <i class="tim-icons icon-check-2 mr-3" style="color: #00d4aa; font-size: 1.2rem;"></i>
                    <div>
                        <strong>✅ Distribución completada correctamente</strong>
                        <br>
                        <small class="text-muted">Cantidad total: ${cantidadTotal.toFixed(2)}€</small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 5000);
    }
    
    function calculateWithChange(cantidadObjetivo, denominacionesDisponibles) {
        // Esta función intenta encontrar una combinación que permita pagar con cambio
        console.log('Calculando con cambio para:', cantidadObjetivo);
        
        // Ordenar denominaciones de mayor a menor
        const denomsOrdenadas = [...denominacionesDisponibles].sort((a, b) => b.valor - a.valor);
        
        // Intentar con diferentes estrategias empezando por billetes grandes
        for (let estrategia = 0; estrategia < 3; estrategia++) {
            const resultado = tryPaymentStrategy(cantidadObjetivo, denomsOrdenadas, estrategia);
            if (resultado.success) {
                return resultado;
            }
        }
        
        return { success: false };
    }
    
    function tryPaymentStrategy(cantidadObjetivo, denominaciones, estrategia) {
        let mejorResultado = { success: false, exceso: Infinity };
        
        // Estrategia 0: Usar billetes grandes primero
        // Estrategia 1: Usar combinaciones medias
        // Estrategia 2: Probar todas las combinaciones posibles (limitada)
        
        function buscarCombinacion(indice, acumulado, distribucionActual) {
            if (indice >= denominaciones.length) {
                if (acumulado >= cantidadObjetivo) {
                    const exceso = acumulado - cantidadObjetivo;
                    if (exceso < mejorResultado.exceso) {
                        mejorResultado = {
                            success: true,
                            exceso: exceso,
                            totalPagado: acumulado,
                            distribucion: [...distribucionActual],
                            cambio: exceso
                        };
                    }
                }
                return;
            }
            
            const denom = denominaciones[indice];
            const maxCantidad = Math.min(denom.disponible, 
                estrategia === 0 ? Math.ceil((cantidadObjetivo * 1.5) / denom.valor) : denom.disponible
            );
            
            // Probar diferentes cantidades de esta denominación
            for (let cantidad = 0; cantidad <= maxCantidad; cantidad++) {
                const nuevoAcumulado = acumulado + (cantidad * denom.valor);
                
                // Poda: si ya excedemos mucho, no seguir
                if (nuevoAcumulado > cantidadObjetivo * 2) break;
                
                if (cantidad > 0) {
                    distribucionActual.push({
                        valor: denom.valor,
                        cantidad: cantidad,
                        total: cantidad * denom.valor
                    });
                }
                
                buscarCombinacion(indice + 1, nuevoAcumulado, distribucionActual);
                
                if (cantidad > 0) {
                    distribucionActual.pop();
                }
                
                // Si encontramos una solución perfecta en estrategia 0, parar
                if (estrategia === 0 && mejorResultado.success && mejorResultado.exceso < 0.01) {
                    break;
                }
            }
        }
        
        buscarCombinacion(0, 0, []);
        return mejorResultado;
    }
    
    function showCalculationWithChange(resultado) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const $message = $(`
            <div class="calculation-message alert alert-info mt-3 mb-0" style="border-left: 4px solid #17a2b8;">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-coins mr-3 mt-1" style="color: #17a2b8; font-size: 1.2rem;"></i>
                    <div>
                        <h6 class="mb-2">💰 Pago calculado con cambio</h6>
                        <p class="mb-2">
                            <strong>Gasto real:</strong> ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€<br>
                            <strong>Total pagado (salida):</strong> ${resultado.totalPagado.toFixed(2)}€<br>
                            <strong>Cambio recibido (entrada):</strong> <span class="text-success">+${resultado.cambio.toFixed(2)}€</span>
                        </p>
                        <div class="mb-2">
                            <strong>Distribución de salida:</strong><br>
                            ${resultado.distribucion.map(item => 
                                `<small>• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€</small>`
                            ).join('<br>')}<br>
                            <strong>Cambio añadido automáticamente como entrada</strong>
                        </div>
                        <small class="text-muted">
                            <i class="tim-icons icon-bulb-63"></i>
                            El desglose refleja el movimiento completo: salida del pago y entrada del cambio.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 12 segundos (más tiempo por ser más información)
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 12000);
        
        // También mostrar un alert más detallado
        let alertMsg = `💰 Pago calculado con cambio - Desglose completo\n\n`;
        alertMsg += `💸 Gasto real: ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€\n`;
        alertMsg += `💵 Total pagado (SALIDA): ${resultado.totalPagado.toFixed(2)}€\n`;
        alertMsg += `💚 Cambio recibido (ENTRADA): +${resultado.cambio.toFixed(2)}€\n\n`;
        alertMsg += `📊 Distribución de salida:\n`;
        resultado.distribucion.forEach(item => {
            alertMsg += `• ${item.cantidad} × ${item.valor.toFixed(2)}€ = ${item.total.toFixed(2)}€\n`;
        });
        alertMsg += `\n� El cambio se ha añadido automáticamente como entrada en el desglose.\n`;
        alertMsg += `📝 El total neto coincidirá exactamente con el gasto real de ${(resultado.totalPagado - resultado.cambio).toFixed(2)}€`;
        
        alert(alertMsg);
    }
    
    function showInsufficientFunds(totalDisponible, cantidadRequerida) {
        // Remover mensajes anteriores
        $('.calculation-message').remove();
        
        const faltante = cantidadRequerida - totalDisponible;
        
        const $message = $(`
            <div class="calculation-message alert alert-danger mt-3 mb-0" style="border-left: 4px solid #dc3545;">
                <div class="d-flex align-items-start">
                    <i class="tim-icons icon-simple-remove mr-3 mt-1" style="color: #dc3545; font-size: 1.2rem;"></i>
                    <div>
                        <h6 class="mb-2">❌ Fondos insuficientes</h6>
                        <p class="mb-2">
                            <strong>Disponible en caja:</strong> ${totalDisponible.toFixed(2)}€<br>
                            <strong>Cantidad requerida:</strong> ${cantidadRequerida.toFixed(2)}€<br>
                            <strong>Faltante:</strong> <span class="text-danger">${faltante.toFixed(2)}€</span>
                        </p>
                        <small class="text-muted">
                            <i class="tim-icons icon-alert-circle-exc"></i>
                            No hay suficiente dinero en la caja para realizar este gasto.
                        </small>
                    </div>
                </div>
            </div>
        `);
        
        $('#desgloseDineroSection').append($message);
        
        // Auto-remover después de 8 segundos
        setTimeout(() => {
            $message.fadeOut(500, function() {
                $(this).remove();
            });
        }, 8000);
    }
    
    function addChangeAsIncome(cantidadCambio) {
        console.log('Añadiendo cambio como entrada:', cantidadCambio);
        
        // Obtener todas las denominaciones de entrada ordenadas de mayor a menor
        const denominacionesEntrada = [];
        $('.entrada-input').each(function() {
            denominacionesEntrada.push({
                valor: parseFloat($(this).data('valor')),
                elemento: $(this)
            });
        });
        
        denominacionesEntrada.sort((a, b) => b.valor - a.valor);
        
        let remainingChange = cantidadCambio;
        const distribucionCambio = [];
        
        // Distribuir el cambio usando denominaciones grandes primero
        denominacionesEntrada.forEach(denom => {
            if (remainingChange >= denom.valor) {
                const cantidad = Math.floor(remainingChange / denom.valor);
                if (cantidad > 0) {
                    // Obtener el valor actual del input y sumarle la nueva cantidad
                    const valorActual = parseInt(denom.elemento.val()) || 0;
                    const nuevaCanidad = valorActual + cantidad;
                    
                    denom.elemento.val(nuevaCanidad);
                    
                    const valorUsado = cantidad * denom.valor;
                    remainingChange -= valorUsado;
                    remainingChange = Math.round(remainingChange * 100) / 100; // Evitar errores de punto flotante
                    
                    distribucionCambio.push({
                        valor: denom.valor,
                        cantidad: cantidad,
                        total: valorUsado
                    });
                }
            }
        });
        
        // Si queda algo residual (centimos), añadirlo a la denominación más pequeña disponible
        if (remainingChange > 0.001) {
            console.warn('Cambio residual no distribuido:', remainingChange);
            // Buscar la denominación más pequeña para el residual
            const denomMenor = denominacionesEntrada[denominacionesEntrada.length - 1];
            if (denomMenor && denomMenor.valor <= remainingChange * 2) {
                const valorActual = parseInt(denomMenor.elemento.val()) || 0;
                denomMenor.elemento.val(valorActual + 1);
                distribucionCambio.push({
                    valor: denomMenor.valor,
                    cantidad: 1,
                    total: denomMenor.valor,
                    nota: 'Ajuste por redondeo'
                });
            }
        }
        
        console.log('Distribución del cambio:', distribucionCambio);
        return distribucionCambio;
    }
    
    // Actualizar el ready function para inicializar el desglose
    $(document).ready(function () {
        console.log('Página de registro cargada');
        
        // Initialize page
        updateSaldoDisplay();
        
        // Initialize money breakdown
        initializeMoneyBreakdown();
        
        // Load movements if a caja is already selected
        if ($('#cajaSelect').val()) {
            console.log('Caja ya seleccionada, cargando movimientos...');
            loadMovimientos();
        }

        // File upload handler
        $('#archivo_justificante').on('change', function() {
            handleFileUpload(this);
        });

        // Search functionality
        $('#movementsSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase().trim();
            
            if (searchTerm === '') {
                // Si no hay búsqueda, mostrar todos los movimientos
                $('#clearSearch').hide();
                filteredMovimientos = [...currentMovimientos];
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, false);
            } else {
                // Filtrar movimientos
                $('#clearSearch').show();
                filteredMovimientos = currentMovimientos.filter(mov => {
                    return mov.concepto.toLowerCase().includes(searchTerm) ||
                           mov.cantidad.toString().includes(searchTerm) ||
                           (mov.justificante && mov.justificante.toLowerCase().includes(searchTerm)) ||
                           (mov.descripcion && mov.descripcion.toLowerCase().includes(searchTerm)) ||
                           mov.turno.toLowerCase().includes(searchTerm);
                });
                
                displayMovimientos(filteredMovimientos);
                updateSearchResults(filteredMovimientos.length, true);
            }
        });

        // Clear search
        $('#clearSearch').on('click', function() {
            $('#movementsSearch').val('');
            $(this).hide();
            filteredMovimientos = [...currentMovimientos];
            displayMovimientos(filteredMovimientos);
            updateSearchResults(filteredMovimientos.length, false);
        });
        
        // Event listener para el campo cantidad para validar desglose
        $('#cantidad').on('input', function() {
            validateMoneyBreakdown();
        });
    });

    function updateSearchResults(count, isSearching) {
        $('#resultsCount').text(count);
        
        if (isSearching) {
            $('#resultsText').text(count === 1 ? 'resultado encontrado' : 'resultados encontrados');
            $('#searchResultsInfo').removeClass('text-muted').addClass(count > 0 ? 'text-success' : 'text-warning');
            $('#searchResultsInfo i').removeClass('tim-icons icon-check-2').addClass(
                count > 0 ? 'tim-icons icon-check-2' : 'tim-icons icon-alert-circle-exc'
            );
        } else {
            $('#resultsText').text('movimientos en total');
            $('#searchResultsInfo').removeClass('text-success text-warning').addClass('text-muted');
            $('#searchResultsInfo i').removeClass().addClass('tim-icons icon-check-2');
        }
    }

    // =============================================================================
    // RESUMEN DE VALIDACIONES CENTRALIZADAS
    // =============================================================================
    // Todas las validaciones del desglose de dinero están centralizadas en este archivo:
    // - validateCompleteMoneyBreakdown(): Validación completa para submit del formulario
    // - validateMoneyBreakdown(): Validación visual en tiempo real
    // - calculateMoneyTotals(): Cálculo de totales para validaciones
    // 
    // Las validaciones duplicadas en models.py y views.py han sido eliminadas.
    // =============================================================================

    // =============================================================================
    // GESTIÓN DE CANTIDADES DISPONIBLES
    // =============================================================================
    
    function updateAvailableQuantities(desgloseActual) {
        console.log('Actualizando cantidades disponibles:', desgloseActual);
        
        // Actualizar todas las denominaciones
        $('.money-item').each(function() {
            const denominacionId = $(this).find('.salida-input').data('denominacion');
            const $availableDisplay = $(this).find('.available-quantity');
            const $salidaInput = $(this).find('.salida-input');
            const $moneyItem = $(this);
            
            if (desgloseActual[denominacionId]) {
                const cantidad = desgloseActual[denominacionId].cantidad;
                
                // Actualizar el display según la cantidad
                if (cantidad === 0) {
                    $availableDisplay.find('.quantity-text').text('Sin unidades');
                    $availableDisplay.addClass('no-available').removeClass('has-available');
                } else {
                    $availableDisplay.find('.quantity-text').text(`Disponible: ${cantidad}`);
                    $availableDisplay.removeClass('no-available').addClass('has-available');
                }
                
                // Actualizar el max del input de salida
                $salidaInput.attr('max', cantidad);
                $salidaInput.data('available', cantidad);
                
                // Validar si el valor actual excede lo disponible
                const currentValue = parseInt($salidaInput.val()) || 0;
                if (currentValue > cantidad) {
                    $salidaInput.val(cantidad);
                    $salidaInput.addClass('exceeds-available');
                    $moneyItem.addClass('has-error');
                    showTemporaryMessage($salidaInput, `Cantidad ajustada al máximo disponible: ${cantidad}`, 'exceeds-warning');
                } else {
                    $salidaInput.removeClass('exceeds-available');
                    $moneyItem.removeClass('has-error');
                }
            } else {
                // No hay cantidad disponible
                $availableDisplay.find('.quantity-text').text('Sin unidades disponibles');
                $availableDisplay.addClass('no-available').removeClass('has-available');
                $salidaInput.attr('max', 0);
                $salidaInput.data('available', 0);
                $salidaInput.val('');
                $salidaInput.removeClass('exceeds-available');
                $moneyItem.removeClass('has-error');
            }
        });
        
        console.log('Cantidades disponibles actualizadas');
    }
    
    function validateSalidaInput(input) {
        const $input = $(input);
        const value = parseInt($input.val()) || 0;
        const available = parseInt($input.data('available')) || 0;
        const $moneyItem = $input.closest('.money-item');
        
        // Limpiar estados anteriores
        $input.removeClass('exceeds-available');
        $moneyItem.removeClass('has-error');
        $moneyItem.find('.temp-message').remove();
        
        // Validar que no sea negativo
        if (value < 0) {
            $input.val(0);
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            showTemporaryMessage($input, 'No se permiten valores negativos', 'warning');
            return false;
        }
        
        // Validar que no exceda lo disponible
        if (value > available) {
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            
            // Mostrar mensaje temporal más descriptivo
            if (available === 0) {
                showTemporaryMessage($input, 'No hay unidades disponibles de esta denominación', 'exceeds-warning');
                $input.val(0);
            } else {
                showTemporaryMessage($input, `Máximo disponible: ${available} unidades`, 'exceeds-warning');
                $input.val(available);
            }
            return false;
        }
        
        return true;
    }
    
    function validateEntradaInput(input) {
        const $input = $(input);
        const value = parseInt($input.val()) || 0;
        const $moneyItem = $input.closest('.money-item');
        
        // Limpiar estados anteriores
        $input.removeClass('exceeds-available');
        $moneyItem.removeClass('has-error');
        $moneyItem.find('.temp-message').remove();
        
        // Validar que no sea negativo
        if (value < 0) {
            $input.val(0);
            $input.addClass('exceeds-available');
            $moneyItem.addClass('has-error');
            showTemporaryMessage($input, 'No se permiten valores negativos', 'warning');
            return false;
        }
        
        return true;
    }
    
    function showTemporaryMessage(input, message, type) {
        const $input = $(input);
        const $container = $input.closest('.money-item');
        
        // Remover mensaje anterior si existe
        $container.find('.temp-message').remove();
        
        // Determinar la clase del mensaje según el tipo
        let alertClass = 'alert-info';
        let iconClass = 'tim-icons icon-alert-circle-exc';
        
        if (type === 'warning') {
            alertClass = 'alert-warning';
            iconClass = 'tim-icons icon-alert-circle-exc';
        } else if (type === 'exceeds-warning') {
            alertClass = 'exceeds-warning';
            iconClass = 'tim-icons icon-simple-remove';
        }
        
        // Crear mensaje temporal mejorado
        const $message = $(`
            <div class="temp-message alert ${alertClass} mt-2 mb-0" style="font-size: 0.75rem;">
                <i class="${iconClass}"></i>
                ${message}
            </div>
        `);
        
        // Insertar después del input-group
        $input.closest('.input-group').after($message);
        
        // Efecto de entrada
        $message.hide().fadeIn(300);
        
        // Remover después de 4 segundos (más tiempo para mensajes críticos)
        const fadeTime = type === 'exceeds-warning' ? 5000 : 3000;
        setTimeout(() => {
            $message.fadeOut(300, function() {
                $(this).remove();
            });
        }, fadeTime);
    }
</script>
{% endblock extrajs %}
