{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Tablas de Resultados {% endblock title %}

{% block extrastyle %}
<link href="{% static 'assets/css/registro.css' %}" rel="stylesheet" />
{% endblock extrastyle %}

{% block content %}
<div class="content">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="page-header">
                <h2 class="page-title">
                    <i class="tim-icons icon-chart-pie-36 mr-3"></i>
                    Tablas de Resultados por Caja
                </h2>
                <p class="page-subtitle">Análisis detallado de resultados por conceptos y turnos</p>
            </div>
        </div>
    </div>

    <!-- Selector de Caja -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label for="cajaSelect" class="form-label">Seleccionar Caja:</label>
                        <select class="form-control" id="cajaSelect" onchange="loadTablesData()">
                            <option value="">-- Selecciona una caja --</option>
                            {% for caja in cajas %}
                                <option value="{{ caja.id }}" 
                                        data-saldo="{{ caja.saldo }}"
                                        data-nombre="{{ caja.nombre }}"
                                        data-año="{{ caja.año }}">
                                    {{ caja.nombre }} ({{ caja.año }}) - {{ caja.saldo }}€
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-stats">
                <div class="card-body">
                    <div class="row">
                        <div class="col-5 col-md-4">
                            <div class="icon-big text-center icon-warning">
                                <i class="tim-icons icon-wallet-43 text-warning"></i>
                            </div>
                        </div>
                        <div class="col-7 col-md-8">
                            <div class="numbers">
                                <p class="card-category">Saldo Actual</p>
                                <p class="card-title" id="saldoDisplay">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de Tipo de Tabla -->
    <div class="row mb-4" id="tableTypeSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Seleccionar Tipo de Tabla:</label>
                        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                            <label class="btn btn-outline-primary btn-lg active" style="flex: 1;">
                                <input type="radio" name="tableType" value="conceptos" checked onchange="showTable('conceptos')">
                                <i class="tim-icons icon-tag mr-2"></i>
                                Por Conceptos
                            </label>
                            <label class="btn btn-outline-primary btn-lg" style="flex: 1;">
                                <input type="radio" name="tableType" value="turnos" onchange="showTable('turnos')">
                                <i class="tim-icons icon-calendar-60 mr-2"></i>
                                Por Turnos
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Conceptos -->
    <div class="row" id="conceptosTable" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="tim-icons icon-tag mr-2"></i>
                        Resultados por Conceptos
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Tipo</th>
                                    <th class="text-center">Nº Movimientos</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="conceptosTableBody">
                                <!-- Los datos se cargarán aquí -->
                            </tbody>
                            <tfoot id="conceptosTableFooter">
                                <!-- Los totales se cargarán aquí -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Turnos -->
    <div class="row" id="turnosTable" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="tim-icons icon-calendar-60 mr-2"></i>
                        Resultados por Turnos
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Turno</th>
                                    <th class="text-center">Nº Movimientos</th>
                                    <th class="text-right">Total Ingresos</th>
                                    <th class="text-right">Total Gastos</th>
                                    <th class="text-right">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="turnosTableBody">
                                <!-- Los datos se cargarán aquí -->
                            </tbody>
                            <tfoot id="turnosTableFooter">
                                <!-- Los totales se cargarán aquí -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay caja seleccionada -->
    <div id="noCajaMessage" class="text-center py-5">
        <i class="tim-icons icon-chart-pie-36" style="font-size: 4rem; color: #ccc;"></i>
        <h4 class="mt-3 text-muted">Selecciona una caja para ver las tablas de resultados</h4>
        <p class="text-muted">Elige una caja del selector superior para visualizar los análisis por conceptos y turnos</p>
    </div>
</div>
{% endblock content %}

{% block extrajs %}
<script>
    let currentTablesData = null;

    $(document).ready(function() {
        console.log('Página de tablas cargada');
    });

    function loadTablesData() {
        const cajaId = $('#cajaSelect').val();
        
        if (!cajaId) {
            $('#tableTypeSection').hide();
            $('#conceptosTable').hide();
            $('#turnosTable').hide();
            $('#noCajaMessage').show();
            $('#saldoDisplay').text('--');
            return;
        }

        const selectedOption = $('#cajaSelect option:selected');
        const saldo = selectedOption.data('saldo');
        $('#saldoDisplay').text(saldo + '€');
        $('#noCajaMessage').hide();

        // Load data via AJAX
        $.ajax({
            url: '{% url "tables" %}',
            method: 'GET',
            data: {
                'caja_id': cajaId,
                'ajax': 'true'
            },
            success: function(data) {
                if (data.success) {
                    currentTablesData = data;
                    $('#tableTypeSection').show();
                    
                    // Show the currently selected table
                    const activeTable = $('input[name="tableType"]:checked').val();
                    showTable(activeTable);
                } else {
                    alert('Error: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading tables data:', error);
                alert('Error al cargar los datos: ' + error);
            }
        });
    }

    function showTable(tableType) {
        if (!currentTablesData) return;

        // Hide all tables
        $('#conceptosTable').hide();
        $('#turnosTable').hide();

        if (tableType === 'conceptos') {
            showConceptosTable();
        } else if (tableType === 'turnos') {
            showTurnosTable();
        }
    }

    function showConceptosTable() {
        const tbody = $('#conceptosTableBody');
        const tfoot = $('#conceptosTableFooter');
        tbody.empty();
        tfoot.empty();

        if (!currentTablesData.conceptos || currentTablesData.conceptos.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="4" class="text-center text-muted">No hay datos de conceptos para esta caja</td>
                </tr>
            `);
            $('#conceptosTable').show();
            return;
        }

        let totalIngresos = 0;
        let totalGastos = 0;
        let totalMovimientos = 0;

        currentTablesData.conceptos.forEach(function(concepto) {
            const tipoClass = concepto.es_gasto ? 'text-danger' : 'text-success';
            const tipoText = concepto.es_gasto ? 'Gasto' : 'Ingreso';
            const tipoIcon = concepto.es_gasto ? 'tim-icons icon-simple-remove' : 'tim-icons icon-simple-add';
            
            if (concepto.es_gasto) {
                totalGastos += concepto.total;
            } else {
                totalIngresos += concepto.total;
            }
            totalMovimientos += concepto.count;

            const row = `
                <tr>
                    <td>
                        <strong>${concepto.nombre}</strong>
                    </td>
                    <td>
                        <span class="badge ${concepto.es_gasto ? 'badge-danger' : 'badge-success'}">
                            <i class="${tipoIcon}"></i>
                            ${tipoText}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="badge badge-info">${concepto.count}</span>
                    </td>
                    <td class="text-right ${tipoClass}">
                        <strong>${concepto.total.toFixed(2)}€</strong>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        const balance = totalIngresos - totalGastos;
        const balanceClass = balance >= 0 ? 'text-success' : 'text-danger';

        // Add totals footer
        const footerRow = `
            <tr class="table-active" style="border-top: 2px solid #344675;">
                <td><strong>TOTALES</strong></td>
                <td>
                    <span class="badge badge-primary">
                        <i class="tim-icons icon-chart-bar-32"></i>
                        Resumen
                    </span>
                </td>
                <td class="text-center">
                    <strong>${totalMovimientos}</strong>
                </td>
                <td class="text-right">
                    <div class="d-flex flex-column">
                        <div class="text-success mb-1">
                            <small>Ingresos:</small> <strong>+${totalIngresos.toFixed(2)}€</strong>
                        </div>
                        <div class="text-danger mb-1">
                            <small>Gastos:</small> <strong>-${totalGastos.toFixed(2)}€</strong>
                        </div>
                        <div class="${balanceClass}" style="border-top: 1px solid #344675; padding-top: 5px;">
                            <small>Balance:</small> <strong>${balance.toFixed(2)}€</strong>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        tfoot.append(footerRow);

        $('#conceptosTable').show();
    }

    function showTurnosTable() {
        const tbody = $('#turnosTableBody');
        const tfoot = $('#turnosTableFooter');
        tbody.empty();
        tfoot.empty();

        if (!currentTablesData.turnos || currentTablesData.turnos.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="5" class="text-center text-muted">No hay datos de turnos para esta caja</td>
                </tr>
            `);
            $('#turnosTable').show();
            return;
        }

        let totalMovimientos = 0;
        let totalIngresosTurnos = 0;
        let totalGastosTurnos = 0;

        currentTablesData.turnos.forEach(function(turno) {
            const balance = turno.ingresos - turno.gastos;
            const balanceClass = balance >= 0 ? 'text-success' : 'text-danger';
            
            totalMovimientos += turno.count;
            totalIngresosTurnos += turno.ingresos;
            totalGastosTurnos += turno.gastos;

            const row = `
                <tr>
                    <td>
                        <strong>${turno.nombre}</strong>
                    </td>
                    <td class="text-center">
                        <span class="badge badge-info">${turno.count}</span>
                    </td>
                    <td class="text-right text-success">
                        <strong>+${turno.ingresos.toFixed(2)}€</strong>
                    </td>
                    <td class="text-right text-danger">
                        <strong>-${turno.gastos.toFixed(2)}€</strong>
                    </td>
                    <td class="text-right ${balanceClass}">
                        <strong>${balance.toFixed(2)}€</strong>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        const totalBalance = totalIngresosTurnos - totalGastosTurnos;
        const totalBalanceClass = totalBalance >= 0 ? 'text-success' : 'text-danger';

        // Add totals footer
        const footerRow = `
            <tr class="table-active" style="border-top: 2px solid #344675;">
                <td><strong>TOTALES</strong></td>
                <td class="text-center">
                    <strong>${totalMovimientos}</strong>
                </td>
                <td class="text-right text-success">
                    <strong>+${totalIngresosTurnos.toFixed(2)}€</strong>
                </td>
                <td class="text-right text-danger">
                    <strong>-${totalGastosTurnos.toFixed(2)}€</strong>
                </td>
                <td class="text-right ${totalBalanceClass}">
                    <strong>${totalBalance.toFixed(2)}€</strong>
                </td>
            </tr>
        `;
        tfoot.append(footerRow);

        $('#turnosTable').show();
    }
</script>
{% endblock extrajs %}
